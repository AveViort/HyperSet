<!DOCTYPE html>
<HTML lang="en-US">
<HEAD>

<TITLE>Drug screen data - dev version</TITLE>
<LINK href="pics/favicon.ico" rel="shortcut icon">
<meta http-equiv="content-type" content="charset=utf-8">
<META http-equiv="Content-Script-Type" content="application/javascript" >
<LINK href="hyperset.css" type="text/css" rel="stylesheet">
<LINK href="js/jquery-ui-themes-1.12.1/themes/redmond/jquery-ui.min.css" type="text/css" rel="stylesheet">
<LINK href="js/qTip/jquery.qtip.min.css" type="text/css" rel="stylesheet">
<link href="js/Cytoscape.js/cytoscape-cytoscape.js-panzoom-c1dbe79/cytoscape.js-panzoom.css" rel="stylesheet" type="text/css" />
<link href="js/Cytoscape.js/cytoscape-cytoscape.js-panzoom-c1dbe79/font-awesome-4.0.3/css/font-awesome.css" rel="stylesheet" type="text/css" />
<link href="//cdn.datatables.net/1.10.4/css/jquery.dataTables.min.css" rel="stylesheet" type="text/css">
<link href="//cdn.datatables.net/tabletools/2.2.3/css/dataTables.tableTools.css" rel="stylesheet" type="text/css">
<link href="//cdn.datatables.net/plug-ins/3cfcc339e89/integration/jqueryui/dataTables.jqueryui.css" type="text/css">
<link href="//cdn.datatables.net/responsive/1.0.4/css/dataTables.responsive.css" type="text/css">
<script src="js/jquery-3.3.1.min.js" type="text/javascript"></script>
<script src="js/jquery-ui-1.12.1.custom/jquery-ui.min.js" type="text/javascript"></script>
<script src="js/jquery-ui-contextmenu-master/jquery.ui-contextmenu.min.js" type="text/javascript"></script>  
<script src="js/jquery.form.js" type="text/javascript"></script>  
<script src="js/Cytoscape.js/cytoscape.min.js" type="text/javascript"></script>  
<!--script src="js/cytoscape.js-cxtmenu-master/cytoscape-cxtmenu.js" type="text/javascript"></script-->
<script src="js/cytoscape.js-cxtmenu-master/cytoscape-cxtmenu.js" type="text/javascript"></script>
<script src="js/Cytoscape.js/cytoscape-cytoscape.js-panzoom-c1dbe79/cytoscape.js-panzoom.js" type="text/javascript"></script>
<script src="js/overlib.js" type="text/javascript"></script>
<script src="//cdn.datatables.net/1.10.4/js/jquery.dataTables.min.js" type="text/javascript"></script>
<script src="//cdn.datatables.net/tabletools/2.2.3/js/dataTables.tableTools.js" type="text/javascript"></script>
<script src="//cdn.datatables.net/responsive/1.0.4/js/dataTables.responsive.js" type="text/javascript"></script>
<script src="js/qTip/jquery.qtip.min.js" type="text/javascript"></script>

<script src="js/Cytoscape.js/cytoscape.js-qtip-master/jquery.cytoscape.js-qtip.js" type="text/javascript"></script>
<script src="js/Cytoscape.js/cytoscape.js-edgehandles.js" type="text/javascript"></script>

<script src="js/HS.js" type="text/javascript" charset="utf-8"></script>
<script src="js/drugs.js" type="text/javascript"></script>

<!--script src="js/HS.js" type="text/javascript" charset="utf-8"></script-->

<style>
li.tab ul {
  display: none;
  margin: 0;
  padding: 0;
  list-style: none;
  border: 1px solid #d5d5d5;
  border-radius: 0 0 3px 3px;
}

li.tab:hover ul li {
  color: #454545;
  margin: 0;
  background-color: #e9e9e9;
  padding: 4px 10px;
  cursor: pointer;
  border-bottom: 1px solid #d5d5d5;
}

li.tab:hover ul li:hover,
li.tab:hover ul li.active {
  background-color: #ffffff;
}

li.tab:hover ul {
  display: block;
  position: absolute;
  top: 100%;
  left: 0;
}

.ui-menu { width: 150px; }

.ui-dialog {
    padding: 0;
    margin: 0;
}
.ui-dialog .ui-dialog-content {
    padding: 0;
    margin: 0;
    overflow: hidden;
}
</style>
</HEAD>

<BODY class="ui-state-default ui-corner-all">
<div id="progressbar"></div>
<div id="tabs">
	<ul>
		<li><a href="#tab-home">Home</a></li>
		<li><a href="#tab-signif">Significant results</a></li>
		<li><a href="#tab-lookup">Look up</a></li>
		<li class="tab"><a href="#tab-plot">Plots</a>
			<ul class="tabsubmenu">
				<li onclick = plot("2D")>2D</li>
				<li onclick = plot("3D")>3D</li>
				<li onclick = plot("Box")>Box</li>
			</ul>
		</li>
	</ul>
	<div id="tab-home">This is a home tab</div>
	<div id="tab-signif">
		<table id="select_layout"><tr>
		<td id="selectFeature">
		<select name="screenList" id="screenList" class="ui-helper" style="width: 40ch;" >
		</td>
		<td id="selectCompound>">
		<!--ul name="compoundsList" id="compoundsList"></ul-->
		<select name="compoundsList" id="compoundsList" class="ui-helper" style="width: 40ch;" >
		</td>
		<td>
		<select name="featuresList" id="featuresList" class="ui-helper" style="width: 40ch;" >
		</td>
		<td>
		<button type="submit" id="retrieve-cor-button" name="retrieve-cor-button" onclick = retrieve_correlations() style="width: 150; visibility: visible;">Retrieve correlations</button>
		</td>
		</table>
	</div>
	<div id="tab-lookup"><br>
	<img id="plot_view">
	<br>
	<table>
		<tr>
		<td>
		<select id="source_selector" class="ui-helper" style="width: 40ch;">
		</td>
		<td>
		<select id="cohort_selector" class="ui-helper" style="width: 40ch;">
		</td>
		</tr>
	</table>
	<br>
	<table id = "plot_options">
		<tr>
		<td>
		<select id="type1_selector" class="ui-helper" style="width: 40ch;">
		</td>
		<td>
		<select id="platform1_selector" class="ui-helper" style="width: 40ch;">
		</td>
		<td>
		<input id="id1_input" onkeyup="id_keyup(1)" onchange = "id_keyup(1)">
		</td>
		<td>
		<select id="axis1_selector" class="ui-helper" style="width: 40ch;">
		</td>
		<td>
		<button id="add_row1" max=2 onclick="add_plot_options_row(1)">+</button>
		</td>
		<td>
		<button id="delete_row1" onclick="delete_plot_options_row(1)">-</button>
		</td>
		</tr>
	</table>
	<br>
	<table>
	<tr>
	<td>
	<select id="plot-type">
	</td>
	<td>
	<button id="plot-button" onclick="plot()">Plot</button>
	</td>
	</tr>
	</table>
	</div>
	<div id="tab-plot">This tab shows the most recent plot or (if none) - instruction</div>
</div>

<div id="ssOpener" style="width: 14%; text-align: left;  cursor: pointer;" title="How the four screens measured drug activity?">
	<b>Drug response scales
	<div style="width: 7%; text-align: left;" id="help-0" class="js_ui_help">[?]</div></b>
</div>    
<div id="showScales" >
	<div id="ssAcc"> 
		<h3>ACT</h3>
			<div>
				<p>
				The units stand for 1:300 dilution steps, so that '6' corresponds to the highest dilution.
				Sensitivity to compounds is expressed as IC50 value, so that: 
				<ul><li>
					0 means 'insensitive to compound' and 
				</li><li>
					6 means 'fully sensitive to compound' 
				</li></ul>
				</p>
			</div>
		<h3>CCLE (Barretina et al., 2012), 24 drugs</h3>
			<div>
				<p>
				These authors considered a range of metrics for their analysis, but finally preferred s.c. 'normalized activity areas'. These original units were calculated as areas under compound response curves where higher values corresponded to higher sensitivity so that 0 stood for 'insensitive to compound' and 8 stood for 'full sensitivity'.<br>
				Further, the activity area values were normalized for unequal luminiscence in the assay, and we rendered them normally distributed by log-transformation. Hence finally the values range from 
				<ul><li>
					-3: 'insensitive to compound' to 
				</li><li>
					+2.31: 'maximal sensitivity'
				</li></ul>
				</p>
			</div>
		<h3>CTD2 (Basu et al., 2013), 354 drugs <font  color="red"> <b>(NOTE: INVERTED SCALE!)</b></font ></h3>
			<div>
				<p>
				The authors mainly used area under curve (AUC) for the quantitative analyses - so did we, too.
				In completely insensitive cases the full area under 8 experimental points reached 8, whereas 0 stood for  full sensitivity. Thus, the scale of this screen <b>is INVERTED compared to the three other screens!</b> We did not transform the values further.
				<ul><li>
					0: 'maximal sensitivity', whereas
				</li><li>
					8 or (sometimes) higher: 'insensitive to compound' 
				</li></ul>
				</p>
			</div>
		<h3>CGP (Garnett et al., 2012), 138 drugs</h3>
			<div>
				<p>
				Since these authors used a combination of IC50 and the slope parameter to achieve the most complete description of responses, we decided to use the area under curve (AUC) as a single feature that reflects the both above values. AUC was originally provided in the same table and ranged from 0% (fully sensitive) to 100% (insensitive). To approach the normal distribution, we transformed the values as log(1 - AUC), so that now they range from 
				<ul><li>
					-8.11: 'insensitive to compound' to 
				</li><li>
					0: 'maximal sensitivity'
				</li></ul>
				</p>
			</div>
	</div>
</div>

<div id="dock" spot=0></div>
		
<P style="width:34%;"><a href="https://www.evinet.org/">EviNet.org main site</a></P>
<P style="width:34%;"><a href="http://funcoup2.sbc.su.se/index.TEST01.html">FunCoup v.1-LE (requires Java)</a></P>
<P style="width:34%;"><a href="http://funcoup.sbc.su.se/search/">FunCoup v.4.0 </a></P>

<P style="width:33%;text-align:right;">Found problems? <A href="mailto:andrej.alekseenko@scilifelab.se">Send us email</A></P>

<script>
var loadingIndicator = 'ui-icon-loading-status-balls';
var loadingClasses = 'ui-icon ' + loadingIndicator + ' rotate';

$(document).ready(function(){
	$(function() {
		$( "#showScales" ).dialog({
			resizable: false,
			modal: false,
			title: "Drug sensitivity scales", 
			width:  600,
			height: "auto",
			autoOpen: false,
			show: {
				effect: "blind",
				duration: 280
			},
			hide: {
				effect: "explode",
				duration: 600
			},
			buttons: {"Close": 
				function () {
					$(this).dialog("close");
				}
			}
		});
		$( "#ssOpener" ).click(function() {
			$( "#showScales" ).dialog( "open" );
			$( "#ssAcc" ).accordion();
		});
	});
	urlfixtabs("#tabs");
	$("#progressbar").progressbar({
		value: false
	});
	$("#progressbar").css({"visibility": "hidden"});
	$("#tabs").tabs({});
	// hide "Plots" tab by default
	$($("#tabs").find("li")[3]).hide()
	
	var screens = drug_sources();
	var options = [];
	options.push("<option value='all'>All screens</option>");
	for (i in screens) {
		options.push("<option value='" + screens[i].code + "'>" + screens[i].name +"</option>");
	}
	$("#screenList").append(options.join("")).selectmenu();
	
	var drugs = drug_list();
	//$("#compoundsList").menu();
	//for (i in drugs) {
	//	 $("<li><a href='#'>"+drugs[i].source+"</a></li>").appendTo("#compoundsList");
	//	 console.log(drugs[i].source);
    //  $("#compoundsList").menu("refresh");
	//}
	options = [];
	$("#compoundsList").append("<option value='all'>All compounds</option>").selectmenu();
	for (i in drugs) {
		for (j in drugs[i].drugs) {
			options.push("<option value='" + drugs[i].drugs[j] + "'>"+ drugs[i].drugs[j] +"</option>")
		}
		$("#compoundsList").append('<optgroup label="' + drugs[i].source + '">' + options.join("") + '</optgroup>').selectmenu();
	}
	
	var features = feature_list();
	options = [];
	$("#featuresList").append("<option value='all'>All features</option>").selectmenu();
	for (i in features) {
		for (j in features[i].codes) {
			options.push("<option value='"+ features[i].codes[j] + "'>" + features[i].names[j] + "</option>");
		}
		$("#featuresList").append('<optgroup label="'+ features[i].feature + '">' + options.join("") + '</optgroup>').selectmenu();
	}	
		
	$("#submit-populate").button();
	var sources = get_plot_sources();
	options = [];
	for (i in sources) {
		options.push("<option value='"+ sources[i] + "'>" + sources[i] + "</option>");
	}
	$("#source_selector").append(options.join("")).selectmenu();
	$('#source_selector').on( "selectmenuchange", function( event, ui ) {update_source()} );
	init_cohortselector();
	$("#plot-button").button();
	$("#plot-button").button("disable");
	$("#dock").accordion({
      collapsible: true
    });
});

function plot() {
	var type = $('#plot-type option:selected').val();
	var n = $('#plot_options tr').length;
	var source = $("#source_selector option:selected").val();
	var cohort = $("#cohort_selector option:selected").val();
	var datatypes = [];
	var ids = [];
	var platforms = [];
	var scales = [];
	// this is temp!
	var tcga_codes = ["all", "all"];
	for (i=1; i<=n; i++) {
		datatypes.push($("#type" + i + "_selector option:selected").val());
		platforms.push($("#platform" + i + "_selector option:selected").val());
		ids.push($("#id" + i + "_input").val());
		scales.push($("#axis" + i + "_selector option:selected").val());
	}
	var plot_description = "type:" + type + "|cohort:" + cohort + "|datatypes:" + datatypes + "|platforms:" + platforms + "|ids:" + ids + "|scales:" + scales;
	var plot_filename = find_plot_in_history(plot_description);
	var plot_id;
	var plot_title = generate_plot_title(type, cohort, datatypes, platforms, ids, scales);
	// new plot
	if (plot_filename == "no") {
		$("#progressbar").css({"visibility": "visible"});
		plot_filename = rplot(type, source, cohort, datatypes, platforms, ids, tcga_codes, scales);
		plot_id = plot_filename.substring(0, plot_filename.length-4);
		// save plot in session history
		sessionStorage.setItem(plot_filename, plot_description);
		//var graph_window = '<div id="plot_window_' + plot_id +'"><img src="https://www.evinet.org/pics/plots/' + plot_filename + '" width="100%" height="auto"></div>';
		//var graph_window = '<div id="plot_window_' + plot_id +'"><img src="https://www.evinet.org/pics/plots/' + plot_filename + '" width="480" height="480"></div>';
		var graph_window = '<div id="plot_window_' + plot_id +'"><iframe src="https://www.evinet.org/pics/plots/' + plot_filename + '" width="1280" height="800"></div>';
		$(graph_window).dialog({
			title: plot_title,
			buttons: [
				{
					text: "Minimize",
					icon: "ui-icon-minus",
					click: function() {plot_minimize(this)},
				},
				{
					text: "Dock",
					icon: "ui-icon-arrowthickstop-1-s",
					click: function() {
						// can't use graph_window, since we need to specify height and width
						dock_plot(this, '<div id="plot_window_' + plot_id +'"><iframe src="https://www.evinet.org/pics/plots/' + plot_filename + '" height=240 width=240></div>');
						$( this ).dialog( "close" );
					},
					showText: false
				}
			],
			height: 'auto',
			width: 'auto',
			modal: false,
			resize: function( event, ui ) {
					//if (ui.size.width-ui.originalSize.width > ui.size.height-ui.originalSize.height) {
					//	$(this).height($(this).width());
					//}
					//else {
					//	$(this).width($(this).height())
					//}
					//$(this).dialog( "refresh" );
					($(this).children('iframe'))[0].setAttribute("height", $(this).height());
					($(this).children('iframe'))[0].setAttribute("width", $(this).width());
				},
			beforeClose: function( event, ui ) {$(this).dialog('destroy').remove()}
		});
		$("#progressbar").css({"visibility": "hidden"});
	}
	// existing plot
	else {
		console.log("No need to do it again!");
		plot_id = plot_filename.substring(0, plot_filename.length-4);
		if (document.getElementById("plot_window_" + plot_id)) {
			console.log("We already have a window: move it to the top!");
			$("#plot_window_" + plot_id + ".ui-dialog-content.ui-widget-content").dialog("moveToTop");
		}
		else {
			console.log("Plot was closed");
			var graph_window = '<div id="plot_window_' + plot_id +'"><iframe src="https://www.evinet.org/pics/plots/' + plot_filename + '" width="1280" height="800"></div>';
			//var graph_window = '<div id="plot_window_' + plot_id +'"><img src="https://www.evinet.org/pics/plots/' + plot_filename + '" width="100%" height="auto"></div>';
			$(graph_window).dialog({
				title: plot_title, 
				buttons: [
					{
						text: "Minimize",
						icon: "ui-icon-minus",
						click: function() {plot_minimize(this)}
					},
					{
						text: "Dock",
						icon: "ui-icon-arrowthickstop-1-s",
						click: function() {
							dock_plot(this, '<div id="plot_window_' + plot_id +'"><iframe src="https://www.evinet.org/pics/plots/' + plot_filename + '" height=240 width=240></div>');
							$( this ).dialog( "close" );
						}
					}
				],
				height: 'auto',
				width: 'auto',
				modal: false,
				//resizable: false,
				resize: function( event, ui ) {
					($(this).children('iframe'))[0].setAttribute("height", $(this).height());
					($(this).children('iframe'))[0].setAttribute("width", $(this).width());
				},
				beforeClose: function( event, ui ) {$(this).dialog('destroy').remove()}
			});
			/*.resizable({
				aspectRatio: true,
				minWidth: 100,
				resize: function (evt, ui) {
					ui.element.parent().css({width:'',height:''});
        }
    });*/
		}
	}
	//document.getElementById("plot_view").setAttribute("src", "https://www.evinet.org/pics/plots/"+plot_filename);
}

function retrieve_correlations() {
	var screen = $("#screenList option:selected").val();
	var compound = $("#compoundsList option:selected").val();
	var feature = $("#featuresList option:selected").val();
	console.log(screen + " " + compound + " " + feature);
	retreive_drug_correlations(screen, compound, feature);
}

function add_plot_options_row(i) {
	// current number of rows
	var n = $('#plot_options tr').length;
	for (j=i+1; j<=n; j++) {
		$('#type' + j + '_selector').on( "selectmenuchange", function( event, ui ) {update_type(j+1)} );
		$('#platform' + j + '_selector').on( "selectmenuchange", function( event, ui ) {update_platform(j+1)} );
		document.getElementById('type' + j +'_selector').setAttribute("id", 'type' + (j+1) +'_selector');
		document.getElementById('platform' + j +'_selector').setAttribute("id", 'platform' + (j+1) +'_selector');
		document.getElementById('id' + j +'_input').setAttribute("onkeyup", 'id_keyup(' + (j+1) +')');
		document.getElementById('id' + j +'_input').setAttribute("onchange", 'id_keyup(' + (j+1) +')');
		document.getElementById('id' + j +'_input').setAttribute("id", 'id' + (j+1) +'_input');
		document.getElementById('axis' + j +'_selector').setAttribute("id", 'axis' + (j+1) +'_selector');
		document.getElementById('add_row' + j).setAttribute("id", 'add_row' + (j+1));
		document.getElementById('add_row' + (j+1)).setAttribute("onclick", 'add_plot_options_row(' + (j+1) + ')');
		document.getElementById('delete_row' + j).setAttribute("id", 'delete_row' + (j+1));
		document.getElementById('delete_row' + (j+1)).setAttribute("onclick", 'delete_plot_options_row(' + (j+1) + ')');
	}
	
	sessionStorage.setItem("updates_triggered", 0);
	sessionStorage.setItem("add_row", 1);
	
	var table = document.getElementById("plot_options");
	var row = table.insertRow(i);
	var TypeSelectorCell = row.insertCell(0);
	TypeSelectorCell.innerHTML = '<select id="type' + (i+1) +'_selector" class="ui-helper" style="width: 40ch;">';
	var for_delete = false;
	var flag = init_dataselector('type'+(i+1)+'_selector');
	if (flag) {
		alert('No more compatible datatypes!');
		for_delete = true;
	}
	var PlatformSelectorCell = row.insertCell(1);
	PlatformSelectorCell.innerHTML = '<select id="platform' + (i+1) +'_selector" class="ui-helper" style="width: 40ch;">';
	var IdInput = row.insertCell(2);
	IdInput.innerHTML = '<input id="id'+ (i+1) + '_input" onkeyup="id_keyup(' + (i+1) + ')" onchange="id_keyup(' + (i+1) + ')">';
	flag = init_platformselector('platform'+(i+1)+'_selector');
	if (flag & !for_delete) {
		alert('No more compatible platforms!');
		for_delete = true;
	}
	var AxisSelector = row.insertCell(3);
	AxisSelector.innerHTML = '<select id="axis' + (i+1) +'_selector" class="ui-helper" style="width: 40ch;">';
	init_axis_type_selector('axis' + (i+1) + '_selector');
	var AddButton = row.insertCell(4);
	AddButton.innerHTML = '<button id="add_row' + (i+1) + '" max=3 onclick="add_plot_options_row(' + (i+1) + ')">+</button>';
	var DeleteButton = row.insertCell(5);
	DeleteButton.innerHTML = '<button id="delete_row' + (i+1) + '" max=3 onclick="delete_plot_options_row(' + (i+1) + ')">-</button>';
	update_plot_types();
	$("#add_row" + (i+1)).button();
	$("#delete_row" + (i+1)).button();
	if (n+1 >= document.getElementById("add_row" + i).getAttribute("max")) {
		for (j=1; j<=n+1; j++) {
			$("#add_row" + j).button("disable");
		}
	}
	for (j=1; j<=n; j++) {
			$("#delete_row" + j).button("enable");
		}
	$("#source_selector").selectmenu("disable");
	$("#cohort_selector").selectmenu("disable");
	var id_input_enabled = ($("#id" + (i+1) + "_input").is(":enabled"));
	if (id_input_enabled) {
		$("#plot-button").button("disable"); 
	}
	if (for_delete) {
		delete_plot_options_row(i+1);
	}
	sessionStorage.removeItem("add_row");
	id_keyup(i+1);
}

function delete_plot_options_row(i) {
	var n = $('#plot_options tr').length;
	for (j=i+1; j<=n; j++) {
		$('#type' + j + '_selector').on( "selectmenuchange", function( event, ui ) {update_type(j-1)} );
		$('#platform' + j + '_selector').on( "selectmenuchange", function( event, ui ) {update_platform(j-1)} );
		document.getElementById('type' + j +'_selector').setAttribute("id", 'type' + (j-1) +'_selector');
		document.getElementById('platform' + j +'_selector').setAttribute("id", 'platform' + (j-1) +'_selector');
		document.getElementById('id' + j +'_input').setAttribute("onkeyup", 'id_keyup(' + (j-1) +')');
		document.getElementById('id' + j +'_input').setAttribute("onchange", 'id_keyup(' + (j-1) +')');
		document.getElementById('id' + j +'_input').setAttribute("id", 'id' + (j-1) +'_input');
		document.getElementById('axis' + j +'_selector').setAttribute("id", 'axis' + (j-1) +'_selector');
		document.getElementById('add_row' + j).setAttribute("onclick", 'add_plot_options_row(' + (j-1) + ')');
		document.getElementById('add_row' + j).setAttribute("id", 'add_row' + (j-1));
		document.getElementById('delete_row' + j).setAttribute("onclick", 'delete_plot_options_row(' + (j-1) + ')');
		document.getElementById('delete_row' + j).setAttribute("id", 'delete_row' + (j-1));
	}	
	document.getElementById("plot_options").deleteRow(i-1);
	for (j=1; j<n; j++) {
		$("#add_row" + j).button("enable");
	}
	if (n-1 == 1) {
		$("#delete_row1").button("disable");
		$("#source_selector").selectmenu("enable");
		$("#cohort_selector").selectmenu("enable");
	}
	if (i == 1) {
		$('#type1_selector').find('option').remove().end();
		$('#type1_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
		init_dataselector('type1_selector');
		$('#type1_selector').selectmenu( "refresh" );
		//$('#platform1_selector').find('option').remove().end();
		//$('#platform1_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
		//init_platformselector('platform1_selector');
		//$('#platform1_selector').selectmenu( "refresh" );
	}
	if (sessionStorage.getItem("cascade_delete") == null) {
		update_plot_types();
		if (i <n) {
			update_type(i);
		}
	}
	// artificially trigger change event for all available inputs
	// so if the deleted row was the reason why plot-button was disabled - the button would become enabled
	id_keyup(i-1);
}

function init_cohortselector() {
	sessionStorage.setItem("updates_triggered", 0);
	var cohorts = get_plot_cohorts($("#source_selector option:selected").val());
	options = [];
	for (i in cohorts) {
		options.push("<option value='"+ cohorts[i] + "'>" + cohorts[i] + "</option>");
	}
	$("#cohort_selector").append(options.join("")).selectmenu();
	$('#cohort_selector').on( "selectmenuchange", function( event, ui ) {update_cohort()} );
	$('#cohort_selector').selectmenu( "refresh" );
	sessionStorage.setItem("add_row", 1);
	init_dataselector("type1_selector");
	init_platformselector("platform1_selector");
	init_axis_type_selector("axis1_selector");
	init_plot_type_selector();
	$("#add_row1").button();
	$("#delete_row1").button();
	$("#delete_row1").button("disable");
	sessionStorage.removeItem("add_row");
}

function init_dataselector(selector_id) {
	var total = $('#plot_options tr').length;
	var n = parseInt(selector_id.substr(4, selector_id.indexOf("_")-4));
	var previous_datatypes = [];
	for (j=1; j<n; j++) {
		console.log(j);
		previous_datatypes.push($("#type" + j +"_selector option:selected").val());
	}
	var datatypes = get_cohort_datatypes($("#cohort_selector option:selected").val(), previous_datatypes);
	var empty = (datatypes.length == 0);
	if (!empty) {
		options = [];
		for (i in datatypes) {
			options.push("<option value='"+ datatypes[i] + "'>" + datatypes[i] + "</option>");
		}
		$("#" + selector_id).append(options.join("")).selectmenu();
		var previous_selection = sessionStorage.getItem(selector_id);
		if (datatypes.includes(previous_selection)) {
			$("#" + selector_id).val(previous_selection);
			$("#" + selector_id).selectmenu( "refresh" );
		}
		else {
			if (previous_selection != null) {
				alert("Data row " + n + ": unable to set up datatype " + previous_selection + " due to incompatibility with previous rows");
			}
		}
		sessionStorage.removeItem(selector_id);
		var k = parseInt(sessionStorage.getItem("updates_triggered"));
		if (k == 0) {
			$("#" + selector_id).on( "selectmenuchange", function( event, ui ) {console.log("dataselector " + selector_id + " selectmenuchange");update_type(n)} );
		}
		if (!(datatypes.includes(previous_selection))) {
			update_type(n);
		}
	}
	else {
		for (i = total; i>n; i--) {
			delete_plot_options_row(i);
		}
	}
	return empty;
}

function init_platformselector(selector_id) {
	var total = $('#plot_options tr').length;
	var n = parseInt(selector_id.substr(8, selector_id.indexOf("_")-8));
	var previous_platforms = [];
	console.log(n);
	for (j=1; j<n; j++) {
		console.log(j);
		previous_platforms.push($("#platform" + j +"_selector option:selected").val());
	}
	console.log('previous platforms: ' + previous_platforms);
	console.log($("#cohort_selector option:selected").val() + ' ' + $("#type" + n + "_selector option:selected").val() + ' ' + previous_platforms);
	var platforms = get_platforms($("#cohort_selector option:selected").val(), $("#type" + n + "_selector option:selected").val(), previous_platforms);
	console.log(platforms);
	var empty = (platforms.length == 1);
	console.log(empty);
	if (!empty) {
		// check if we have ids or no for the chosen datatype;
		var flag = parseInt(platforms.shift());
		document.getElementById("id" + n + "_input").disabled = !(flag);
		document.getElementById("id" + n + "_input").hidden = !(flag);
		options = [];
		for (i in platforms) {
			for (j in platforms[i]) {
				options.push("<option value='"+ platforms[i][j].platform + "'>" + platforms[i][j].name + "</option>");
			}
		}
		$("#" + selector_id).append(options.join("")).selectmenu();
		var temp_array = sessionStorage.getItem(selector_id);
		if (temp_array != null) {
			var previous_type = temp_array[0];
			var previous_selection = temp_array[1];
			if (platforms.includes(previous_selection)) {
				$("#" + selector_id).val(previous_selection);
				$("#" + selector_id).selectmenu( "refresh" );
			}
			else {
				if ((previous_selection != null) & (previous_type == $("#type" + n + "_selector option:selected").val())) {
					alert("Data row " + n + ": unable to set up platform " + previous_selection + " due to incompatibility with previous rows");
				}
			}
			sessionStorage.removeItem(selector_id);
		}
		autocomplete_ids = get_autocomplete_ids ($("#cohort_selector option:selected").val(), $("#platform" + n + "_selector option:selected").val());
		$("#id" + n + "_input").autocomplete({
			source: autocomplete_ids,
			minLength: (Math.log10(autocomplete_ids.length) > 2) ? 3 : 2
		});
		var k = parseInt(sessionStorage.getItem("updates_triggered"));
		if (k == 0) {
			$("#" + selector_id).on( "selectmenuchange", function( event, ui ) {console.log("platformselector selectmenuchange");update_platform(selector_id.substr(8, selector_id.indexOf("_")-8))} );
		}
		sessionStorage.setItem("updates_triggered", k+1);
		console.log("updates triggered: " + (k+1));
		console.log("Update triggered by init_platformselector(" + selector_id + ")");
		if (!(platforms.includes(previous_selection))) {
			update_platform(n);
		}
	}
	return empty;
}

function init_axis_type_selector(selector_id) {
	var n = selector_id.substr(4, selector_id.indexOf("_")-4);
	//var flag = document.getElementById("id" + n + "_input").disabled;
	//if (!flag) {
		var axis_types = get_axis_types($("#cohort_selector option:selected").val(), $("#type" + n + "_selector option:selected").val(), $("#platform" + n + "_selector option:selected").val());
		options = [];
		for (i in axis_types) {
			options.push("<option value='"+ axis_types[i] + "'>" + axis_types[i] + "</option>");
		}
		var flag = (axis_types.length == 0);
		$("#" + selector_id).append(options.join("")).selectmenu();
	//}
	$("#" + selector_id).selectmenu({
		disabled: flag
	});
}

function init_plot_type_selector() {
	console.log('init_plot_type_selector() invoked');
	var platforms = [];
	var n = $('#plot_options tr').length;
	for (i=1; i<=n; i++) {
		platforms.push($("#platform" + i + "_selector option:selected").val());
	}
	options = [];
	var plot_types = get_plot_types(platforms);
	for (i in plot_types) {
		options.push("<option value='"+ plot_types[i] + "'>" + plot_types[i] + "</option>");
	}
	$('#plot-type').append(options.join("")).selectmenu();
}

function update_source() {
	$('#cohort_selector').find('option').remove().end();
	$('#cohort_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_cohortselector();
	update_cohort();
}

function update_cohort() {
	console.log('update_cohort() invoked');
	$('#type1_selector').find('option').remove().end();
	$('#type1_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	sessionStorage.setItem("add_row", 1);
	$('#type1_selector').find('option').remove().end();
	$('#type1_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_dataselector('type1_selector');
	$('#type1_selector').selectmenu( "refresh" );
	$('#platform1_selector').find('option').remove().end();
	$('#platform1_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_platformselector('platform1_selector');
	$('#platform1_selector').selectmenu( "refresh" );
	sessionStorage.removeItem("add_row");
}

function update_type(n) {
	if (sessionStorage.getItem("add_row") == null) {
		console.log('update_type(' + n + ') invoked');
		//sessionStorage.setItem("type" + n + "_changed", 1);
		n = parseInt(n);
		sessionStorage.setItem("platform" + n + "_selector", [$("#type" + n + "_selector option:selected").val(), $("#platform" + n + "_selector option:selected").val()]);
		$('#platform'+ n + '_selector').find('option').remove().end();
		$('#platform'+ n + '_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
		var empty = init_platformselector('platform' + n + '_selector');
		$('#platform'+ n + '_selector').selectmenu( "refresh" );
		var total = $('#plot_options tr').length;
		if (empty) {
			alert("No more compatible platforms");
			sessionStorage.setItem("cascade_delete", 1);
			for (i=total; i>=n; i--) {
				console.log("Cascade delete invoked. Removing row " + i + " (removing from " + total + " till " + n + ")");
				delete_plot_options_row(i);
			}
			sessionStorage.removeItem("cascade_delete");
		}
		else {
			if (n<total) {
				sessionStorage.setItem("type" + (n+1) + "_selector", $("#type" + (n+1) + "_selector option:selected").val());
				$('#type'+ (n+1) + '_selector').find('option').remove().end();
				$('#type'+ (n+1) + '_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
				var flag = init_dataselector('type' + (n+1) + '_selector');
				$('#type' + (n+1) + '_selector').selectmenu( "refresh" );
				if (flag) {
					alert("No more compatible datatypes");
					sessionStorage.setItem("cascade_delete", 1);
					for (i=total; i>n; i--) {
						delete_plot_options_row(i);
					}
					sessionStorage.removeItem("cascade_delete");
				}
			}
		}
		update_plot_types();
	}
}

function update_platform(n) {
	if (sessionStorage.getItem("add_row") == null) {
		n = parseInt(n);
		$("#id" + n + "_input").val("");
		var k = parseInt(sessionStorage.getItem("updates_triggered"));
		sessionStorage.setItem("updates_triggered", k+1);
		console.log("updates triggered: " + (k+1));
		console.log("Update triggered by update_platform(" + n + ")");
		$("#id" + n + "_input").autocomplete({
			source: get_autocomplete_ids ($("#cohort_selector option:selected").val(), $("#platform" + n + "_selector option:selected").val()),
			minLength: (Math.log10(autocomplete_ids.length) > 2) ? 3 : 2
		});
		$('#axis'+ n + '_selector').find('option').remove().end();
		$('#axis'+ n + '_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
		init_axis_type_selector('axis'+ n + '_selector');
		$('#axis'+ n + '_selector').selectmenu( "refresh" );
		var total = $('#plot_options tr').length;
		if (n<total) {
			$('#platform' + (n+1) + '_selector').find('option').remove().end();
			$('#platform' + (n+1) + '_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
			sessionStorage.setItem("platform" + (n+1) + "_selector", $("#platform" + (n+1) + "_selector option:selected").val());
			var flag = init_platformselector('platform' + (n+1) + '_selector');
			if (flag) {
				alert("No more compatible platforms");
				sessionStorage.setItem("cascade_delete", 1);
				for (i=total; i>n; i--) {
					delete_plot_options_row(i);
				}
				sessionStorage.removeItem("cascade_delete");
			}
			$('#platform' + (n+1) + '_selector').selectmenu( "refresh" );
		}
		update_plot_types();
		id_keyup(n);
	}
}

function update_plot_types() {
	$('#plot-type').find('option').remove().end();
	$('#plot-type').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_plot_type_selector()
	$('#plot-type').selectmenu( "refresh" );
}

function history() {
	var keys = Object.keys(sessionStorage);
	for (key in keys) {
		if (keys[i].includes("tmp")) {
			console.log(keys[key] + " : " + sessionStorage.getItem(keys[key]));
		}
	}
}

function find_plot_in_history(plot_description) {
	var keys = Object.keys(sessionStorage);
	var res = "no";
	for (i in keys) {
		if (keys[i].includes("tmp")) {
			if (sessionStorage.getItem(keys[i]) == plot_description) {
				res = keys[i];
			}
		}
	}
	return res;
}

function plot_minimize(graph_window) {
	$(graph_window).dialog({"height": $( ".ui-dialog > .ui-dialog-titlebar" )[1].clientHeight});
	$(graph_window).dialog( "option", "buttons", 
		[
			{
			text: "Maximize",
			icon: "ui-icon-arrow-4-diag",
			click: function() {plot_maximize(graph_window)},
			},
			{	
			text: "Dock",
			icon: "ui-icon-arrowthickstop-1-s",
			click: function() {
				// we cannot use just graph_window variable, or we'll get a strange result after minimize-dock
				dock_plot(this, '<div id="' + graph_window.getAttribute("id") + '">' + graph_window.innerHTML + '</div>');
				$( this ).dialog( "close" );
			}
			}
		]
	);
}

function plot_maximize(graph_window) {
	$(graph_window).dialog({
		modal: false,
		resize: function( event, ui ) {
					($(this).children('iframe'))[0].setAttribute("height", $(this).height());
					($(this).children('iframe'))[0].setAttribute("width", $(this).width());
				},
		beforeClose: function( event, ui ) {$(this).dialog('destroy').remove()}});
	$(graph_window).dialog({"height": 800});
	$(graph_window).dialog({"width": 1280});
	$(graph_window).dialog( "option", "buttons",
		[
			{
			text: "Minimize",
			icon: "ui-icon-minus",
			click: function() {plot_minimize(graph_window)},
			},
			{
			text: "Dock",
			icon: "ui-icon-arrowthickstop-1-s",
			click: function() {
				dock_plot(this, '<div id="' + graph_window.getAttribute("id") + '">' + graph_window.innerHTML + '</div>');
				$( this ).dialog( "close" );
			}
			}
		]
	);
}

function dock_plot(graph_window, plot) {
	var title = $( graph_window ).dialog( "option", "title");
	var id = ($("#dock").children().length)/2;
	console.log(graph_window);
	//console.log('<h3>' + title + '</h3>' + '<div id = "sample">' + plot + '<br><button id="undock_' + id + '" onclick="undock_plot(' + id + ',"' + plot + '")">Undock</button><button id="dock_close_' + id + '" onclick="close_dock_plot(' + id + ')">Close</button></div>');
	$("#dock").append('<h3>' + title + '</h3>' + '<div>' + plot + '<br><button id="undock_' + id + '" onclick="undock_plot(' + id + ')">Undock</button><button id="dock_close_' + id + '" onclick="close_dock_plot(' + id + ')">Close</button></div>');
	$("#undock_" + id).button();
	$("#dock_close_" + id).button();
	$("#dock").accordion( "refresh" );
}

function undock_plot(id) {
	// this will give strange result after "undock"-"dock"
	//var plot = ($("#dock").children('div').eq(id)).children('div').eq(0)[0];
	var plot = '<div id="' + ($("#dock").children('div').eq(id)).children('div').eq(0)[0].getAttribute("id") + '">' + ($("#dock").children('div').eq(id)).children('div').eq(0)[0].innerHTML + '</div>';
	console.log(plot);
	var plot_title = $("#dock").children('h3').eq(id)[0].innerText;
	console.log(plot_title);
	close_dock_plot(id);
	$(plot).dialog({
				title: plot_title, 
				buttons: [
				{
					text: "Minimize",
					icon: "ui-icon-minus",
					click: function() {plot_minimize(this)},
				},
				{
					text: "Dock",
					icon: "ui-icon-arrowthickstop-1-s",
					click: function() {
						dock_plot(this, plot);
						$( this ).dialog( "close" );
					}
				}
				],
				height: 'auto',
				width: 'auto',
				modal: false,
				create: function() {
					($(this).children('iframe'))[0].setAttribute("height", 800);
					($(this).children('iframe'))[0].setAttribute("width", 1280);
				},
				beforeClose: function( event, ui ) {$(this).dialog('destroy').remove()}
			});
}

function close_dock_plot(id) {
	$("#dock").children('div').eq(id).remove();
	$("#dock").children('h3').eq(id).remove();
	for (i = id+1; i<=($("#dock").children().length)/2; i++) {
		document.getElementById('undock_' + i).setAttribute("onclick", 'undock_plot(' + (i-1) + ')');
		document.getElementById('undock_' + i).setAttribute("id", 'undock_' + (i-1));
		document.getElementById('dock_close_' + i).setAttribute("onclick", 'close_dock_plot(' + (i-1) + ')');
		document.getElementById('dock_close_' + i).setAttribute("id", 'dock_close_' + (i-1));
	}
}

function id_keyup(k) {
	var n = $('#plot_options tr').length;
	var flag = true;
	for (i = 1; i<=n; i++) {
		if ($("#id" + i + "_input").is(":enabled")) {
			var valueSoFar = ($("#id" + i + "_input").val()).toUpperCase();
			$("#id" + i + "_input").val(valueSoFar);
			var available_ids = $( "#id" + i + "_input" ).autocomplete("option", "source");
			flag = flag*available_ids.includes(valueSoFar);
		}
		else {
			flag = flag*true;
		}
	}
	if (flag) {
		$("#plot-button").button("enable");
		setTimeout(function(){$("#id" + k + "_input").css('border-color', '')}, 500);
		$("#id" + k + "_input").css('border-color', 'green');
	}
	else {
		$("#plot-button").button("disable");
	}
}

function generate_plot_title(type, cohort, datatypes, platforms, ids, scales) {
	var plot_title = '';
	switch (type) {
			case "scatter": 
				if (ids.every((val, i, arr) => val === "")) {
					plot_title = type + ' of ' + cohort + ' (' + datatypes[0] + ':' + platforms[0] + ':' + scales[0] + ' vs ' + datatypes[1] + ':' + platforms[1] + ':' + scales[1] + ')';
				}
				else {
					plot_title = type + ' of ' + cohort + ' (' + datatypes[0] + ':' + platforms[0] + ':' + ids[0] + ':' + scales[0] + ' vs ' + datatypes[1] + ':' + platforms[1] + ':' + ids[1] + ':' + scales[1] + ')';
				}
				break;
			case "histogram": 
				if (ids[1] = "") {
					plot_title = type + ' of ' + cohort + ' (' + datatypes[0] + ':' + platforms[0] + ':' + scales[0] + ')';
				}
				else {
					plot_title = type + ' of ' + cohort + ' (' + datatypes[0] + ':' + platforms[0] + ':' + ids[0] + ':' + scales[0] + ')';
				}
				break;
			case "box": plot_title = type + ' of ' + cohort;
				break;
			case "KM": plot_title = type + ' of ' + cohort;
				break;
			case "piechart": plot_title = type + ' of ' + cohort;
				break;
			case "bar": 
				if (ids[1] = "") {
					plot_title = type + ' of ' + cohort + ' (' + datatypes[0] + ':' + platforms[0] + ')';
				}
				else {
					plot_title = type + ' of ' + cohort + ' (' + datatypes[0] + ':' + platforms[0] + ':' + ids[0] + ':' + ')';
				}
				break;
			case "venn": plot_title = type + ' of ' + cohort;
				break;
		}
	return plot_title;
}
</script>
</BODY>
</HTML>
	
