<!DOCTYPE html>
<HTML lang="en-US">
<HEAD>

<TITLE>Drug screen data - dev version</TITLE>
<LINK href="pics/favicon.ico" rel="shortcut icon">
<meta http-equiv="content-type" content="charset=utf-8">
<META http-equiv="Content-Script-Type" content="application/javascript" >
<LINK href="hyperset.css" type="text/css" rel="stylesheet">
<LINK href="js/jquery-ui-themes-1.12.1/themes/blitzer/jquery-ui.min.css" type="text/css" rel="stylesheet">
<LINK href="js/jquery-ui-themes-1.12.1/themes/blitzer/jquery-ui-1.12.icon-font.min.css" type="text/css" rel="stylesheet">
<LINK href="js/qTip/jquery.qtip.min.css" type="text/css" rel="stylesheet">
<link href="js/Cytoscape.js/cytoscape-cytoscape.js-panzoom-c1dbe79/cytoscape.js-panzoom.css" rel="stylesheet" type="text/css" />
<link href="js/Cytoscape.js/cytoscape-cytoscape.js-panzoom-c1dbe79/font-awesome-4.0.3/css/font-awesome.css" rel="stylesheet" type="text/css" />
<link href="//cdn.datatables.net/1.10.4/css/jquery.dataTables.min.css" rel="stylesheet" type="text/css">
<link href="//cdn.datatables.net/tabletools/2.2.3/css/dataTables.tableTools.css" rel="stylesheet" type="text/css">
<link href="//cdn.datatables.net/plug-ins/3cfcc339e89/integration/jqueryui/dataTables.jqueryui.css" type="text/css">
<link href="//cdn.datatables.net/responsive/1.0.4/css/dataTables.responsive.css" type="text/css">
<script src="js/jquery-3.3.1.min.js" type="text/javascript"></script>
<script src="js/jquery-ui-1.12.1.custom/jquery-ui.min.js" type="text/javascript"></script>
<script src="js/jquery-ui-contextmenu-master/jquery.ui-contextmenu.min.js" type="text/javascript"></script>  
<script src="js/jquery.form.js" type="text/javascript"></script>  
<script src="js/Cytoscape.js/cytoscape.min.js" type="text/javascript"></script>  
<!--script src="js/cytoscape.js-cxtmenu-master/cytoscape-cxtmenu.js" type="text/javascript"></script-->
<script src="js/cytoscape.js-cxtmenu-master/cytoscape-cxtmenu.js" type="text/javascript"></script>
<script src="js/Cytoscape.js/cytoscape-cytoscape.js-panzoom-c1dbe79/cytoscape.js-panzoom.js" type="text/javascript"></script>
<script src="js/overlib.js" type="text/javascript"></script>
<script src="//cdn.datatables.net/1.10.4/js/jquery.dataTables.min.js" type="text/javascript"></script>
<script src="//cdn.datatables.net/tabletools/2.2.3/js/dataTables.tableTools.js" type="text/javascript"></script>
<script src="//cdn.datatables.net/responsive/1.0.4/js/dataTables.responsive.js" type="text/javascript"></script>
<script src="js/qTip/jquery.qtip.min.js" type="text/javascript"></script>

<script src="js/Cytoscape.js/cytoscape.js-qtip-master/jquery.cytoscape.js-qtip.js" type="text/javascript"></script>
<script src="js/Cytoscape.js/cytoscape.js-edgehandles.js" type="text/javascript"></script>

<script src="js/druggable_config.js" type="text/javascript" charset="utf-8"></script>
<script src="js/HS.js" type="text/javascript" charset="utf-8"></script>
<script src="js/drugs.js" type="text/javascript"></script>
<script src="js/cookies.js" type="text/javascript"></script>

<!--script src="js/HS.js" type="text/javascript" charset="utf-8"></script-->

<style>
li.tab ul {
  display: none;
  margin: 0;
  padding: 0;
  list-style: none;
  border: 1px solid #d5d5d5;
  border-radius: 0 0 3px 3px;
}

li.tab:hover ul li {
  color: #454545;
  margin: 0;
  background-color: #e9e9e9;
  padding: 4px 10px;
  cursor: pointer;
  border-bottom: 1px solid #d5d5d5;
}

li.tab:hover ul li:hover,
li.tab:hover ul li.active {
  background-color: #ffffff;
}

li.tab:hover ul {
  display: block;
  position: absolute;
  top: 100%;
  left: 0;
}

.ui-menu { width: 150px; }

.ui-dialog {
    padding: 0;
    margin: 0;
}
.ui-dialog .ui-dialog-content {
    padding: 0;
    margin: 0;
    overflow: hidden;
}
</style>
</HEAD>

<BODY class="ui-state-default ui-corner-all">
<div id="progressbar"></div>

<div id="cookiewarning">
	<div role="alert" class="ui-widget-header ui-corner-all" style=" margin: 5px; padding: 5px;">
	<p style="width: 95%; height: 60px; display: block; text-align: right; margin: 5px; padding: 5px;">This website uses cookies. To learn more about our cookie policy, click <a class="clickable" style="color: #e17009" href="https://www.evinet.org/help/faq-evi/evi-faq.html#privacy">here</a>
	  <br>  <br>
	  <button type="button" id="acceptcookies" class="ui-widget-header ui-corner-all" style="vertical-align: middle; align: right;" onclick="acceptCookies()">I agree</button>
	  </p>
	</div>	
</div>
	
<div id="tabs">
	<ul>
		<li><a href="#tab-home">Home</a></li>
		<li><a href="#tab-signif">Significant results</a></li>
		<li><a href="#tab-lookup">Look up</a></li>
		<li class="tab"><a href="#tab-plot">Plots</a>
			<ul class="tabsubmenu">
				<li onclick = plot("2D")>2D</li>
				<li onclick = plot("3D")>3D</li>
				<li onclick = plot("Box")>Box</li>
			</ul>
		</li>
	</ul>
	<div id="tab-home">This is a home tab</div>
	<div id="tab-signif">
		<table id="select_layout"><tr>
		<td id="selectFeature">
		<select name="screenList" id="screenList" class="ui-helper" style="width: 40ch;" >
		</td>
		<td id="selectCompound>">
		<!--ul name="compoundsList" id="compoundsList"></ul-->
		<select name="compoundsList" id="compoundsList" class="ui-helper" style="width: 40ch;" >
		</td>
		<td>
		<select name="featuresList" id="featuresList" class="ui-helper" style="width: 40ch;" >
		</td>
		<td>
		<button type="submit" id="retrieve-cor-button" name="retrieve-cor-button" onclick = retrieve_correlations() style="width: 150; visibility: visible;">Retrieve correlations</button>
		</td>
		</table>
	</div>
	<div id="tab-lookup"><br>
	<img id="plot_view">
	<br>
	<table>
		<tr>
		<td>
		<select id="source_selector" class="ui-helper" style="width: 40ch;">
		</td>
		<td>
		<select id="cohort_selector" class="ui-helper" style="width: 40ch;">
		</td>
		</tr>
	</table>
	<br>
	<table id = "plot_options">
		<tr>
		<td>
		<select id="type1_selector" class="ui-helper" style="width: 40ch;">
		</td>
		<td>
		<select id="platform1_selector" class="ui-helper" style="width: 40ch;">
		</td>
		<td>
		<input id="id1_input" onkeyup="id_keyup(1)" onchange = "id_keyup(1)">
		</td>
		<td>
		<select id="axis1_selector" class="ui-helper" style="width: 20ch;">
		</td>
		<td>
		<select id="tcga1_selector" class="ui-helper" style="width: 10ch;">
		</td>
		<td>
		<button id="add_row1" max=3 onclick="add_plot_options_row(1)">+</button>
		</td>
		<td>
		<button id="delete_row1" onclick="delete_plot_options_row(1)">-</button>
		</td>
		</tr>
	</table>
	<br>
	<table>
	<tr>
	<td>
	<select id="plot-type">
	</td>
	<td>
	<button id="plot-button" onclick="plot()">Plot</button>
	</td>
	</tr>
	</table>
	</div>
</div>   

<P style="width:33%;text-align:right;">Found problems? <A href="mailto:andrej.alekseenko@scilifelab.se">Send us email</A></P>

<script>
var loadingIndicator = 'ui-icon-loading-status-balls';
var loadingClasses = 'ui-icon ' + loadingIndicator + ' rotate';

$(document).ready(function(){
	safe_clear();
	var cookies = checkCookiesAccepted();
	if (cookies) {
		var accepted_time = (getCookie("cookies_accepted").split("|"))[1];
		usetCookie("cookies_accepted", "true", accepted_time);
	}
	$(function() {
		$( "#showScales" ).dialog({
			resizable: false,
			modal: false,
			title: "Drug sensitivity scales", 
			width:  600,
			height: "auto",
			autoOpen: false,
			show: {
				effect: "blind",
				duration: 280
			},
			hide: {
				effect: "explode",
				duration: 600
			},
			buttons: {"Close": 
				function () {
					$(this).dialog("close");
				}
			}
		});
		$( "#ssOpener" ).click(function() {
			$( "#showScales" ).dialog( "open" );
			$( "#ssAcc" ).accordion();
		});
	});
	urlfixtabs("#tabs");
	$("#progressbar").progressbar({
		value: false
	});
	$("#progressbar").css({"visibility": "hidden"});
	$("#tabs").tabs({});
	// hide "Plots" tab by default
	$($("#tabs").find("li")[3]).hide()
	
	var screens = drug_sources();
	var options = [];
	options.push("<option value='all'>All screens</option>");
	for (i in screens) {
		options.push("<option value='" + screens[i].code + "'>" + screens[i].name +"</option>");
	}
	$("#screenList").append(options.join("")).selectmenu();
	
	var drugs = drug_list();
	$("#compoundsList").menu();
	for (i in drugs) {
		 $("<li><a href='#'>"+drugs[i].source+"</a></li>").appendTo("#compoundsList");
		 console.log(drugs[i].source);
      $("#compoundsList").menu("refresh");
	}
	options = [];
	$("#compoundsList").append("<option value='all'>All compounds</option>").selectmenu();
	for (i in drugs) {
		for (j in drugs[i].drugs) {
			options.push("<option value='" + drugs[i].drugs[j] + "'>"+ drugs[i].drugs[j] +"</option>")
		}
		$("#compoundsList").append('<optgroup label="' + drugs[i].source + '">' + options.join("") + '</optgroup>').selectmenu();
	}
	
	var features = feature_list();
	options = [];
	$("#featuresList").append("<option value='all'>All features</option>").selectmenu();
	for (i in features) {
		for (j in features[i].codes) {
			options.push("<option value='"+ features[i].codes[j] + "'>" + features[i].names[j] + "</option>");
		}
		$("#featuresList").append('<optgroup label="'+ features[i].feature + '">' + options.join("") + '</optgroup>').selectmenu();
	}	
		
	$("#submit-populate").button();
	var sources = get_plot_sources();
	options = [];
	for (i in sources) {
		options.push("<option value='"+ sources[i] + "'>" + sources[i] + "</option>");
	}
	$("#source_selector").append(options.join("")).selectmenu();
	$('#source_selector').on( "selectmenuchange", function( event, ui ) {update_source()} );
	init_cohortselector();
	$("#plot-button").button();
	$("#plot-button").button("disable");
	// need to call it manually because some types of plots need no additional parameters 
	id_keyup(1);
	if (sessionStorage.getItem("docked_plots") == null) {
		sessionStorage.setItem("docked_plots", 0);
	}
});

function plot() {
	var cookies = checkCookiesAccepted();
	if (cookies) {
		var type = $('#plot-type option:selected').val();
		var n = $('#plot_options tr').length;
		var source = $("#source_selector option:selected").val();
		var cohort = $("#cohort_selector option:selected").val();
		var datatypes = [];
		var ids = [];
		var platforms = [];
		var scales = [];
		var tcga_codes = [];
		for (i=1; i<=n; i++) {
			datatypes.push($("#type" + i + "_selector option:selected").val());
			platforms.push($("#platform" + i + "_selector option:selected").val());
			ids.push($("#id" + i + "_input").val());
			scales.push($("#axis" + i + "_selector option:selected").val());
			tcga_codes.push($("#tcga" + i + "_selector option:selected").val())
		}
		var plot_description = "type:" + type + "|cohort:" + cohort + "|datatypes:" + datatypes + "|platforms:" + platforms + "|ids:" + ids + "|tcga_codes:" + tcga_codes + "|scales:" + scales;
		var plot_filename = find_plot_in_history(plot_description);
		var plot_id;
		var plot_title = generate_plot_title(type, cohort, datatypes, platforms, ids, scales);
		// new plot
		if (plot_filename == "no") {
			$("#progressbar").css({"visibility": "visible"});
			plot_filename = rplot(type, source, cohort, datatypes, platforms, ids, tcga_codes, scales);
			plot_id = plot_filename.substring(0, plot_filename.length-5);
			// save plot in session history
			sessionStorage.setItem(plot_filename, plot_description);
			var graph_window = '<div id="plot_window_' + plot_id +'"><iframe src="https://www.evinet.org/pics/plots/' + plot_filename + '" width="1280" height="800"></div>';
			$(graph_window).dialog({
				title: plot_title,
				buttons: [
					{
						text: "Minimize",
						icon: "ui-icon-minus",
						click: function() {plot_minimize(this)},
					},
					{
						text: "Dock",
						icon: "ui-icon-arrowthickstop-1-s",
						click: function() {
							dock_plot(this, plot_id);
						},
						showText: false
					}
				],
				height: 'auto',
				width: 'auto',
				modal: false,
				resize: function( event, ui ) {
						($(this).children('iframe'))[0].setAttribute("height", $(this).height());
						($(this).children('iframe'))[0].setAttribute("width", $(this).width());
					},
				beforeClose: function( event, ui ) {$(this).dialog('destroy').remove()}
			});
			$("#progressbar").css({"visibility": "hidden"});
		}
		// existing plot
		else {
			console.log("No need to do it again!");
			plot_id = plot_filename.substring(0, plot_filename.length-5);
			if (document.getElementById("plot_window_" + plot_id)) {
				console.log("We already have a window: move it to the top!");
				$("#plot_window_" + plot_id + ".ui-dialog-content.ui-widget-content").dialog("moveToTop");
			}
			else {
				console.log("Plot was closed");
				var graph_window = '<div id="plot_window_' + plot_id +'"><iframe src="https://www.evinet.org/pics/plots/' + plot_filename + '" width="1280" height="800"></div>';
				$(graph_window).dialog({
					title: plot_title,
					buttons: [
						{
							text: "Minimize",
							icon: "ui-icon-minus",
							click: function() {plot_minimize(this)}
						},
						{
							text: "Dock",
							icon: "ui-icon-arrowthickstop-1-s",
							click: function() {
								dock_plot(this, plot_id);
							}
						}
					],
					height: 'auto',
					width: 'auto',
					modal: false,
					//resizable: false,
					resize: function( event, ui ) {
						($(this).children('iframe'))[0].setAttribute("height", $(this).height());
						($(this).children('iframe'))[0].setAttribute("width", $(this).width());
					},
					beforeClose: function( event, ui ) {$(this).dialog('destroy').remove()}
				});
			}
		}
	}
	else {
		alert("Please accept cookies to use this site");
	}
}

function retrieve_correlations() {
	var screen = $("#screenList option:selected").val();
	var compound = $("#compoundsList option:selected").val();
	var feature = $("#featuresList option:selected").val();
	console.log(screen + " " + compound + " " + feature);
	retreive_drug_correlations(screen, compound, feature);
}

function add_plot_options_row(i) {
	var cookies = checkCookiesAccepted();
	if (cookies) {
		// current number of rows
		var n = $('#plot_options tr').length;
		for (j=i+1; j<=n; j++) {
			$('#type' + j + '_selector').on( "selectmenuchange", function( event, ui ) {update('type' + (j+1) + '_selector')} );
			$('#platform' + j + '_selector').on( "selectmenuchange", function( event, ui ) {update('platform' + (j+1) + '_selector')} );
			document.getElementById('type' + j +'_selector').setAttribute("id", 'type' + (j+1) +'_selector');
			document.getElementById('platform' + j +'_selector').setAttribute("id", 'platform' + (j+1) +'_selector');
			document.getElementById('id' + j +'_input').setAttribute("onkeyup", 'id_keyup(' + (j+1) +')');
			document.getElementById('id' + j +'_input').setAttribute("onchange", 'id_keyup(' + (j+1) +')');
			document.getElementById('id' + j +'_input').setAttribute("id", 'id' + (j+1) +'_input');
			document.getElementById('axis' + j +'_selector').setAttribute("id", 'axis' + (j+1) +'_selector');
			document.getElementById('tcga' + j +'_selector').setAttribute("id", 'tcga' + (j+1) +'_selector');
			document.getElementById('add_row' + j).setAttribute("id", 'add_row' + (j+1));
			document.getElementById('add_row' + (j+1)).setAttribute("onclick", 'add_plot_options_row(' + (j+1) + ')');
			document.getElementById('delete_row' + j).setAttribute("id", 'delete_row' + (j+1));
			document.getElementById('delete_row' + (j+1)).setAttribute("onclick", 'delete_plot_options_row(' + (j+1) + ')');
		}
		
		sessionStorage.setItem("add_row", 1);
		
		var table = document.getElementById("plot_options");
		var row = table.insertRow(i);
		var TypeSelectorCell = row.insertCell(0);
		TypeSelectorCell.innerHTML = '<select id="type' + (i+1) +'_selector" class="ui-helper" style="width: 40ch;">';
		var for_delete = false;
		var flag = init_dataselector('type'+(i+1)+'_selector');
		if (flag) {
			alert('No more compatible datatypes!');
			for_delete = true;
		}
		var PlatformSelectorCell = row.insertCell(1);
		PlatformSelectorCell.innerHTML = '<select id="platform' + (i+1) +'_selector" class="ui-helper" style="width: 40ch;">';
		var IdInput = row.insertCell(2);
		IdInput.innerHTML = '<input id="id'+ (i+1) + '_input" onkeyup="id_keyup(' + (i+1) + ')" onchange="id_keyup(' + (i+1) + ')">';
		flag = init_platformselector('platform'+(i+1)+'_selector');
		if (flag & !for_delete) {
			alert('No more compatible platforms!');
			for_delete = true;
		}
		var AxisSelector = row.insertCell(3);
		AxisSelector.innerHTML = '<select id="axis' + (i+1) +'_selector" class="ui-helper" style="width: 20ch;">';
		init_axis_type_selector('axis' + (i+1) + '_selector');
		var TCGASelector = row.insertCell(4);
		TCGASelector.innerHTML = '<select id="tcga' + (i+1) +'_selector" class="ui-helper" style="width: 10ch;">';
		init_tcga_code_selector('tcga' + (i+1) + '_selector');
		var AddButton = row.insertCell(5);
		AddButton.innerHTML = '<button id="add_row' + (i+1) + '" max=3 onclick="add_plot_options_row(' + (i+1) + ')">+</button>';
		var DeleteButton = row.insertCell(6);
		DeleteButton.innerHTML = '<button id="delete_row' + (i+1) + '" max=3 onclick="delete_plot_options_row(' + (i+1) + ')">-</button>';
		update_plot_types();
		$("#add_row" + (i+1)).button();
		$("#delete_row" + (i+1)).button();
		if (n+1 >= document.getElementById("add_row" + i).getAttribute("max")) {
			for (j=1; j<=n+1; j++) {
				$("#add_row" + j).button("disable");
			}
		}
		for (j=1; j<=n; j++) {
				$("#delete_row" + j).button("enable");
			}
		$("#source_selector").selectmenu("disable");
		$("#cohort_selector").selectmenu("disable");
		var id_input_enabled = ($("#id" + (i+1) + "_input").is(":enabled"));
		if (id_input_enabled) {
			$("#plot-button").button("disable"); 
		}
		if (for_delete) {
			delete_plot_options_row(i+1);
		}
		else {
			for (j=1; j<=n+1; j++) {
				// re-initiate all other codes selectors, because we can have new selector without meta-codes - in this case they have to be removed from other selectors as well
				if (j != i+1) {
					$('#tcga'+ j + '_selector').find('option').remove().end();
					$('#tcga'+ j + '_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
					init_tcga_code_selector('tcga'+ j + '_selector');
					$('#tcga'+ j + '_selector').selectmenu( "refresh" );
				}
			}
		}
		sessionStorage.removeItem("add_row");
		id_keyup(i+1);
	}
	else {
		alert("Please accept cookies to use this site");
	}
}

function delete_plot_options_row(i) {
	// no need to check cookies in this function - you cannot add row without accepting cookies
	var n = $('#plot_options tr').length;
	for (j=i+1; j<=n; j++) {
		$('#type' + j + '_selector').on( "selectmenuchange", function( event, ui ) {update('type' + (j-1) + '_selector')} );
		$('#platform' + j + '_selector').on( "selectmenuchange", function( event, ui ) {update('platform' + (j-1) + '_selector')} );
		document.getElementById('type' + j +'_selector').setAttribute("id", 'type' + (j-1) +'_selector');
		document.getElementById('platform' + j +'_selector').setAttribute("id", 'platform' + (j-1) +'_selector');
		document.getElementById('id' + j +'_input').setAttribute("onkeyup", 'id_keyup(' + (j-1) +')');
		document.getElementById('id' + j +'_input').setAttribute("onchange", 'id_keyup(' + (j-1) +')');
		document.getElementById('id' + j +'_input').setAttribute("id", 'id' + (j-1) +'_input');
		document.getElementById('axis' + j +'_selector').setAttribute("id", 'axis' + (j-1) +'_selector');
		document.getElementById('tcga' + j +'_selector').setAttribute("id", 'tcga' + (j-1) +'_selector');
		document.getElementById('add_row' + j).setAttribute("onclick", 'add_plot_options_row(' + (j-1) + ')');
		document.getElementById('add_row' + j).setAttribute("id", 'add_row' + (j-1));
		document.getElementById('delete_row' + j).setAttribute("onclick", 'delete_plot_options_row(' + (j-1) + ')');
		document.getElementById('delete_row' + j).setAttribute("id", 'delete_row' + (j-1));
	}	
	document.getElementById("plot_options").deleteRow(i-1);
	for (j=1; j<n; j++) {
		$("#add_row" + j).button("enable");
	}
	if (n-1 == 1) {
		$("#delete_row1").button("disable");
		$("#source_selector").selectmenu("enable");
		$("#cohort_selector").selectmenu("enable");
	}
	if (i == 1) {
		$('#type1_selector').find('option').remove().end();
		$('#type1_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
		init_dataselector('type1_selector');
		$('#type1_selector').selectmenu( "refresh" );
	}
	if (sessionStorage.getItem("cascade_delete") == null) {
		update_plot_types();
		if (i <n) {
			update_type(i);
		}
	}
	// artificially trigger change event for all available inputs
	// so if the deleted row was the reason why plot-button was disabled - the button would become enabled
	id_keyup(i-1);
}

function init_cohortselector() {
	var cohorts = get_plot_cohorts($("#source_selector option:selected").val());
	options = [];
	for (i in cohorts) {
		options.push("<option value='"+ cohorts[i] + "'>" + cohorts[i] + "</option>");
	}
	$("#cohort_selector").append(options.join("")).selectmenu();
	$('#cohort_selector').on( "selectmenuchange", function( event, ui ) {update_cohort()} );
	$('#cohort_selector').selectmenu( "refresh" );
	sessionStorage.setItem("add_row", 1);
	init_dataselector("type1_selector");
	init_platformselector("platform1_selector");
	init_axis_type_selector("axis1_selector");
	init_tcga_code_selector("tcga1_selector");
	init_plot_type_selector();
	$("#add_row1").button();
	$("#delete_row1").button();
	$("#delete_row1").button("disable");
	sessionStorage.removeItem("add_row");
}

function init_dataselector(selector_id) {
	var total = $('#plot_options tr').length;
	var n = parseInt(selector_id.substr(4, selector_id.indexOf("_")-4));
	var previous_datatypes = [];
	for (j=1; j<n; j++) {
		console.log(j);
		previous_datatypes.push($("#type" + j +"_selector option:selected").val());
	}
	var datatypes = get_cohort_datatypes($("#cohort_selector option:selected").val(), previous_datatypes);
	var empty = (datatypes.length == 0);
	if (!empty) {
		options = [];
		for (i in datatypes) {
			options.push("<option value='"+ datatypes[i] + "'>" + datatypes[i] + "</option>");
		}
		$("#" + selector_id).append(options.join("")).selectmenu();
		var previous_selection = (getCookie(selector_id).split("|"))[0];
		if (datatypes.includes(previous_selection)) {
			$("#" + selector_id).val(previous_selection);
			$("#" + selector_id).selectmenu( "refresh" );
		}
		else {
			if (previous_selection != '') {
				//alert("Data row " + n + ": unable to set up datatype " + previous_selection + " due to incompatibility with previous rows");
			}
		}
		$("#" + selector_id).on( "selectmenuchange", function( event, ui ) {update('type' + n + '_selector')} );
	}
	else {
		for (i = total; i>n; i--) {
			delete_plot_options_row(i);
		}
	}
	return empty;
}

function init_platformselector(selector_id) {
	var total = $('#plot_options tr').length;
	var n = parseInt(selector_id.substr(8, selector_id.indexOf("_")-8));
	var previous_platforms = [];
	for (j=1; j<n; j++) {
		previous_platforms.push($("#platform" + j +"_selector option:selected").val());
	}
	//console.log('previous platforms: ' + previous_platforms);
	//console.log($("#cohort_selector option:selected").val() + ' ' + $("#type" + n + "_selector option:selected").val() + ' ' + previous_platforms);
	var platforms = get_platforms($("#cohort_selector option:selected").val(), $("#type" + n + "_selector option:selected").val(), previous_platforms);
	//console.log(platforms);
	var empty = (platforms.length == 1);
	//console.log(empty);
	if (!empty) {
		// check if we have ids or no for the chosen datatype;
		// cannot use ?...:... here, because we need to shift platforms anyway
		var flag = parseInt(platforms.shift());
		// drugs are special case
		if (platforms[0][0].platform == "drug") {
			flag = 1;
		}
		document.getElementById("id" + n + "_input").disabled = !(flag);
		document.getElementById("id" + n + "_input").hidden = !(flag);
		options = [];
		for (i in platforms) {
			for (j in platforms[i]) {
				options.push("<option value='"+ platforms[i][j].platform + "'>" + platforms[i][j].name + "</option>");
			}
		}
		$("#" + selector_id).append(options.join("")).selectmenu();
		var previous_type = (getCookie("type" + n + "_selector").split("|"))[0];
		var previous_selection = (getCookie(selector_id).split("|"))[0];;
		if (platforms.includes(previous_selection)) {
			$("#" + selector_id).val(previous_selection);
			$("#" + selector_id).selectmenu( "refresh" );
		}
		else {
			if ((previous_selection != "") & (previous_type == $("#type" + n + "_selector option:selected").val())) {
				//alert("Data row " + n + ": unable to set up platform " + previous_selection + " due to incompatibility with previous rows");
			}
		}
		// get autocomplete_ids only if it is enabled
		if (flag) {
			var autocomplete_ids = get_autocomplete_ids ($("#cohort_selector option:selected").val(), $("#type" + n + "_selector option:selected").val(), $("#platform" + n + "_selector option:selected").val());
			$("#id" + n + "_input").autocomplete({
				source: autocomplete_ids,
				minLength: (Math.log10(autocomplete_ids.length) > 2) ? 3 : 2
			});
		}
		$("#" + selector_id).on( "selectmenuchange", function( event, ui ) {update(selector_id)} );
	}
	return empty;
}

function init_axis_type_selector(selector_id) {
	var n = selector_id.substr(4, selector_id.indexOf("_")-4);
	var axis_types = get_axis_types($("#cohort_selector option:selected").val(), $("#type" + n + "_selector option:selected").val(), $("#platform" + n + "_selector option:selected").val());
	options = [];
	for (i in axis_types) {
		options.push("<option value='"+ axis_types[i] + "'>" + axis_types[i] + "</option>");
	}
	var flag = (axis_types.length == 0);
	$("#" + selector_id).append(options.join("")).selectmenu();
	$("#" + selector_id).selectmenu({
		disabled: flag
	});
}

function init_tcga_code_selector(selector_id) {
	var n = selector_id.substr(4, selector_id.indexOf("_")-4);
	var total = $('#plot_options tr').length;
	// in this case 'previous' mean 'previous in time', not 'in order'
	// e.g. tcga3_selector can be set before tcga1_selector
	var previous_datatypes = [];
	for (j=1; j<=total; j++) {
		if (j != n) {
			//console.log(j);
			previous_datatypes.push($("#type" + j +"_selector option:selected").val());
		}
	}
	var tcga_codes = get_tcga_codes($("#cohort_selector option:selected").val(), $("#type" + n + "_selector option:selected").val(), previous_datatypes);
	options = [];
	for (i in tcga_codes) {
		options.push("<option value='"+ tcga_codes[i] + "'>" + tcga_codes[i] + "</option>");
	}
	// in case if we have 0 codes tcga_codes is [""]
	var flag = (($("#source_selector option:selected").val() != "TCGA") || (tcga_codes[0] == ""));
	$("#" + selector_id).append(options.join("")).selectmenu();
	$("#" + selector_id).selectmenu({
		disabled: flag
	});
}

function init_plot_type_selector() {
	console.log('init_plot_type_selector() invoked');
	var platforms = [];
	var n = $('#plot_options tr').length;
	for (i=1; i<=n; i++) {
		platforms.push($("#platform" + i + "_selector option:selected").val());
	}
	options = [];
	var plot_types = get_plot_types(platforms);
	for (i in plot_types) {
		options.push("<option value='"+ plot_types[i] + "'>" + plot_types[i] + "</option>");
	}
	$('#plot-type').append(options.join("")).selectmenu();
	$('#plot-type').on( "selectmenuchange", function( event, ui ) {plot_type_changed()} );
	plot_type_changed();
}

function update_source() {
	$('#cohort_selector').find('option').remove().end();
	$('#cohort_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_cohortselector();
	update_cohort();
}

function update_cohort() {
	console.log('update_cohort() invoked');
	$('#type1_selector').find('option').remove().end();
	$('#type1_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	sessionStorage.setItem("add_row", 1);
	$('#type1_selector').find('option').remove().end();
	$('#type1_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_dataselector('type1_selector');
	$('#type1_selector').selectmenu( "refresh" );
	$('#platform1_selector').find('option').remove().end();
	$('#platform1_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_platformselector('platform1_selector');
	$('#platform1_selector').selectmenu( "refresh" );
	$('#tcga1_selector').find('option').remove().end();
	$('#tcga1_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_tcga_code_selector('tcga1_selector');
	$('#tcga1_selector').selectmenu( "refresh" );
	sessionStorage.removeItem("add_row");
	$('#id1_input').val("");
	update_plot_types();
	plot_type_changed();
}

function update_type(n) {
	if (sessionStorage.getItem("add_row") == null) {
		var accepted_time = (getCookie("cookies_accepted").split("|"))[1];
		var selector_value = $("#type" + n + "_selector option:selected").val();
		var previous_value = (getCookie("platform" + n).split("|"))[0];
		if (selector_value != previous_value) {
			usetCookie("type" + n + "_selector", selector_value, accepted_time);
			n = parseInt(n);
			$('#platform'+ n + '_selector').find('option').remove().end();
			$('#platform'+ n + '_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
			var empty = init_platformselector('platform' + n + '_selector');
			$('#platform'+ n + '_selector').selectmenu( "refresh" );
			var total = $('#plot_options tr').length;
			if (empty) {
				alert("No more compatible platforms");
				sessionStorage.setItem("cascade_delete", 1);
				for (i=total; i>=n; i--) {
					console.log("Cascade delete invoked. Removing row " + i + " (removing from " + total + " till " + n + ")");
					delete_plot_options_row(i);
				}
				sessionStorage.removeItem("cascade_delete");
			}
			else {
				if (n<total) {
					$('#type'+ (n+1) + '_selector').find('option').remove().end();
					$('#type'+ (n+1) + '_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
					var flag = init_dataselector('type' + (n+1) + '_selector');
					$('#type' + (n+1) + '_selector').selectmenu( "refresh" );
					if (flag) {
						alert("No more compatible datatypes");
						sessionStorage.setItem("cascade_delete", 1);
						for (i=total; i>n; i--) {
							delete_plot_options_row(i);
						}
						sessionStorage.removeItem("cascade_delete");
					}
				}
			}
		}
	}
}

function update_platform(n) {
	if (sessionStorage.getItem("add_row") == null) {
		var accepted_time = (getCookie("cookies_accepted").split("|"))[1];
		var selector_value = $("#platform" + n + "_selector option:selected").val();
		var previous_value = (getCookie("platform" + n).split("|"))[0];
		if (selector_value != previous_value) {
			usetCookie("platform" + n + "_selector", selector_value, accepted_time);
			n = parseInt(n);
			$("#id" + n + "_input").val("");
			if (sessionStorage.getItem("update_autocomplete") == null) {
				var autocomplete_ids = get_autocomplete_ids ($("#cohort_selector option:selected").val(), $("#type" + n + "_selector option:selected").val(), $("#platform" + n + "_selector option:selected").val());
				$("#id" + n + "_input").autocomplete({
					source: autocomplete_ids,
					minLength: (Math.log10(autocomplete_ids.length) > 2) ? 3 : 2
				});
			}
			$('#axis'+ n + '_selector').find('option').remove().end();
			$('#axis'+ n + '_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
			init_axis_type_selector('axis'+ n + '_selector');
			$('#axis'+ n + '_selector').selectmenu( "refresh" );
			var source = $("#source_selector option:selected").val();
			var total = $('#plot_options tr').length;
			print
			if (n<total) {
				$('#platform' + (n+1) + '_selector').find('option').remove().end();
				$('#platform' + (n+1) + '_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
				var flag = init_platformselector('platform' + (n+1) + '_selector');
				if (flag) {
					alert("No more compatible platforms");
					sessionStorage.setItem("cascade_delete", 1);
					for (i=total; i>n; i--) {
						delete_plot_options_row(i);
					}
					sessionStorage.removeItem("cascade_delete");
				}
				$('#platform' + (n+1) + '_selector').selectmenu( "refresh" );
				selector_value = $("#platform" + (n+1) + "_selector option:selected").val();
				previous_value = (getCookie("platform" + (n+1)).split("|"))[0];
				if (selector_value != previous_value) {
					$("#id" + (n+1) + "_input").val("");
				}
			}
			// we need to update ALL tcga selectors because of meta-codes
			if (source == "TCGA") {
				for (var i = 1; i<=total; i++) {
					//console.log("Updating TCGA selector number " + i + " out of " + total + " Initator: platform" + n + "_selector");
					$('#tcga'+ i + '_selector').find('option').remove().end();
					$('#tcga'+ i + '_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
					init_tcga_code_selector('tcga'+ i + '_selector');
					$('#tcga'+ i + '_selector').selectmenu( "refresh" );
				}
			}
			id_keyup(n);
			plot_type_changed();
		}
	}
}

// WARNING! Use this function with extreme caution! It is a potential source of bugs
// e.g. it can hide input, but cannot set it visible back
// however, it is ok for current conditions
function plot_type_changed() {
	var total = $('#plot_options tr').length;
	// see druggable_config.js for variable definition
	var platforms = hidden_inputs.get($('#plot-type option:selected').val());
	if (typeof(platforms) != 'undefined') {
		for (i=1; i<=total; i++) {
			if (platforms.includes($("#platform" + i + "_selector option:selected").val())) {
				$("#id" + i + "_input").val("");
				document.getElementById("id" + i + "_input").hidden = true;
			}
		}
	}
}

function update_plot_types() {
	$('#plot-type').find('option').remove().end();
	$('#plot-type').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_plot_type_selector()
	$('#plot-type').selectmenu( "refresh" );
}

// this function has to be called by nearly every selector
// instead of using update chain
function update(initiator) {
	var cookies = checkCookiesAccepted();
	if (cookies) {
		// if update in process - do nothing
		if (sessionStorage.getItem("updates_triggered") != null) {
			console.log("Update invoked, but rejected. Initiator: " + initiator + ". Reason: update already in progress.");
		}
		else {
			console.log("Update succesfully invoked by initiator: " + initiator);
			sessionStorage.setItem("updates_triggered", 1);
			var previous_value = (getCookie("initiator").split("|"))[0];
			var initiator_type = (initiator.split("_"))[0];
			var total = $('#plot_options tr').length;
			var n = parseInt(initiator_type[initiator_type.length - 1]);
			// type, platform etc. selectors contain numbers, but source selector does not
			if (!isNaN(n)) {
				initiator_type = initiator_type.slice(0, -1);
			}
			switch(initiator_type) {
				case "source":
					console.log("Source");
					update_source();
					break;
				case "cohort":
					console.log("Cohort");
					update_cohort();
					break;
				case "type":
					console.log("Type");
					update_type(n);
					// use this to avoid double-update
					sessionStorage.setItem("update_autocomplete", "false");
					update_platform(n);
					var current_value = $("#" + initiator + " option:selected").val();
					if (current_value != previous_value) {
						for (i=n+1; i<=n; i++) {
							update_type(i);
							update_platform(i);
						}
						update_plot_types();
					}
					sessionStorage.removeItem("update_autocomplete");
					break;
				case "platform":
					console.log("Platform");
					update_platform(n);
					var current_value = $("#" + initiator + " option:selected").val();
					if (current_value != previous_value) {
						for (i=n+1; i<=n; i++) {
							update_platform(i);
						}
					}
					update_plot_types();
					break;
			}
			sessionStorage.removeItem("updates_triggered");
		}
	}
	else {
		alert("Please accept cookies to use this site");
	}
}

function history() {
	var keys = Object.keys(sessionStorage);
	for (key in keys) {
		if (keys[i].includes("tmp")) {
			console.log(keys[key] + " : " + sessionStorage.getItem(keys[key]));
		}
	}
}

function find_plot_in_history(plot_description) {
	var keys = Object.keys(sessionStorage);
	var res = "no";
	for (i in keys) {
		if (keys[i].includes("tmp")) {
			if (sessionStorage.getItem(keys[i]) == plot_description) {
				res = keys[i];
			}
		}
	}
	return res;
}

function plot_minimize(graph_window) {
	$(graph_window).dialog({"height": $( ".ui-dialog > .ui-dialog-titlebar" )[1].clientHeight});
	// we need to change just first button, no need to do modify others
	var buttons = $(graph_window).dialog("option", "buttons");
	buttons[0] = {
			text: "Maximize",
			icon: "ui-icon-arrow-4-diag",
			click: function() {plot_maximize(graph_window)},
		},
	$(graph_window).dialog( "option", "buttons", buttons);
}

function plot_maximize(graph_window) {
	$(graph_window).dialog({"height": 800});
	$(graph_window).dialog({"width": 1280});
	var buttons = $(graph_window).dialog("option", "buttons");
	buttons[0] = {
			text: "Minimize",
			icon: "ui-icon-minus",
			click: function() {plot_minimize(graph_window)},
		},
	$(graph_window).dialog( "option", "buttons", buttons);
}

function dock_plot(graph_window, plot_id) {
	console.log($(graph_window).dialog( "option", "position" ));
	if (sessionStorage.getItem(plot_id + "_docked") == null) {
		var n = sessionStorage.getItem("docked_plots");
		sessionStorage.setItem("docked_plots", n+1);
		sessionStorage.setItem(plot_id + "_docked", n+1);	
	}
	
}

function id_keyup(k) {
	var n = $('#plot_options tr').length;
	var flag = true;
	for (i = 1; i<=n; i++) {
		if ($("#id" + i + "_input").is(":enabled")) {
			var valueSoFar = $("#id" + i + "_input").val();
			// this variable declared in druggable_config.js
			if (capitalized_datatypes.includes($("#type" + i + "_selector option:selected").val())) {
				valueSoFar = valueSoFar.toUpperCase();
				$("#id" + i + "_input").val(valueSoFar);
			}
			var available_ids = $( "#id" + i + "_input" ).autocomplete("option", "source");
			flag = flag*available_ids.includes(valueSoFar);
		}
		else {
			flag = flag*true;
		}
	}
	if (flag) {
		$("#plot-button").button("enable");
		setTimeout(function(){$("#id" + k + "_input").css('border-color', '');
								$("#id" + k + "_input").css('background-color', '')}, 500);
		$("#id" + k + "_input").css('border-color', 'chartreuse');
		$("#id" + k + "_input").css('background-color', 'chartreuse');
	}
	else {
		$("#plot-button").button("disable");
	}
}

function generate_plot_title(type, cohort, datatypes, platforms, ids, scales) {
	var plot_title = '';
	switch (type) {
			case "scatter": 
				if (ids.every((val, i, arr) => val === "")) {
					if (ids.length == 3) {
						plot_title = type + ' of ' + cohort + ' (' + datatypes[0] + ':' + platforms[0] + ':' + scales[0] + ' vs ' + datatypes[1] + ':' + platforms[1] + ':' + scales[1] + ' vs ' + datatypes[2] + ':' + platforms[2] + ':' + scales[2] + ')';
					}
					else {
						plot_title = type + ' of ' + cohort + ' (' + datatypes[0] + ':' + platforms[0] + ':' + scales[0] + ' vs ' + datatypes[1] + ':' + platforms[1] + ':' + scales[1] + ')';
					}
				}
				else {
					plot_title = type + ' of ' + cohort + ' (' + datatypes[0] + ':' + platforms[0] + ':' + ids[0] + ':' + scales[0] + ' vs ' + datatypes[1] + ':' + platforms[1] + ':' + ids[1] + ':' + scales[1] + ')';
				}
				break;
			case "histogram": 
				if (ids[1] = "") {
					plot_title = type + ' of ' + cohort + ' (' + datatypes[0] + ':' + platforms[0] + ':' + scales[0] + ')';
				}
				else {
					plot_title = type + ' of ' + cohort + ' (' + datatypes[0] + ':' + platforms[0] + ':' + ids[0] + ':' + scales[0] + ')';
				}
				break;
			case "box": plot_title = type + ' of ' + cohort;
				break;
			case "KM": plot_title = type + ' of ' + cohort;
				break;
			case "piechart": plot_title = type + ' of ' + cohort;
				break;
			case "bar": 
				if (ids[1] = "") {
					plot_title = type + ' of ' + cohort + ' (' + datatypes[0] + ':' + platforms[0] + ')';
				}
				else {
					plot_title = type + ' of ' + cohort + ' (' + datatypes[0] + ':' + platforms[0] + ':' + ids[0] + ':' + ')';
				}
				break;
			case "venn": plot_title = type + ' of ' + cohort;
				break;
		}
	return plot_title;
}

// function for technical purposes - use this to safely clear the sessionStorage, affects only SOME druggable.evinet values
function safe_clear() {
	sessionStorage.removeItem("add_row");
	sessionStorage.removeItem("updates_triggered");
	sessionStorage.removeItem("cascade_delete");
	sessionStorage.removeItem("update_autocomplete");
	
}
</script>
</BODY>
</HTML>
	
