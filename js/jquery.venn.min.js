/**
 * Copyright (C) 2012, Christopher Mullins ( chris.mullins10@gmail.com )
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a 
 * copy of this software and associated documentation files (the "Software"), 
 * to deal in the Software without restriction, including without limitation 
 * the rights to use, copy, modify, merge, publish, distribute, sublicense, 
 * and/or sell copies of the Software, and to permit persons to whom the 
 * Software is furnished to do so, subject to the following conditions: 
 * 
 * The above copyright notice and this permission notice shall be included in 
 * all copies or substantial portions of the Software. 
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR 
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, 
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL 
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER 
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING 
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER 
 * DEALINGS IN THE SOFTWARE. 
 */
(function(e){function t(e,t){this.venn=e;this.data=e.data("venn");this.settings=this.data.settings;this.containedSets=t;this.active=false;this.shadingLines=null;var n=function(e,t){return e.data("index")-t.data("index")};this.containedSets=this.containedSets.sort(n)}function r(){var e={};var n=this.data("venn");var r=n.set;var i=n.settings;var s=.05*Math.max(n.bbox.width,i.canvasWidth);for(var o=0;o<this.width();o+=s){for(var u=0;u<this.height();u+=s){var a=o+s,f=u+s;var c=l(a,f,r);var h=t.getHashKey(c);e[h]=[a,f]}}return e}function i(e,n){if(n.length==0){return[new t(e,[])]}else{var r=i(e,n.slice(1));var s=[];for(var o in r){s.push(r[o]);s.push(r[o].union([n[0]]))}return s}}function s(e,t,n){var r=.3*e.canvasWidth/2;var i=e.canvasWidth/2;var s=e.canvasHeight/2;var o=[t.ellipse(i-r/2,s,r,r),t.ellipse(i+r/2,s,r,r)];for(var u in o){var a=o[u];a.attr("stroke",e.colors[u]).data("index",u);for(var f in e.ellipseSettings){a.attr(f,e.ellipseSettings[f])}var l=a.attr("cx"),c=a.attr("cy"),h,p;if(u==0){h=l-.75*r;p=c}else{h=l+.75*r;p=c}var d=t.text(h,p,e.setLabels[u]).attr("font-size","10").attr("font-weight","bold");var v=d.getBBox();t.rect(v.x-4,v.y-2,v.width+8,v.height+4).attr("fill",e.backgroundColor).attr("stroke-width",0).toBack()}return o}function o(e,t,n){var r=.32*e.canvasWidth/2;var i=e.canvasWidth/2;var s=e.canvasHeight/2+r/3;var o=t.set();var u=[t.ellipse(i-r/2,s-.75*r,r,r),t.ellipse(i+r/2,s-.75*r,r,r),t.ellipse(i,s,r,r)];var a=[];for(var f in u){var l=u[f];o.push(l);l.attr("stroke",e.colors[f]).data("index",f);for(var c in e.ellipseSettings){l.attr(c,e.ellipseSettings[c])}var h=l.attr("cx"),p=l.attr("cy"),d,v;if(f==0){d=h-r/2;v=p-r/2}else if(f==1){d=h+r/2;v=p-r/2}else{d=h;v=p+.75*r}var m=t.text(d,v,e.setLabels[f]).attr("font-size","10").attr("font-weight","bold").toBack();var g=m.getBBox();var y=t.rect(g.x-4,g.y-2,g.width+8,g.height+4).attr("fill",e.backgroundColor).attr("stroke-width",0).toBack();o.push(m).push(y);a.push(t.set().push(m).push(y))}var b=o.getBBox();var w=b.x+b.width/2,E=b.y+b.height/2;o.rotate(90,w,E);for(var f in a){a[f].rotate(-90)}return u}function u(e,t,n){var r=.1*e.canvasWidth;var i=.25*e.canvasWidth;var s=1.6*i+r;var o=e.canvasHeight/2+1.25*r;var u=[t.ellipse(s+i,o,r,i).rotate(-70,s,o+i),t.ellipse(s+i,o,r,i).rotate(-65,s,o+i).translate(i/3,r/2),t.ellipse(s-i,o,r,i).rotate(65,s,o+i).translate(-i/3,r/2),t.ellipse(s-i,o,r,i).rotate(70,s,o+i)];for(var a in u){var f=u[a];f.attr("stroke",e.colors[a]).data("index",a);for(var l in e.ellipseSettings){f.attr(l,e.ellipseSettings[l])}var c=f.attr("cx");var h=f.attr("cy")-f.attr("ry")+20;var p,d;if(a==0||a==3){p=f.matrix.x(c,h),d=f.matrix.y(c,h)}else if(a==2){p=f.matrix.x(c,h)-30;d=f.matrix.y(c,h)-10}else if(a==1){p=f.matrix.x(c,h)+30;d=f.matrix.y(c,h)-10}var v=t.text(p,d,e.setLabels[a]).attr("font-size","10").attr("font-weight","bold").toBack();var m=v.getBBox();t.rect(m.x-4,m.y-2,m.width+8,m.height+4).attr("fill",e.backgroundColor).attr("stroke-width",0).toBack()}return u}function a(){var e=this.data("venn");var t=e.settings;var n="";var r=e.regions[n];if(t.disableClicks)return;r.toggleActive();if(t.shadeRegions){b(0,0,[],this)}this.trigger("regionClicked.venn",e.regions[n])}function f(e){var n=e.offsetX||e.layerX,r=e.offsetY||e.layerY;var i=this.data("venn");var s=i.set;var o=l(n,r,s);var u=t.getHashKey(o);if(i.settings.disableClicks)return;i.regions[u].toggleActive();if(i.settings.shadeRegions){b(n,r,o,this)}this.trigger("regionClicked.venn",i.regions[u])}function l(e,t,n){var r=[];for(var i=0;i<n.length;i++){if(h(e,t,n[i])){r.push(n[i])}}return r}function c(e,t,n){var r=n.attr("cx"),i=n.attr("cy"),s=n.attr("rx"),o=n.attr("ry");var u=n.matrix.invert().x(e,t),a=n.matrix.invert().y(e,t);var f=u-r,l=a-i;return f*f/(s*s)+l*l/(o*o)}function h(e,t,n){return c(e,t,n)<=1}function p(e,t,n){var r=Math.abs(c(e,t,n)-1);if(r<Math.abs(c(e-1,t,n)-1)&&r<Math.abs(c(e+1,t,n)-1)){return true}return false}function d(e,t,n){for(var r=0;r<n.length;r++){var i=n[r];if(p(e,t,i)){return r}}return null}function v(e,t,n){for(var r=0;r<n.length;r++){if(c(e,t,n[r])>1){return false}}return true}function m(e,t,n){for(var r=0;r<n.length;r++){if(c(e,t,n[r])<1){return true}}return false}function g(e,t){for(var n in e){if(e[n].data("index")==t.data("index")){return true}}return false}function y(e,t){var n=[];for(var r=0;r<e.length;r++){if(!g(t,e[r])){n.push(e[r])}}return n}function b(e,n,r,i){var s=t.getHashKey(r);var o=i.data("venn");var u=o.settings;var a=o.set;var f=o.bbox;var l=u.shadeSpacing;var c=o.paper;var h=y(a,r);if(!o.regions[s].isActive()){o.regions[s].unshade()}else if(r.length==0){o.universe.attr("fill",u.shadeColor).attr("fill-opacity",u.universeShadeOpacity)}else{var p=[];var g=[];var b=true;var w=[-l,l];for(var E in w){var l=w[E];var S=e,x=e,T=n;if(E>0){T+=l}if(p.length>0){S=g[0];x=g[0]}e:while(true){while(d(S-1,T,r)==null&&!m(S-1,T,h)){S--;if(S+10<f.x){break e}}while(d(x+1,T,r)==null&&!m(x+1,T,h)){x++;if(x-10>f.x+f.width){break e}}if(!v(S,T,r)||!v(x,T,r)||m(S,T,h)||m(x,T,h)){break e}p.push(c.path(Raphael.fullfill("M{startx},{starty}L{endx},{endy}",{startx:S,starty:T,endx:x,endy:T})).toBack());S=Math.floor((x+S)/2);g.push(S);x=S;T+=l}}o.regions[s].shade(p)}}function w(e,t){var n=t.data("venn");var r=n.regions;for(var i in r[e].shadingLines){r[e].shadingLines[i].remove()}}t.prototype.getHashKey=function(){return t.getHashKey(this.containedSets)};t.prototype.getArrayKey=function(){var e=[];for(var t=0;t<this.containedSets.length;t++){e.push(this.containedSets[t].data("index"))}return e.sort()};t.prototype.getId=function(){var e=this.settings.setLabels;var n=this.getArrayKey();return t.arrayKeyToRegionLabel(n,e)};t.prototype.isActive=function(){return this.active};t.prototype.toggleActive=function(){this.setActive(!this.isActive())};t.prototype.setActive=function(e){this.active=e};t.prototype.unshade=function(){if(this.containedSets.length==0){this.data.universe.attr("fill-opacity",0)}else{if(typeof this.shadingLines!="undefined"&&this.shadingLines!=null){for(var e in this.shadingLines){this.shadingLines[e].remove()}}this.shadingLines=null}};t.prototype.shade=function(e){this.shadingLines=e};t.prototype.union=function(e){var n=this.containedSets.slice();for(var r in e){n.push(e[r])}return new t(this.venn,n)};t.prototype.toString=function(){return this.getId()};t.prototype.getRepresentativeCoords=function(){return this.data.regionCoordinates[this.getHashKey()]};t.getHashKey=function(e){var t="";for(var n in e){t+=e[n].data("index")+","}return t};t.arrayKeyToRegionLabel=function(e,t){e=e.sort();var n="";for(var r=0;r<e.length;r++){n+=t[e[r]]}return n};var n={init:function(t){var n=e.extend({numSets:4,setLabels:["A","B","C","D"],universeLabel:"U",colors:["#f00","#0f0","#00f","#dd0"],backgroundColor:"#fff",borderColor:"#000",shadeRegions:true,shadeSpacing:3,shadeColor:"#000",universeShadeOpacity:.3,ellipseSettings:{fill:"#fff","fill-opacity":0,"stroke-width":2},initRegions:[],disableClicks:false,canvasWidth:"inherit",canvasHeight:"inherit",regionClicked:e.noop},t);if(n.canvasWidth=="inherit"){n.canvasWidth=this.width()}if(n.canvasHeight=="inherit"){n.canvasHeight=this.height()}var l=this;var c=Raphael(e(this)[0],n.canvasWidth,n.canvasHeight);var h;if(n.numSets==4){h=u(n,c,this)}else if(n.numSets==3){h=o(n,c,this)}else{h=s(n,c,this)}var p=c.set();for(var d in h){p.push(h[d])}var v=p.getBBox();var m=20;var g=c.rect(v.x-m,v.y-m,v.width+2*m,v.height+2*m).attr("fill",n.universeShadeOpacity).attr("fill-opacity",0).attr("stroke-width",1).toBack();c.text(g.attr("x")+g.attr("width")-m/2,g.attr("y")+g.attr("height")-10,n.universeLabel).attr("font-size","10").attr("font-weight","bold").toBack();p.click(function(e){f.apply(l,[e])});g.click(function(e){a.apply(l)});this.data("venn",{settings:n,paper:c,set:p,universe:g,bbox:v});var y=i(this,e.makeArray(p));var b={};for(var d in y){b[y[d].getHashKey()]=y[d]}this.data("venn").regionCoordinates=r.call(l);this.data("venn").regions=b;this.bind("regionClicked.venn",n.regionClicked);if(this.height()<n.canvasHeight){this.height(n.canvasHeight)}for(d in n.initRegions){this.venn("activateRegion",n.initRegions[d])}return this},activeRegions:function(){var e=[];var t=this.data("venn").regions;for(var n in t){if(t[n].isActive()){e.push(t[n])}}return e},activateRegion:function(e){var n=this.data("venn").settings;var r=this.data("venn").regions;if(typeof e=="object"){e=t.arrayKeyToRegionLabel(e,n.setLabels)}for(var i in r){if(e==r[i].getId()&&!r[i].isActive()){r[i].toggleActive();var s=r[i].getRepresentativeCoords();if(n.shadeRegions){b(s[0],s[1],r[i].containedSets,this)}break}}return this}};e.fn.venn=function(t){if(n[t]){return n[t].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof t=="object"||!t){return n.init.apply(this,arguments)}else{e.error("Method "+t+"does not exist on jQuery.venn!")}};})(jQuery);
