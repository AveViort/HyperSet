<!DOCTYPE html>
<HTML lang="en-US">
<HEAD>

<TITLE>Drug screen data analysis</TITLE>
<LINK href="pics/drugg/favicon.ico" rel="shortcut icon">
<link rel="apple-touch-icon" sizes="57x57" href="pics/drugg/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="pics/drugg/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="pics/drugg/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="pics/drugg/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="pics/drugg/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="pics/drugg/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="pics/drugg/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="pics/drugg/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="pics/drugg/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="pics/drugg/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="pics/drugg/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="pics/drugg/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="pics/drugg/favicon-16x16.png">
<link rel="manifest" href="pics/drugg/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="pics/drugg/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">

<meta http-equiv="content-type" content="charset=utf-8">
<META http-equiv="Content-Script-Type" content="application/javascript" >
<meta name="viewport" content="width=device-width, initial-scale=1">

<LINK href="hyperset.css" type="text/css" rel="stylesheet">
<LINK href="js/jquery-ui-themes-1.12.1/themes/pepper-grinder/jquery-ui.min.css" type="text/css" rel="stylesheet">
<LINK href="js/jquery-ui-themes-1.12.1/themes/pepper-grinder/jquery-ui-1.12.icon-font.min.css" type="text/css" rel="stylesheet">
<LINK href="js/qTip/jquery.qtip.min.css" type="text/css" rel="stylesheet">
<!--link href="js/Cytoscape.js/cytoscape-cytoscape.js-panzoom-c1dbe79/cytoscape.js-panzoom.css" rel="stylesheet" type="text/css" /-->
<!--link href="js/Cytoscape.js/cytoscape-cytoscape.js-panzoom-c1dbe79/font-awesome-4.0.3/css/font-awesome.css" rel="stylesheet" type="text/css" /-->
<link href="//cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css" rel="stylesheet" type="text/css">
<link href="//cdn.datatables.net/buttons/1.5.6/css/buttons.dataTables.min.css" rel="stylesheet" type="text/css">
<link href="//cdn.datatables.net/tabletools/2.2.3/css/dataTables.tableTools.css" rel="stylesheet" type="text/css">
<link href="//cdn.datatables.net/1.10.19/css/dataTables.jqueryui.min.css" type="text/css">
<link href="//cdn.datatables.net/responsive/1.0.4/css/dataTables.responsive.css" type="text/css">

<script src="js/jquery-3.3.1.min.js" type="text/javascript"></script>
<script src="js/jquery-ui-1.12.1.custom/jquery-ui.min.js" type="text/javascript"></script>
<script src="js/jquery-ui-contextmenu-master/jquery.ui-contextmenu.min.js" type="text/javascript"></script>  
<script src="js/jquery.form.js" type="text/javascript"></script> 
<script src="js/qTip/jquery.qtip.min.js" type="text/javascript"></script>
<script src="js/overlib.js" type="text/javascript"></script>

<script src="js/HS.js" type="text/javascript" charset="utf-8"></script>
<script src="js/drugs.js" type="text/javascript"></script>
<script src="js/cookies.js" type="text/javascript"></script>
<script src="js/DR_demo.js" type="text/javascript"></script>
<script src="js/druggable_config.js" type="text/javascript" charset="utf-8"></script>
<script src="js/tools.js" type="text/javascript" charset="utf-8"></script>
<script src="js/autotests.js" type="text/javascript" charset="utf-8"></script>
<script src="js/druggable_event_manager.js" type="text/javascript" charset="utf-8"></script>

<style>

li.tab ul {
  display: none;
  margin: 0;
  padding: 0;
  list-style: none;
  border: 1px solid #d5d5d5;
  border-radius: 0 0 3px 3px;
}

li.tab:hover ul li {
  color: #454545;
  margin: 0;
  background-color: #e9e9e9;
  padding: 4px 10px;
  cursor: pointer;
  border-bottom: 1px solid #d5d5d5;
}

li.tab:hover ul li:hover,
li.tab:hover ul li.active {
  background-color: #ffffff;
}

li.tab:hover ul {
  display: block;
  position: absolute;
  top: 100%;
  left: 0;
}

.ui-menu { width: 150px; }

.ui-dialog {
    padding: 0;
    margin: 0;
}

.ui-dialog .ui-dialog-content {
    padding: 0;
    margin: 0;
}

.footer {
  position: fixed;
  left: 0;
  bottom: 0;
  width: 100%;
  text-align: center;
}

.ui-menu-item {
	word-break: break-word;
}

.no-titlebar .ui-dialog-titlebar {
    display: none;
}

.dt-buttons {
  float:none;  
  text-align:left;
}
.dataTables_wrapper  {
  float:left;  
  text-align:left;
}

div.container {
        width: 75%;
    }

#cor_result_table thead th {
    padding: 0.5em 2em 0.5em 1em;
	}
	
#cor_result_table tbody td {
    padding: 0.5em 1.0em;
	}

span.adj-icon {
display: inline;
margin-right: 0.25em; 
margin-left: 1.0em;
}

.adj-icon:hover { 
	font-size: large;
}

.ui-button-icon-only {
border: 	none;
background: 	none;
}


/*.ui-tabs .ui-tabs-nav {    display: flex;}
.ui-tabs .ui-tabs-nav li {flex: 1; display: flex; white-space: normal;}*/
/* https://stackoverflow.com/questions/9222139/jquery-ui-tabs-width-100 If placed in a small width sidebar or something like that disabling nowrap will fix the overflow issue */

.ui-tabs .ui-tabs-panel {
	width: 99%;
	
.minimized_title {
font-size: x-small;
//display: inline;
display: block;
float: left;
}
}

table.simple_table td { 
//	border: 1px solid black; 
}

.sidebar {
  height: 100%; 
  width: 0; 
  position: fixed; 
  z-index: 1; 
  top: 0;
  right: 0;
  opacity: 0.65;
  /*background-color: #111; */
  overflow-x: auto; 
  padding-top: 60px; 
  transition: 0.5s; 
}

.sidebar a {
  padding: 8px 8px 8px 32px;
  text-decoration: none;
  font-size: 20px;
  color: #818181;
  display: block;
  word-break: break-word;
  transition: 0.3s;
}

.sidebar a:hover {
  color: #f1f1f1;
}

.sidebar .closebtn {
  position: absolute;
  top: 0;
  color: #111;
  right: 25px;
  font-size: 36px;
  margin-left: 50px;
}

@media screen and (max-height: 450px) {
  .sidebar {padding-top: 15px;}
  .sidebar a {font-size: 18px;}
}
</style>
</HEAD>

<BODY class="ui-state-default ui-corner-all">
<div class="xmlhttp_header"></div>
<h1 class="main_header ui-widget-header ui-corner-all">Druggable</h1>
<p class="main_header" style="background-color: #eeeeee; font-size: large;">Molecular data &mdash; global interaction network &mdash; drug response</p>
<div id="progressbar" style="display: inline-block; width: 40%;"></div>
<div  style="display: inline; width: 35%;">
	<table>
		<tr>
			<td>
				<div id="demo-1">
					<span class=" clickable demo_button sbm-controls" onclick="dr_demo1('TCGA', 'BRCA', 'all', 'PE', 'rppa', 'TP53_gene', 'linear', 'NEA_MUT', 'z_maf', 'vantveer_breast_cancer_poor_prognosis',  'linear', 'scatter')" title="A quick demo for 2d plot from protein expression vs. enrichment scores.<br>Note that this is a real-time execution. Hence for robustness it is recommended to let it running without extra interference.">Demo "2D"</span>
				</div>
			</td>
			<td>
				<div id="demo-3">
					<span class=" clickable demo_button sbm-controls" onclick="dr_demo3 ('CCLE', 'GE', 'all', 'all', 'TP53BP2', 0.015, 1)" title="Correlation between cell line response to alisertib and a gene expression.<br>Note that this is a real-time execution. Hence for robustness it is recommended to let it running without extra interference.">Demo "gene X drug"</span>
				</div>
			</td>
			<td>
				<div id="demo-2">
					<span class=" clickable demo_button sbm-controls" onclick="dr_demo2 ('CCLE', 'GE', 'RNAseq', 'GDSC2', 'tamoxifen', 0.05, 548)" title="Correlation between a gene expression and senstivity to tamoxifen was first discovered in cell lines. Then  it was validated in breast cancer TCGA cohort: survival of tamoxifen-treated patients depended on expression of the same gene.">Demo "survival"</span>
				</div>
			</td>
			<td>
				<div id="demo-4">
					<span class=" clickable demo_button sbm-controls" onclick="dr_demo4 ('glmnet', 'TCGA', 'SKCM', ['06'], 'CLIN', 'os', '', ['GE', 'IMMUNO'], ['illuminahiseq_rnaseqv2','macrophages_m0'], ['TP53, MYC, MYCN, BRAF', ''], 'cox', 'deviance', false, 1, 10, 0.01, true, 3, 50)" title="Demo - using expression data for several genes and M0 macrophage count to predict overall survival time in cutaneous and malignant skin melanoma (SKCM) TCGA cohort.">Demo "predictive models"</span>
				</div>
			</td>
			<td>
				<button id="dock-button" onclick=open_dock()>Plots history</button>
			</td>
		</tr>
	</table>
</div>

<div id="demoComment" style="display: none; visibility: hidden">
	<div id="commentSection"></div>
</div>

<div id="cookiewarning">
	<div role="alert" class="ui-widget-header ui-corner-all" style=" margin: 5px; padding: 5px;">
	<p style="width: 95%; height: 60px; display: block; text-align: right; margin: 5px; padding: 5px;">This website uses cookies. To learn more about our cookie policy, click <a class="clickable" style="color: #e17009" href="https://dev.evinet.org/help/faq-evi/dr-faq.html#security">here</a>
	  <br>  <br>
	  <button type="button" id="ackcookies" class="ui-widget-header ui-corner-all" style="vertical-align: middle; align: right;" onclick="acceptCookies()">Ok</button>
	  </p>
	</div>	
</div>

<div id="sidebar_dock" class="sidebar  ui-widget ui-widget-content">
	<div>
		<a href="javascript:void(0)" class="closebtn" onclick="close_dock()">&times;</a>
		<table id="sidebar_table"  class="cell-border compact stripe" style="font-size: x-small; width: 100%;">
			<thead>
				<th>Type</th>
				<th>Cohort</th>
				<th>Samples</th>
				<th>N</th>
				<th>X</th>
				<th>Y</th>
				<th>Z</th>
				<th>Time, GMT</th>
				<th></th>
				<th></th>
				<th></th>
			</thead>
		</table></div>
	</div>
</div>
	
<div id="tabs" "width: 99%;">
	<ul>
		<li><a href="#tab-home">Introduction</a></li>
		<li><a href="#tab-signif">Correlates of drug response</a></li>
		<li><a href="#tab-lookup">Data exploration</a></li>
		<li><a href="#tab-predict">Multidimensional models</a></li>
	</ul>
	
	<div id="tab-home">
		<div style="display: inline-block; width: 80%;"><p>Druggable supports simple user requests regarding correlation of molecular profiles in large scale datasets.  This may be helpful in a range of contexts, from evaluating agreement between omics platforms to identifying potential markers of drug response.<p></p>
			<p>The data from major public resources, <a  target="_blank" class="clickable" href="https://www.cancer.gov/about-nci/organization/ccg/research/structural-genomics/tcga/studied-cancers">The Cancer Genome Atlas</a> and <a target="_blank" class="clickable" href="https://portals.broadinstitute.org/ccle/">The Cancer Cell Line Encyclopedia</a> can be either explored as plots of gene, protein, and drug sensitivity profiles or help in identifying correlates of response to anti-cancer drugs. Furthermore, such correlaions can be traced to clinical treatment profiles in TCGA. An extra feature of Druggable is network context. This is instrumental in both <a target="_blank" class="clickable" href="https://doi.org/10.1038/s41598-019-39019-2">biomarker discovery</a> and evaluation of candidate molecules in the <a target="_blank" class="clickable" href="https://doi.org/10.1093/nar/gky485">network context</a>.
			</p>
			
			<br>
			<button id="help_table_toggle" onclick="toggle_help_table()">Show available data</button>
			<table id="help_data_sources" class="simple_table" class="inputarea inputareahighlight ui-corner-all"  style="font-size: small; width: 100%; border-collapse: collapse; ">	
			</table>
			<br>
		</div>
		<div id="table-help-menu" style="display: inline;">
			<span  id="help-qtip" style="float: right; margin-right: 4em; margin-left: 1em;  font-size: 250%; color: #c00;" class="ui-icon ui-icon-circle-help" title="Help, FAQ, publications" onclick="openDialog('help-dialog-dr');">icon</span>
		</div>
	</div>
	
	<div id="help-dialog-dr">
		<div id="help-tabs-dr">

			<ul>
				<li><a href="#help-tab-faq">FAQ</a></li>
				<li><a href="#help-tab-demo">Demo</a></li>
				<li><a href="#help-tab-comp">Compatibility</a></li>
				<li><a href="#help-tab-rest">REST API</a></li>
				<li><a href="#help-tab-citation">Citation</a></li>
				<li><a href="#help-tab-version">Version</a></li>
			</ul>
			
			<div id="help-tab-faq">
				<p>
					Refer to this page to get answers to your questions and instructions for some typical tasks.
				</p>
				<br>
				<a target="_blank" href="help/faq-evi/dr-faq.html" class="clickable">Open as new page<span style="float: left; margin-right: 2.5em;" class="ui-icon ui-icon-file-richtext" >icon</span></a> 
			</div>
			
			<div id="help-tab-demo">
				<span class=" clickable demo_button sbm-controls" onclick="dr_demo1('TCGA', 'BRCA', 'all', 'PE', 'rppa', 'TP53_gene', 'linear', 'NEA_MUT', 'z_maf', 'vantveer_breast_cancer_poor_prognosis',  'linear', 'scatter')" title="A quick demo for 2d plot from protein expression vs. enrichment scores.<br>Note that this is a real-time execution. Hence for robustness it is recommended to let it running without extra interference.">Demo "2D"</span>
				<br>
				<span class=" clickable demo_button sbm-controls" onclick="dr_demo3('CCLE', 'GE', 'all', 'all', 'TP53BP2', 0.015, 1)" title="Correlation between cell line response to alisertib and a gene expression.<br>Note that this is a real-time execution. Hence for robustness it is recommended to let it running without extra interference.">Demo "gene X drug"</span>
				<br>
				<span class=" clickable demo_button sbm-controls" onclick="dr_demo2('CCLE', 'GE', 'RNAseq', 'GDSC2', 'tamoxifen', 0.05, 1745)" title="Correlation between a gene expression and senstivity to tamoxifen was first discovered in cell lines. Then  it was validated in breast cancer TCGA cohort: survival of tamoxifen-treated patients depended on expression of the same gene.">Demo "survival"</span>
			</div>
		
			<div id="help-tab-comp">
				Known compatibility issues:
				<br>
				This site best works with Google Chrome <span style="color: #00aa00;">(v. 71 or later)</span> and Mozilla Firefox <span style="color: #00aa00;">(v. 60 or later)</span>. It is also compatible with Edge.
				<br>Some functions <span style="color: #ee3333;">do not work with IE 11</span>.
				<br>The site also works with Apple Safari (v. 12.1, macOS Mojave v10.14.6), other versions of Safari browser can have compatibility issues.
			</div>
			
			<div id="help-tab-rest">
				<p>
					Druggable offers REST API for all functional tabs. Some functions, such as batch jobs, are available only via REST API. All scripts are accessible through https://www.evinet.org/cgi/<i>script_name</i>.
				</p>
				<br>
				<b>Retrieving correlations</b>
				<br>
				<p>
					<b>Script name:</b> cor_datatables_json.cgi<br>
					<b>Returns:</b> correlations in JSON format<br>
					<b>Parameters:</b><br>
						<i>source</i>: mandatory, correlation source (TCGA/CCLE);<br>
						<i>datatype</i>: mandatory, data type (e.g. GE, COPY...). Can be set to 'all';<br>
						<i>cohort</i>: mandatory, data cohort, can be set to 'all' for TCGA, must be set to 'all' for CCLE;<br>
						<i>platform</i>: mandatory, correlaion platform (e.g. Agilent), can be set to 'all';<br>
						<i>screen</i>: mandatory, correlation screen (e.g. GDSC1), can be set to 'all' for CCLE, must be set to 'all' for TCGA;</br>
						<i>id</i>: mandatory, gene/protein/pathway/drug name;<br>
						<i>fdr</i>: mandatory, FDR, use dot as delimeter;<br>
						<i>mindrug</i>: mandatory, minimal number of samples treated with drug;<br>
						<i>columns</i>: mandatory, list of columns to retrieve from SQL:<br>
							<i>	for CCLE</i>: gene,feature,ancova_p_1x,ancova_p_2x_cov1,ancova_p_2x_feature,ancova_q_2x_feature,ancova_q_2x_feature<br>
							<i>	for TCGA</i>: gene,feature,followup_part,interaction,drug,expr,n_patients,n_treated,followup,q<br>
					<b>Example:</b> https://www.evinet.org/cgi/cor_datatables_json.cgi?source=CCLE&datatype=GE&cohort=all&platform=RNAseq&screen=GDSC2&id=gemcitabine&fdr=0.01&mindrug=10&columns=gene,feature,ancova_p_1x,ancova_p_2x_cov1,ancova_p_2x_feature,ancova_q_2x_feature,ancova_q_2x_feature&_=1614857799773<br>
				</p>
				<br>
				<b>Creating plots</b>
				<br>
				<p>
					<b>Script name:</b> rplot.cgi<br>
					<b>Returns:</b> plot file name<br>
					<b>Parameters:</b><br>
						<i>type</i>: mandatory, plot type (e.g. scatter);<br>
						<i>source</i>: mandatory, data source (TCGA or CCLE);<br>
						<i>cohort</i>: mandatory, used cohort;<br>
						<i>datatypes</i>: mandatory, list of datatypes spearated by commas;<br>
						<i>platforms</i>: mandatory, list of platforms separated by commas;<br>
						<i>ids</i>: mandatory, list of genes/antibodies/pathways/drugs names, must match length of datatypes/platforms, if platform has no id - id should be skipped (e.g. 'tp53,,mdm2');<br>
						<i>codes</i>: mandatory, TCGA codes (01, 06...) or metacodes (all, healthy...) for TCGA, 'all' or tissue name for CCLE;<br>
						<i>scales</i>: mandatory for the most types of plots, axis scales (linear...).<br>
					<b>Example:</b> https://www.evinet.org/cgi/rplot.cgi?type=bar&source=TCGA&cohort=BRCA&datatypes=CLIN&platforms=vital_status&ids=%2C&codes=&scales=<br>
					<b>Usage tips:</b>This script can return either an html page (plotly plots, for the majority of plot types) or png image (for Venn diagrams).<br>
				</p>
				<br>
				<b>Creating models</b>
				<br>
				<p>
					<b>Script name:</b> model_predict.cgi<br>
					<b>Returns:</b> model name (without any file extenstions)<br>
					<b>Parameters:</b><br>
						<i>method</i>: mandatory, method for creating models, at the moment only 'glmnet' is supported;<br>
						<i>source</i>: mandatory, data source for model creation (TCGA/CCLE);<br>
						<i>cohort</i>: mandatory, cohort for model creation;<br>
						<i>multiopt</i>: mandatory, TCGA codes or metacodes (for TCGA) or CCLE tissues;<br>
						<i>xdatatypes</i>: mandatory, comma-separated list of data types for independent variables;<br>
						<i>xplatforms</i>: mandatory, comma-separated list of platforms for independent variables;<br>
						<i>xids</i>: mandatory, lists of ids (if applicable) for independent variables, empty space if ids do not exist for the chosen platforms (refer to the examples for format);<br>
						<i>rdatatype</i>: mandatory, datatype for independent (response) variable;<br>
						<i>rplatform</i>: mandatory, platform for independent (response) variable;<br>
						<i>rid</i>: mandatory, response variable id (if applicable, otherwise empty);<br>
						<i>family</i>: mandatory for glmnet, glmnet family (gaussian/cox...), refer to glmnet documentation for further explanation;<br>
						<i>measure</i>: mandatory for glmnet with cross-validation, which loss should be used to pick the best model, refer to glmnet documentation;<br>
						<i>alpha</i>: mandatory for glmnet, mixing parameter describing balance between lasso and ridge regression (1 - lasso, 0 - ridge);<br>
						<i>nlambda</i>: mandatory for glmnet, number of lambda values, refer to glmnet documentation;<br>
						<i>minlambda</i>: mandatory for glmnet, min lambda value, refer to glmnet documentation;<br>
						<i>validation</i>: mandatory, if cross-validation should be used (binary flag);<br>
						<i>validation_fraction</i>: mandatory for glmnet with <i>validation</i> flag set to <i>TRUE</i>, numeric, defines share of records to be used for independent validation, use dot as decimal separator;<br>
						<i>nfolds</i>: mandatory for glmnet with <i>validation</i> flag set to <i>TRUE</i>, number of folds for N-folds cross-validation (see <i>cv.glmnet</i> in glmnet documentation);<br>
						<i>standardize</i>: mandatory for glmnet, if variables should be standardized (binary flag);<br>
						<i>stat_file</i>: mandatory, filename to which performance metrics should be saved (use <i>auto</i> to automatically assign the name - see the table below);<br>
						<i>extended_output</i>: mandatory, if model creation parameters should be saved to the specified <i>stat_file</i>;<br>
						<i>header</i>: mandatory, if specified <i>stat_file</i> should have header; recommended to be set to true. You can collect information on many models in one file, in this case specify this parameter as true only for the first query and make sure that all models belong to the same family and <i>validation</i> option is always the same - so columns are the same (also, <i>extended_output</i> should be set the same for all the models).<br>
					<b>Example:</b> https://www.evinet.org/cgi/model_predict.cgi?method=glmnet&source=TCGA&cohort=BRCA&rdatatype=GE&rplatform=illuminahiseq_rnaseq&rid=TP53&xdatatypes=GE&xplatforms=illuminahiseq_rnaseq&xids=%5BA1CF%7CA2BP1%7CA4GALT%7CA4GNT%7CAAA1%7CAADAC%7CAADACL2%7CAADACL3%7CAADACL4%7CAADAT%7CAAK1%7CAANAT%7CAARS2%7CAASS%7CABCA4%7CABI2%7CABP1%7CABR%7CACAA1%7CACAN%7CACTA1%7CACTN1%7CADA%7CADAM7%7CADAP1%7CADAT2%7CADAT3%7CAFM%7CAGBL4%7CAHDC1%7CFOXA2%7CFOXB2%7CBCL2%7CTGFBI%7CTGFBRAP1%7CPTGFR%7CARID1A%7CARID1B%7CARID2%7CARID3B%7CARID4A%7CARID4B%7CCACNA1B%7CCACNA1C%7CCACNA2D1%7CCACNA2D2%7CCACNG2%7CCACNA2D4%7CCACNG3%7CCACNG4%7CCACNG7%7CCACNG8%7CVEGFC%7CHRAS%7CKRAS%7CNRAS%7CPDGFA%7CPDGFC%7CPDGFD%7CMDM1%7CMDM2%7CRBL1%7CRBL2%7CRBP1%7CCTRB1%7CPRB1%5D&multiopt=cancer&family=gaussian&measure=deviance&standardize=false&alpha=0.5&nlambda=10&minlambda=0.01&validation=true&nfolds=10&validation_fraction=0.1&stat_file=auto&extended_output=false&header=true<br>
					<b>Usage tips:</b> Using just model name, you can access graphical interpretation of the created model, RData model file, coefficients (in JSON format) and performance metrics (in JSON and csv format). If you have received value 'model578045416464' from the script, you can access the following files in https://www.evinet.org/pics/plots/ :<br>
					<table>
						<thead>
							<tr>
								<th>File name</th>
								<th>Meaning</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>model578045416464.RData</td>
								<td>glmnet model for R environment</td>
							</tr>
							<tr>
								<td>coeff.model578045416464.json</td>
								<td>Model coefficients (with weights) in JSON format</td>
							</tr>
							<tr>
								<td>model578045416464_model.png</td>
								<td>Graphical abstract of the created model</td>
							</tr>
							<tr>
								<td>model578045416464_training.png</td>
								<td>Graphical abstract on training step</td>
							</tr>
							<tr>
								<td>model578045416464_validation.png</td>
								<td>Graphical abstract on validation step (if set)</td>
							</tr>
							<tr>
								<td>model578045416464.csv</td>
								<td>Performance metrics and some additional information in csv format with header</td>
							</tr>
							<tr>
								<td>perf.model578045416464.json</td>
								<td>Performance metrics in JSON format</td>
							</tr>
						</tbody>
					</table>
					<br>
				</p>
				<br>
				<b>Batch models creation</b>
				<p>
					<b>Script name:</b> models_from_correlations_batch.cgi<br>
					<b>Returns:</b> error or nothing ('done' returned only after all models are created, so don't use synchronous calls with it, link with the results will be sent to the specified email)<br>
					<b>Parameters:</b><br>
						<i>source</i>: mandatory, data source (TCGA/CCLE) for both correlation retrieval and model creation;<br>
						<i>datatype</i>: mandatory, same as <i>datatype</i> for <i>cor_datatables_json.cgi</i>; however, several comma-separated values are allowed, number should be the same as number of predictor types;<br>
						<i>cohort</i>: mandatory, same as <i>cohort</i> for <i>cor_datatables_json.cgi</i>; may be a comma-separated list, length matches with <i>datatype</i> parameter list;<br>
						<i>screen</i>: mandatory, same as <i>screen</i> for <i>cor_datatables_json.cgi</i>; similar to <i>datatype</i> and <i>cohort</i> may be a list;<br>
						<i>id</i>: mandatory, same as <i>id</i> for <i>cor_datatables_json.cgi</i>; similar to previous parameters;<br>
						<i>fdr</i>: mandatory, same as <i>fdr</i> for <i>cor_datatables_json.cgi</i>; similar to previous parameters;<br>
						<i>mindrug</i>: mandatory, same as <i>mindrug</i> for <i>cor_datatables_json.cgi</i>; unlike previous parameters, this one is always a single value;<br>
						<i>columns</i>: mandatory, same as <i>columns</i> for <i>cor_datatables_json.cgi</i>;<br>
						<i>method</i>: mandatory, same as <i>method</i> for <i>model_predict.cgi</i>;<br>
						<i>model_cohort</i>: mandatory, same as <i>cohort</i> for <i>model_predict.cgi</i>;<br>
						<i>multiopt</i>: mandatory, same as <i>multiopt</i> for <i>model_predict.cgi</i>;<br>
						<i>xdatatypes</i>: mandatory, same as <i>xdatatypes</i> for <i>model_predict.cgi</i>;<br>
						<i>xplatforms</i>: mandatory, same as <i>xplatforms</i> for <i>model_predict.cgi</i>;<br>
						<i>additional_xids</i>: optional, specifies which ids should be passed to glmnet even if they do not suffice filters; recommended, if no additional xids - leave blank;<br>
						<i>rdatatype</i>: mandatory, same as <i>rdatatype</i> for <i>model_predict.cgi</i>;<br>
						<i>rplatform</i>: mandatory, same as <i>rplatform</i> for <i>model_predict.cgi</i>;<br>
						<i>rid</i>: mandatory, same as <i>rid</i> for <i>model_predict.cgi</i>;<br>
						<i>family</i>: mandatory for glmnet, same as <i>family</i> for <i>model_predict.cgi</i>;<br>
						<i>measure</i>: mandatory for glmnet, same as <i>measure</i> for <i>model_predict.cgi</i>;<br>
						<i>alpha</i>: mandatory for glmnet, same as <i>alpha</i> for <i>model_predict.cgi</i>;<br>
						<i>nlambda</i>: mandatory for glmnet, same as <i>nlambda</i> for <i>model_predict.cgi</i>;<br>
						<i>minlambda</i>: mandatory for glmnet, same as <i>minlambda</i> for <i>model_predict.cgi</i>;<br>
						<i>validation</i>: mandatory, same as <i>validation</i> for <i>model_predict.cgi</i>;<br>
						<i>validation_fraction</i>: mandatory for glmnet with <i>validation</i> flag set to <i>TRUE</i>, same as <i>validation_fraction</i> for <i>model_predict.cgi</i>;<br>
						<i>nfolds</i>: mandatory for glmnet with <i>validation</i> flag set to <i>TRUE</i>, same as <i>nfolds</i> for <i>model_predict.cgi</i>;<br>
						<i>standardize</i>: mandatory, same as <i>standardize</i> for <i>model_predict.cgi</i>;<br>
						<i>iter</i>: mandatory, desired number of models;<br>
						<i>stat_file</i>: mandatory, name of the file without extenstion to save your data in (try to give a unique name to your stat_file);<br>
						<i>extended_output</i>: mandatory, binary flag, if set to <i>TRUE</i> - some additional info will be written into <i>stat_file</i> (such as <i>source</i>, <i>rdatatype</i> etc.);<br>
						<i>mail</i>: mandatory, provide the correct email, links with the results will be sent to it when your batch job is done;<br>
					<b>Example:</b> https://dev.evinet.org/cgi/models_from_correlations_batch.cgi?source=TCGA&datatype=GE&cohort=LUAD&platform=all&screen=all&id=gemcitabine&fdr=0.05&mindrug=10&columns=gene,feature,followup_part,interaction,drug,expr,n_patients,n_treated,followup,q&iter=3&model_cohort=LUAD;method=glmnet&rdatatype=CLIN&rplatform=os&xdatatypes=GE&xplatforms=illuminahiseq_rnaseqv2&additional_xids=&multiopt=01&family=cox&measure=deviance&standardize=false&alpha=1&nlambda=10&minlambda=0.01&validation=true&nfolds=10&validation_fraction=0.1&stat_file=/your_file/&mail=/your_email/<br>
					<b>Usage tips:</b> Always try to specify a unique name for your output file! Files are created in the append mode, so if you (or someone) has used the specified file name before - you will get "mixed" results! When the job is done, the reults will be available in file https://www.evinet.org/pics/plots/your_file.csv<br>
				</p>
				<br>
				<b>Using JS API</b>
				<br>
				<p>
					All the aforementioned functions are available through API specified in <i>drugs.js</i> module. Some parameters (like <i>columns</i>) are specified in <i>druggable_config.js</i>.
				</p>
				<br>
				<b>Datatypes, platforms and screens</b>
				<br>
				<p>
				Below you can find valid names of datatypes, platforms, variables to use with REST API.<br> 
				</p>
				<a href="https://dev.evinet.org/help/platforms_data/all_datatypes.txt" target="_blank">Datatypes</a><br>
				<a href="https://dev.evinet.org/help/platforms_data/all_platforms.txt" target="_blank">Platforms</a><br>
				<a href="https://dev.evinet.org/help/platforms_data/all_predictors.txt" target="_blank">Independent variables</a><br>
				<a href="https://dev.evinet.org/help/platforms_data/all_responses.txt" target="_blank">Dependent variables</a><br>
			</div>
			
			<div id="help-tab-citation">
				<b>Network-based biomarker discovery and validation:</b>
				<p>
					Marcela Franco, Ashwini Jeggari, Sylvain Peuget, Franziska B&ouml;ttger, Galina Selivanova, Andrey Alexeyenko
					<span class="highlighted" style="color: #c00;">Prediction of response to anti-cancer drugs becomes robust via network integration of molecular data</span>
					<b><i>Sci Rep</i></b> 9, 2379 (2019) <a class="clickable" href="https://doi.org/10.1038/s41598-019-39019-2">doi: 10.1186/1471-2105-13-226</a>.
				</p>
				<b>EviNet web resource:</b>
				<p>
					Ashwini Jeggari, Zhanna Alekseenko, José Dias, Johan Ericson, and Andrey Alexeyenko <span class="highlighted" style="color: #c00;">EviNet: a web platform for network enrichment analysis with flexible definition of gene sets</span> <b><i>Nucleic Acids Res</i></b> 2018 Jul 2;46(W1):W163-W170. <a class="clickable" href="https://doi.org/10.1093/nar/gky485">doi: 10.1002/1878-0261.12350</a>.
				</p>
			</div>
			
			<div id="help-tab-version">
				Version history:
				<br>
				1.0.0 (25th of March, 2020) - stable release: exploring correlations, creating and sharing plots, creating and downloading predictive models.
				<br>
				1.1.0 (8th of April, 2021) - stable release: improved functionality, model comparisson.
			</div>
		</div>
	</div>

	<div id="tab-signif" style="font-size: small;">
		<div class="inputarea inputareahighlight ui-corner-all" >
			<select name="corSource_selector" id="corSource_selector" class="ui-helper" style="width: 40ch;" ></select>
			<select name="corDatatype_selector" id="corDatatype_selector" class="ui-helper" style=" width: 40ch;" ></select>
			<select name="corCohort_selector" id="corCohort_selector" class="ui-helper" style=" width: 40ch;" ></select>
			<select name="corPlatform_selector" id="corPlatform_selector" class="ui-helper" style=" width: 40ch;" ></select>
			<select name="corScreen_selector" id="corScreen_selector" class="ui-helper" style="width: 40ch;" ></select>
					
			<table id="select_layout" style="display: inline;">
				<tr>
					<td>
						<input name="corGeneFeature_input" id="corGeneFeature_input" placeholder="Gene or drug name"  style="width: 20ch;">
					</td>
					<td>
						<input type="number" name="FDR_input" id="FDR_input"  min="0.001" max="1" value="0.05" step="0.001"  style="width: 10ch;">
					<td>
						<button type="submit" id="retrieve-cor-button" name="retrieve-cor-button" onclick = retrieve_correlations() style="width: 150; visibility: visible;">Retrieve correlations</button>
					</td>
				</tr>
			</table>
		</div>	
		<br>
		<div class="container2">
			<table id="cor_result_table" class="display ui-state-default ui-corner-all" style="font-size: x-small; width: 100%;">
			</table>
		</div>
	</div>
	
	<div id="tab-lookup"  style="font-size: small; ">			
		<table class="table-upper" style="float: left; width: 99%;">
			<tr>
				<td class="td-left" style="width: 1%;">
					<div id="plot-options-filters">
						<table>
							<tr>
								<th>Source</th>
								<th>Cohort</th>
								<th>Code</th>
							</tr>
							<tr>
								<td>
									<div id="source_selector-wrapper">
										<select id="source_selector" class="ui-helper" style="width: 40ch;">
									</div>
								</td>
								<td>
									<div id="cohort_selector-wrapper">
										<select id="cohort_selector" class="ui-helper" style="width: 40ch;">
									</div>
								</td>
								<td>
									<select id="tcga_selector" class="ui-helper" style="width: 10ch;">
								</td>
							</tr>
						</table>
						<br>
			
						<div class="inputarea inputareahighlight ui-corner-all">
							<table id="plot_options">
								<tr>
									<th>Data type</th>
									<th>Platform</th>
									<th>ID</th>
									<th></th>
									<th></th>
									<th>Scale</th>
								</tr>
								<tr id="plot_options_row1">
									<td>
										<select id="type1_selector" class="ui-helper" style="width: auto;">
									</td>
									<td>
										<select id="platform1_selector" class="ui-helper" style="width: auto;">
									</td>
									<td>
										<input id="id1_input"  class="ui-corner-all" onkeyup="id_keyup(1)" onchange = "id_keyup(1)">
										<input id="id1_confirmed"  class="ui-corner-all" disabled>
										<button id="open_info1" onclick="open_info_page(1)">Info</button>
									</td>
									<td>
										<select id="axis1_selector" class="ui-helper" style="width: auto;">
									</td>
									<td>
										<button id="add_row1" onclick="add_plot_options_row(1)">+</button>
									</td>
									<td>
										<button id="delete_row1" onclick="delete_plot_options_row(1)">-</button>
									</td>
								</tr>
							</table>
						</div>
					</div>

					<table>
						<tr>
							<td>
								<select id="plot-type">
							</td>
							<td>
								<div id="plot-button-wrapper">
									<button id="plot-button" onclick="plot()">Plot</button>
								</div>
							</td>
						</tr>
					</table>
				</td>
			</tr>
		</table>
	</div>
	
	<div id="tab-predict" style="font-size: small;">
	<div>
		<!--table id="all_parameters" style="border-width: 2px; height: 150px; margin:10px"-->
		<table id="all_parameters" class="inputarea inputareahighlight ui-corner-all"  style="font-size: small; width: 80%; border-collapse: collapse;">
			<tr id="r-1">
							<td id="d-top" rowspan="4">
					<table id="table-top" class="inputarea inputareahighlight ui-corner-all" style="box-shadow: none; border: none; width: 100%; ">
						<tr>
							<td>
								Source
								<select id="modelSource_selector">
							</td>
							</tr><tr>
							<td>
								Cohort
								<select id="modelCohort_selector">
							</td>
							</tr><tr>
							<td>
							Samples<br>
								<select multiple id="responseMulti_selector" class="ui-corner-all">
							</td>
						</tr>
					</table>
				</td>
				<td id="d-glmnet" rowspan="4" class="inputarea inputareahighlight ui-corner-all" style="box-shadow: none;">
					<table id="table-glmnet" style="border-collapse: collapse;">
						<tr>
							<td  colspan="2" style="text-align: center;">
								<span  class="subheader">GLMnet parameters</span>
							</td>
						</tr>
						<tr class="parameter_section" title="Set all variables on the same scale">
							<span ><td>Standardize
							</td>
							<td>
								<input type="checkbox" id="standardize" class="alternative_input venn_box_control ui-corner-all"> 
							</td>
						</span></tr>
						<tr class="parameter_section" title="Relative influence of lasso (few variables, strong coefficients) vs. ridge (many variables, close-to-zero coefficients allowed) approaches\nAlpha=0: pure ridge\nAlpha=1: pure lasso">
							<td>Alpha
							</td>
							<td>
								<input type="number" id="alpha" class="spinNumber ui-corner-all" min=0 max=1 step=0.01 value=1> 
							</td>
						</tr>
						<tr class="parameter_section" title="Determines the number of steps to find the optimum">
							<td>No. of lambda steps
							</td>
							<td>
								<input type="number" id="nlambda" class="spinNumber ui-corner-all" min=5 max=100 step=1 value=10> 
							</td>
						</tr>
						<tr class="parameter_section" title="Depends on sample size relative to the number of variables. Set automatically">
							<td>Lambda min ratio 
							</td>
							<td>
								<input type="text" id="minlambda" class="alternative_input venn_box_control ui-corner-all" value="0.01" disabled title="Parameter is fixed"> 
							</td>
						</tr>
						<tr  class="parameter_section" title="Should correspond to distributions of the dependent variable">
							<td>Family
							</td>
							<td>
								<select id="family"></select>
							</td>
						</tr>
						<tr>
							<td>
								<tr>
									<td colspan="2">
										
										<!--div id="crossval_ctrls" class="ui-widget ui-widget-content ui-corner-all" class="inputarea inputareahighlight ui-corner-all"-->
										<div id="crossval_ctrls"  class="parameter_section">
										<input type="checkbox" id="crossval" class="alternative_input venn_box_control">	
										<span class="subheader">Model validation</span>
											<table id="crossval_table" >
												<tr>
													<td title="Partitioning of the dataset into train ing and test fractions. The minimal 3-fold value means 2/3 used for training while 1/3 for testing. Can be as large as the sample size (leave-one-out cross-validation),">
														No. of folds for cross-validation
													</td>
													<td>
														<input type="number" id="nfold" class="Validation spinNumber ui-corner-all" step=1 value=10> 
													</td>
												</tr>		
												<tr>
													<td title="Regardless of the N-fold cross-validation above (which might repeatedly involve each sample into the training), this option retains a fraction of the dataset exclusively for testing at the final step">
														Final test set
													</td>
													<td>
														<input type="number" id="crossval_perc" class="Validation spinNumber ui-corner-all" min=0 step=1 value=50>%
													</td>
												</tr>
											</table>
										</div>
									</td>
								</tr>
							</td>
						</tr>
					</table>
				</td>

			</tr>
			<tr id="r-response">
				<td id="d-response" colspan="3">
					<table id="table-response" class="inputarea  ui-corner-all" style="box-shadow: none; width: 100%;">
						<tr>
							<td>
							<span class="subheader">Dependent variable</span>
							</td>
							</tr>
							<tr>
							<td title="Data type">
							<span class="text-content">Data type</span><br>
								<select id="responseDatatype_selector">
							</td>
							<td>
							<span class="text-content">Platform</span><br>
								<select id="responseVariable_selector">
							</td>
							<td>
								<span class="text-content">ID</span><br>
								<input id="responseID_input" class="ui-corner-all">
							</td>
						</tr>
					</table>
				</td>
			</tr>		
			<tr id="r-2buttons">
				<td id="d-2buttons" colspan="3" class="inputarea inputareahighlight ui-corner-all" style="box-shadow: none; width: 100%;">
					<div>
					<div class="subheader" style="float: left; margin-top: 0.20em; margin-right: 1.33em; margin-bottom: 0.33em; margin-left: 0.75em;">Independent variables</div>
					<div id="div-2buttons" >
						<button id="add_variable" onclick="add_model_options_row();" title="Add another type of predictor variables">+</button>
						<button id="delete_variable" onclick="delete_model_options_row(); " title="Remove the last type of predictor variables">-</button>
					</div>
					</div>

					<table >			
						<tr id="r-x"></tr>
					</table>
				</td>
			</tr>
		</table>
		<button id="build_model_button" class="inputarea inputareahighlight ui-button ui-corner-all ui-widget" onclick="build_and_show_model()">Build model</button>
		<button id="show_clipboard_button" class="inputarea inputareahighlight ui-button ui-corner-all ui-widget" onclick="show_transfer_buffer_window('#tab-predict')">Show IDs clipboard</button>
		<button id="show_comparison_preview_button" class="inputarea inputareahighlight ui-button ui-corner-all ui-widget" onclick="show_compare_window()">Models to compare</button>
		
	</div>
	</div>
</div>     

<div class="footer ui-widget-header ui-corner-all" id="druggable_footer">
	<P style="width:33%;text-align:right;">Ver. 1.0.0. Found problems? <A href="mailto:andrej.alekseenko@scilifelab.se">Send us email</A></P>
	<P><button id="clean_reload_button" onclick=clean_reload()>Reload site completely</button></P>
</div>

<script>
$(function() {
	$("#help-tabs-dr").tabs({heightStyle: "fill"});
});

$(function() {
	//$("#'.$dialogID.'").html("'.$text.'");
	//$("#help-menu-dr").menu();
	$("#help-dialog-dr").dialog({
		resizable: false,
        modal: false,
        title: "Help, FAQ, demo", 
        width:  1000,
        height: 600,
		position: {
			my: "center",
			at: "center",
			of: window
		}, 
		autoOpen: false,
		show: {
			//effect: "blind", duration: 380
		},
		close: function() {
			//$("#help-dialog-dr").css({"visibility": hidden});
			//$("#help-dialog-dr").html("");
			//$("[id*='qtip-'][aria-hidden='false']" ).remove(); //span:nth-child(3)
			//$( this ).dialog( "destroy" );
		}
	});
	//$('[aria-describedby="help-dialog-dr"]').css({"z-index": 1001});
	//$(".nea_loading").removeClass("nea_loading");
	//$("#usable-url").html("");
	//openTab( "analysis_type_ne", HSTabs.subtab.indices["'.$backTab.'"]);
	// $( "#rocOpener" ).click(function() {$( "#showError" ).dialog( "open" );});
});

function showDialogStatic (title, message) {
	$("#error-dialog-dr").html(message);
	$("#error-dialog-dr").dialog({
		resizable: false,
        modal: true,
        title: title, 
        width:  400,
        height: "auto",
		position: { 		my: "center", at: "center", 		of: window 		}, 
		autoOpen: true,
		show: {
			//effect: "blind", duration: 380
		},
		close: function() {}
	});
}

$("#help-qtip").qtip({
	show: true, 
	hide: "unfocus", 
	content: {
		text: function(event, api) {
			return $(this).attr("title");
		}
	}, 
	position: {
		viewport: $(window)
	},
	style: {
		classes: "qtip-bootstrap",
		tip: {
			width: 16,
			height: 8
		}
	}
});

(function() { //https://stackoverflow.com/questions/5202296/add-a-hook-to-all-ajax-requests-on-a-page
	var origOpen = XMLHttpRequest.prototype.open;
	XMLHttpRequest.prototype.open = function() {
		//console.log('-----------------------------');
		$('.xmlhttp_header').addClass("ajax_loading");  
		//$('.main_header').hide().show(1000);
		this.addEventListener("load", function () {
			//$('.main_header').addClass("ajax_loading");
			$('.ajax_loading').removeClass("ajax_loading");  		
		});	
		origOpen.apply(this, arguments);
	};
})();



$(document).ready(function(){
	safe_clear();
	// need this to hide message
	checkCookiesAccepted();
	
	$("#dock-button").button();
	$('#sidebar_table').DataTable();
	restore_history_dock();
	
	urlfixtabs("#tabs");
	//$("#progressbar").progressbar({		value: false	});	$("#progressbar").css({"visibility": "hidden"});
	$("#tabs").tabs({heightStyle: "fill"});
	
	$("#help_table_toggle").button();
	$("#help_data_sources").hide();
	
	//var tabList = $( "#tabs" )[0].childNodes[1].children;
	//console.log("tabList: " + tabList);
	//for (tt = 0; tt < tabList.length; tt++) {
		//console.log(tabList[tt]);
		//$(tabList[tt]).append( '<span id= "' + $(tabList[tt]).attr("aria-controls") + '-loading' + '" class="ui-icon ui-icon-loading-status-balls rotate"></span>' );	
	//}
	
	$("#clean_reload_button").button();
	$("#clean_reload_button").qtip({ 
			content: {
				text: "Press this button to delete all cookies. The site will return to the original state like you have never used it before"
			},
			position: {
				my: 'bottom left',  
				at: 'top right',
				target: $("#clean_reload_button")
			}
	});
	
	$("#help-tab-data").css("overflow", "auto");
	$("#help_data_sources").css("border", "1px solid black");
	//$("#help_data_sources").DataTable();

	$("#retrieve-cor-button").button();
	$("#retrieve-cor-button").button("disable");
	init_cor_source_selector("CCLE");
	usetCookie("corSource_selector", "CCLE", druggable_cookie_time);
	init_cor_datatype_selector();
	init_cor_cohort_selector();
	init_cor_platform_selector();
	init_cor_screen_selector();
	init_cor_genefeature_input();
	
	$("#submit-populate").button();
	// max_rows defined in druggable_config.js
	document.getElementById('add_row1').setAttribute("max", max_rows);
	
	var sources = get_plot_sources();
	options = [];
	for (i in sources) {
		options.push("<option value='"+ sources[i] + "'>" + sources[i] + "</option>");
	}
	$("#source_selector").append(options.join("")).selectmenu({
        width: "100px"
    });
	$('#source_selector').off("selectmenuchange").on( "selectmenuchange", function( event, ui ) {update_source()} );
	var previous_selection = (getCookie("source").split("|"))[0];
	if (sources.includes(previous_selection)) {
		$("#source_selector").val(previous_selection);
		$('#source_selector').selectmenu( "refresh" );
	}
	usetCookie("source", $("#source_selector option:selected").val(), druggable_cookie_time);
	init_cohortselector();
	$("#add_row1").qtip({ 
			content: {
				text: "Add a new row (under this one)"
			}
	});
	$("#delete_row1").qtip({ 
			content: {
				text: "Delete this row"
			}
	});
	$("#open_info1").qtip({ 
			content: {
				text: "Open external information page"
			}
	});
	$("#plot-button").button();
	$("#plot-button").button("disable");
	// we assign qtip to wrapper because qtip is not shown for disabled objects - and we have to show qtip only when plot-button is disabled
	$("#plot-button-wrapper").qtip({ 
		content: {
			text: "Please fill all IDs"
		}
	});
	// need to call it manually because some types of plots need no additional parameters 
	id_keyup(1);
	// reload from cookies if we had more than 1 row
	if (getCookie("type2_selector") != "") {
		console.log("Reloading options for the third tab");
		reload_analysis_options();
	}
	if (sessionStorage.getItem("docked_plots") == null) {
		sessionStorage.setItem("docked_plots", 0);
	}
	
	init_model_source_selector();
	init_model_cohort_selector();
	add_model_options_row();
	$("#add_variable").button({icon: "ui-icon-circle-plus",
        showLabel: false});
	$("#delete_variable").button({icon: "ui-icon-circle-minus",
        showLabel: false});
	$("#delete_variable").button("disable");
	if (getCookie("modelDatatype2_selector") != "") {
		reload_model_options();
	}
	init_response_datatype_selector();
	init_response_variable_selector();
	init_response_multiselector();
	init_glmnet_family_selector();
	// these parameters are defined in druggable_config.js
	document.getElementById('nfold').setAttribute("min", nfolds_min);
	document.getElementById('nfold').setAttribute("max", nfolds_max);
	document.getElementById('crossval_perc').setAttribute("max", validation_fraction_max);
	//var tabList = $( "#tabs" )[0].childNodes[1].children;	for (tt = 0; tt < tabList.length; tt++) {$('#' + $(tabList[tt]).attr("aria-controls") + '-loading')[0].remove();			}		
});

function setElementWidths() {
	// for all elements - default
	$("[id*='_selector-button']").each(function() { 
		var ele = $(this).attr("id");
		var List = $('#' + ele.replace("-button", ''));
		//console.log(ele);
		var maxLength = 0; var currentLength;
		for (var i=0; i < List[0].length; i++ ) {
			currentLength = List[0][i].innerText.length;
			maxLength = currentLength > maxLength ? currentLength : maxLength;
		}
		var Adjust = 0.9; 
		var Add = 7;
		List.selectmenu("option", "width", String(Adjust * maxLength + Add) + "ch");
		//console.log(ele + ": " + String(Adjust * maxLength + Add) + "ch");
	});
	// for datatype selectors - 3rd tab
	var selectorButtonWidth = 0;
	$("[id*='type'][id*='_selector-button']").each(function() { 
		var ele = $(this).attr("id");
		var List = $('#' + ele.replace("-button", ''));
		//console.log(ele);
		var currentLength;
		for (var i=0; i < List[0].length; i++ ) {
			currentLength = List[0][i].innerText.length;
			selectorButtonWidth = currentLength > selectorButtonWidth ? currentLength : selectorButtonWidth;
		}
	});
	//console.log(selectorButtonWidth);
	$("[id*='type'][id*='_selector-button']").css("width", window.devicePixelRatio*(75 + selectorButtonWidth));
	// for platform selectors - 3rd tab
	var selectorButtonWidth = 0;
	$("[id*='platform'][id*='_selector-button']").each(function() { 
		var ele = $(this).attr("id");
		var List = $('#' + ele.replace("-button", ''));
		//console.log(ele);
		var currentLength;
		for (var i=0; i < List[0].length; i++ ) {
			currentLength = List[0][i].innerText.length;
			selectorButtonWidth = currentLength > selectorButtonWidth ? currentLength : selectorButtonWidth;
		}
	});
	//console.log(selectorButtonWidth);
	$("[id*='platform'][id*='_selector-button']").css("width", window.devicePixelRatio*(75 + selectorButtonWidth));
	// for datatype and platform selectors - 4th tab
	var n = $('[id*="modelPlatform"][id$="selector"]').length;
	selectorButtonWidth = 0;
	for (var i = 1; i<=n; i++) {
		var currentLength;
		var ListDatatype = $('#modelDatatype' + i + '_selector');
		for (var j=0; j < ListDatatype[0].length; j++ ) {
			currentLength = ListDatatype[0][j].innerText.length;
			selectorButtonWidth = currentLength > selectorButtonWidth ? currentLength : selectorButtonWidth;
		}
		var ListPlatform = $('#modelPlatform' + i + '_selector');
		for (var j=0; j < ListPlatform[0].length; j++ ) {
			currentLength = ListPlatform[0][j].innerText.length;
			selectorButtonWidth = currentLength > selectorButtonWidth ? currentLength : selectorButtonWidth;
		}
		$("#modelDatatype" + i + "_selector-button").css("width", window.devicePixelRatio*(75 + selectorButtonWidth));
		$("#modelPlatform" + i + "_selector-button").css("width", window.devicePixelRatio*(75 + selectorButtonWidth));
	}
	
	//$("[id='modelSource_selector-button'],[id='modelCohort_selector-button'],[id='responseDatatype_selector-button'],[id='responseVariable_selector-button']").css("width", selectorButtonWidth);
	//var selectorButtonWidth2 = "11em";
	//$("[id*='modelDatatype'][id*='_selector-button'],[id*='modelPlatform'][id*='_selector-button']").css("width", selectorButtonWidth2);
	//$("[id='corDatatype_selector-button']").css("width", "17ch");
	$("span[id*='cor'][id*='_selector-button']").css("vertical-align", "top");
	
	$("#select_layout").parent().css("width", "98%")
}

// this function is used to reload rows on the third tab from cookies
function reload_analysis_options() {
	var n = parseInt(document.getElementById("add_row1").getAttribute("max"));
	for (var i=2; i<=n; i++) {
		console.log("Checking row " + i);
		if (getCookie("type" + i + "_selector") != "") {
			console.log("Row was set before");
			add_plot_options_row(i-1);
			console.log("Row " + i + " reloaded");
		}
	} 
}

// same for the fourth tab
function reload_model_options() {
	var n = max_model_rows;
	for (var i=2; i<=n; i++) {
		if (getCookie("modelDatatype" + i + "_selector") != "") {
			add_model_options_row();
		}
	} 
}

// show dialog window for 2nd tab with KM options
function plot_dialog(param_string) {
	console.log(param_string);
	var dialog_window = '<div>';
	var params = param_string.split(',');
	console.log(params);
	var drug = params.shift();
	var id = params.shift();
	for (var i in params) {
		var par = params[i];
		if (par != '') {
			var pars = par.split('#');
			console.log(par);
			console.log(pars);
			dialog_window = dialog_window + "<a onclick=\"plot('cor-KM', 'tcga', '" + pars[0] + "', ['drug', 'clin', '" + pars[1] + "'], ['drug', '" + pars[3] + "', '" + pars[2] + "'], ['" + drug + "', '', '" + id + "'], ['linear', 'linear', 'linear'], ['all', 'all', 'all'])\">KM plot: " + pars[0] + " " + pars[1] + " " + pars[2] + " " + pars[3] + "(" + drug + "," + id + ")</a><br>";
		}
	}
	dialog_window = dialog_window + '</div>';
	console.log(dialog_window);
	$(dialog_window).dialog({
				title: "Available KM plots",
				height: 'auto',
				width: 'auto',
				modal: true,
				beforeClose: function( event, ui ) {$(this).dialog('destroy').remove()}
			}).parent().appendTo("#tab-signif");
}

function plot_menu (param_string, caller) {
	console.log(param_string);
	var params = param_string.split(',');
	console.log(params);
	var drug = params.shift();
	var id = params.shift();
	var par = params[0];
			var pars = par.split('#');
			console.log(par);
			console.log(pars);
			var drop_menu = "<select name=\"KMs\" id=\"" + caller + "-menu\" ><option>AA</option></select>";
			// <a onclick=\"plot('cor-KM', 'tcga', '" + pars[0] + "', ['drug', 'clin', '" + pars[1] + "'], ['drug', '" + pars[3] + "', '" + pars[2] + "'], ['" + drug + "', '', '" + id + "'], ['linear', 'linear', 'linear'], ['all', 'all', 'all'])\">KM plot: " + pars[0] + " " + pars[1] + " " + pars[2] + " " + pars[3] + "(" + drug + "," + id + ")</a>
	console.log(caller);	
	// console.log(drop_menu);	
	// $(drop_menu).selectmenu().parent().appendTo(caller);
	// var DDD = '<div>CCC</div>'; 
	$(drop_menu).appendTo($("#" + caller).parent());
	$("#" + caller + "-menu").selectmenu();
	// $("#" + caller + "-menu").css({"display": "block", "width": "25em", "height": "3em"});
}

function plot(type, source, cohort, datatypes, platforms, ids, scales, code) {
	var parent_tab = "#" + $("#tabs").tabs()[0].children[$("#tabs").tabs("option", "active")+1].id
	// variables are initialised when this function is called from correlations table, otherwise - initialise them
	if (type == undefined) {
		type = $('#plot-type option:selected').val();
		var n = $('#plot_options tr').length-1;
		source = $("#source_selector option:selected").val();
		cohort = $("#cohort_selector option:selected").val();
		datatypes = [];
		ids = [];
		platforms = [];
		scales = [];
		code = $("#tcga_selector option:selected").val();
		for (i=1; i<=n; i++) {
			datatypes.push($("#type" + i + "_selector option:selected").val());
			platforms.push($("#platform" + i + "_selector option:selected").val());
			ids.push($("#id" + i + "_input").val());
			scales.push($("#axis" + i + "_selector option:selected").val());
		}
	}
	var plot_description = "type:" + type + "|source:" + source + "|cohort:" + cohort + "|datatypes:" + datatypes + "|platforms:" + platforms + "|ids:" + ids + "|tcga_codes:" + code + "|scales:" + scales;
	var plot_filename = find_plot_in_history(plot_description);
	var plot_id;
	var plot_data = [];
	var raw_metadata;
	var metadata;
	// new plot
	if (plot_filename == "no") {
		var ErrorStack = check_error_stack(new Error().stack);
		raw_metadata = rplot(type, source, cohort, datatypes, platforms, ids, code, scales);
		metadata = JSON.parse(raw_metadata);
		plot_filename = metadata["plot_filename"];
		// check if plot successfully created
		var xmlhttp = new XMLHttpRequest();
		xmlhttp.open("HEAD", "https://" + window.location.hostname + "/pics/plots/" + plot_filename, false);
		xmlhttp.send();
		if (xmlhttp.status == 404) {
			console.log("Something went wrong, plot was not created, reporting error...");
			report_event(((window.location.host.split(".")[0] == "dev") ? ("dev/") : "") + "druggable.html", "error", "plot_not_created", "type=" + type +
				"&source=" + source + 
				"&cohort=" + cohort + 
				"&datatypes=" + datatypes.join() + 
				"&platforms=" + platforms.join() + 
				"&ids=" + ids.join() +
				"&code=" + code +
				"&scales=" + scales.join(),
				ErrorStack);
				plot_data["title"] = "Error";
		}
		else {
			report_event(((window.location.host.split(".")[0] == "dev") ? ("dev/") : "") + "druggable.html", "info", "plot_created", "type=" + type +
				"&source=" + source + 
				"&cohort=" + cohort + 
				"&datatypes" + datatypes.join() + 
				"&platforms=" + platforms.join() + 
				"&ids=" + ids.join() +
				"&code=" + code +
				"&scales=" + scales.join(),
				"<a href=https://" + window.location.hostname + "/pics/plots/" + plot_filename + " target=_blank>View</a>");
				plot_id = plot_filename.substring(0, plot_filename.length-5);
				plot_data = generate_plot_data(metadata);
				sessionStorage.setItem(plot_filename, plot_description);
				sessionStorage.setItem('meta_' + plot_filename, raw_metadata);
		}
		var graph_window = '<div id="plot_window_' + plot_id +'"><iframe src="https://www.evinet.org/pics/plots/' + plot_filename + '" width="960" height="600"></div>';
		$(parent_tab).append(graph_window);
		$("#plot_window_" + plot_id).dialog({
			title: plot_data["title"],
			height: 'auto',
			width: 'auto',
			position: {
				my: "right bottom",
				at: "right bottom",
				of: parent_tab
			},
			modal: false,
			resize: function( event, ui ) {
					($(this).children('iframe'))[0].setAttribute("height", $(this).height());
					($(this).children('iframe'))[0].setAttribute("width", $(this).width());
				},
			beforeClose: function( event, ui ) {$(this).dialog('destroy').remove()}
		}).parent().appendTo(parent_tab);
		$('[aria-describedby="' + window_id + '"]').
				find( 'div.ui-dialog-titlebar' ).
				append("<button type=\"button\" class=\"ui-button ui-corner-all ui-widget ui-button-icon-only\" title=\"Copy plot link\" onclick=\"copy_plot_link(\'" + plot_filename + "\')\"><span class=\"ui-button-icon ui-icon ui-icon-link\"></span><span class=\"ui-button-icon-space\"> </span>Copy link</button>" 
			);
		move_plot_to_dock('plot_window_' + plot_id, plot_filename, plot_data["meta"]);
	}
	// existing plot
	else {
		//console.log("No need to do it again!");
		plot_id = plot_filename.substring(0, plot_filename.length-5);
		if (document.getElementById("plot_window_" + plot_id)) {
			console.log("We already have a window: move it to the top!");
			$("#plot_window_" + plot_id + ".ui-dialog-content.ui-widget-content").dialog("moveToTop");
		}
		else {
			console.log("Plot was closed");
			console.log(plot_filename);
			raw_metadata = sessionStorage.getItem('meta_' + plot_filename);
			console.log(raw_metadata);
			metadata = JSON.parse(raw_metadata);
			plot_data = generate_plot_data(metadata);
			var window_id = 'plot_window_' + plot_id;
			var graph_window = '<div id="' + window_id + '"><iframe src="https://www.evinet.org/pics/plots/' + plot_filename + '" width="960" height="600"></div>';
			$(graph_window).dialog({
				title: plot_data["title"],
				height: 'auto',
				width: 'auto',
				modal: false,
				resize: function( event, ui ) {
					($(this).children('iframe'))[0].setAttribute("height", $(this).height());
					($(this).children('iframe'))[0].setAttribute("width", $(this).width());
				},
				beforeClose: function( event, ui ) {$(this).dialog('destroy').remove()}
			}).parent().appendTo(parent_tab);
			$('[aria-describedby="' + window_id + '"]').
				find( 'div.ui-dialog-titlebar' ).
				append("<button type=\"button\" class=\"ui-button ui-corner-all ui-widget ui-button-icon-only\" title=\"Copy plot link\" onclick=\"copy_plot_link(\'" + plot_filename + "\')\"><span class=\"ui-button-icon ui-icon ui-icon-link\"></span><span class=\"ui-button-icon-space\"> </span>Copy link</button>" 
			);	
		}
	}
}

function build_and_show_model() {
	var status = check_model_input();
	if (status == 'ok') {
		// common options for response and independent variables
		var source = $("#modelSource_selector option:selected").val();
		var cohort = $("#modelCohort_selector option:selected").val();
		var multiopt = $("#responseMulti_selector").val();
		
		// dependent variables
		var r_datatype = $("#responseDatatype_selector option:selected").val();
		var r_platform = $("#responseVariable_selector option:selected").val();
		var r_id = $("#responseID_input").val();
		
		// independent variables
		var x_datatypes = [];
		var x_platforms = [];
		var x_ids = [];
		var variable_count = 0;
		var n = $('[id*="modelPlatform"][id$="selector"]').length;
		for (var i=1; i<=n; i++) {
			x_datatypes.push($("#modelDatatype" + i + "_selector option:selected").val());
			x_platforms.push($("#modelPlatform" + i + "_selector option:selected").val());
			// if id input contain delimeter at the last position - empty array element will be generated; prevent this
			var temp = $("#genes_area" + i).val();
			// delete all spaces - otherwise "a, b, c" will turn into ["a", " b", " c"]
			temp = temp.replace(/\s/g, '');
			// regexp, defined in druggable_config.js
			temp = temp.split(ids_delim);
			for (var j=0; j<temp.length; j++) { 
				if (temp[j] == "") {
					temp.splice(j, 1); 
				}
			}
			if (document.getElementById("genes_area" + i).hidden) {
				variable_count = variable_count + 1;
			}
			else {
				// do this to avoid 1D analysis for one 'all' 
				if (temp == "all") {
					variable_count = variable_count + 10;
				}
				else {
					variable_count = variable_count + temp.length;
				}
			}
			x_ids.push(temp);
		}
		//console.log(variable_count);
		
		// check if we have 1D analysis
		if (variable_count == 1) {
			var plot_types = get_plot_types([x_platforms[0], r_platform]);
			if (plot_types[0] == '') {
				alert("Unable to make analysis with chosen parameters");
			}
			else {
				var scales = ['linear', 'linear'];
				if (plot_types[0] == 'box') {
					var axis_types = get_axis_types(cohort, x_datatypes[0], x_platforms[0]);
					if (axis_types.length == 0) {
						scales[0] = '';
					}
					axis_types = get_axis_types(cohort, r_datatype, r_platform);
					if (axis_types.length == 0) {
						scales[1] = '';
					}
				}
				plot(plot_types[0], source, cohort, [x_datatypes[0], r_datatype], [x_platforms[0], r_platform], [x_ids[0][0], r_id], scales, [multiopt[0]]);
			}
		}
		else {
			// model options
			// hard-coded now, make a selector
			var method = "glmnet";
			var standardize = $("#standardize:checked").val();
			if (standardize == "on") {
				standardize = true;
			}
			else {
				standardize = false;
			}
			var alpha = $("#alpha").val();
			var nlambda = $("#nlambda").val();
			var minlambda = $("#minlambda").val();
			var family = $("#family option:selected").val();
			var measure = "deviance";
			var crossvalidation = $("#crossval:checked").val();
			if (crossvalidation == "on") {
				crossvalidation = true;
			}
			else {
				crossvalidation = false;
			}
			var nfold = $("#nfold").val();
			var crossvalidation_percent = $("#crossval_perc").val()/100;
			
			var ErrorStack = check_error_stack(new Error().stack);
			var model_name = build_model(method, source, cohort, r_datatype, r_platform, r_id, x_datatypes, x_platforms, x_ids, multiopt,
				family, measure, standardize, alpha, nlambda, minlambda, crossvalidation, nfold, crossvalidation_percent, "auto", false, true);
			var xmlhttp = new XMLHttpRequest();
			xmlhttp.open("HEAD", "https://" + window.location.hostname + "/pics/plots/" + model_name + "_model.png", false);
			xmlhttp.send();
			if (xmlhttp.status == 404) {
				console.log("Something went wrong, model was not created, reporting error...");
				report_event(((window.location.host.split(".")[0] == "dev") ? ("dev/") : "") + "druggable.html", "error", "model_not_created",
					"method=" + method + 
					"&source=" + source + 
					"&cohort=" + cohort + 
					"&r_datatype=" + r_datatype + 
					"&r_platform=" + r_platform + 
					"&r_id=" + r_id +
					"&x_datatypes=" + x_datatypes.join() + 
					"&x_platforms=" + x_platforms.join() + 
					"&x_ids=" + x_ids.join() +
					"&multiopt=" + multiopt.join() + 
					"&family=" + family + 
					"&crossvalidation=" + crossvalidation + 
					"&nfold=" + nfold +
					"&crossval_percent=" + crossvalidation_percent + 
					"&standardize=" + standardize,
					ErrorStack);
			}
			else {
				report_event(((window.location.host.split(".")[0] == "dev") ? ("dev/") : "") + "druggable.html", "info", "model_created", 
					"method=" + method + 
					"&source=" + source + 
					"&cohort=" + cohort + 
					"&r_datatype=" + r_datatype + 
					"&r_platform=" + r_platform + 
					"&r_id=" + r_id +
					"&x_datatypes=" + x_datatypes.join() + 
					"&x_platforms=" + x_platforms.join() + 
					"&x_ids=" + x_ids.join() +
					"&multiopt=" + multiopt.join() + 
					"&family=" + family + 
					"&crossvalidation=" + crossvalidation + 
					"&nfold=" + nfold +
					"&crossval_percent=" + crossvalidation_percent + 
					"&standardize=" + standardize,
					"<a href=https://" + window.location.hostname + "/pics/plots/" + model_name + "_model.png target=_blank>Model summary</a> " +
					"<a href=https://" + window.location.hostname + "/pics/plots/" + model_name + "_training.png target=_blank>Model training</a> " +
					((crossvalidation) ? (
						"<a href=https://" + window.location.hostname + "/pics/plots/" + model_name + "_validation.png target=_blank>Model validation</a> "
					) : ("")) +
					"<a href=https://" + window.location.hostname + "/model_json.html#coeff." + model_name + ".json target=_blank>View coefficients</a> " +
					"<a href=https://" + window.location.hostname + "/pics/plots/" + model_name + ".RData target=_blank>Download</a> ");
			}
			var model_window = '<div id="' + model_name + '_window">' +
				'<div id="' + model_name + '_tabs"> \
					<ul> \
						<li><a href="#' + model_name + '_model">Model overview</a></li> \
						<li><a href="#' + model_name + '_training">Training</a></li>'
						+ ((crossvalidation) ? ('<li><a href="#' + model_name + '_validation">Validation</a></li>') : (''))
						+ '<li><a href="#' + model_name + '_performance">Performance</a></li>' +
					'</ul> \
					<div id="' + model_name + '_model"> \
						<iframe src="https://' + window.location.hostname + '/pics/plots/' + model_name + '_model.png" width="720" height="720"></iframe> \
					</div> \
					<div id="' + model_name + '_training"> \
						<iframe src="https://'+ window.location.hostname + '/pics/plots/' + model_name + '_training.png" width="720" height="720"></iframe> \
					</div>'
					+ ((crossvalidation) ? (
					'<div id="' + model_name + '_validation"> \
						<iframe src="https://' + window.location.hostname + '/pics/plots/' + model_name + '_validation.png" width="720" height="720"></iframe> \
					</div>') : ('')) +
					'<div id = "' + model_name + '_performance"> \
						<table id="' + model_name + '_perf" class="display" style="width:100%"> \
							<thead> \
								<tr> \
									<th>Measure</th> \
									<th>Training</th> \
									<th>Validation</th> \
								</tr> \
							</thead> \
						</table>\
					</div> \
				</div> \
				<br> \
				<table id="' + model_name + '_coef" class="display" style="width:100%"> \
					<thead> \
						<tr> \
							<th>Coefficient</th> \
							<th>Weight</th> \
							<th></th>\
						</tr> \
					</thead> \
				</table>\
				</div>';
				$("#tab-predict").append(model_window);
				$("#" + model_name + "_window").dialog({
					title: "Model viewer",
					height: 'auto',
					width: 'auto',
					modal: false,
					buttons: [
						{
							text: "Download model",
							icon: "ui-icon-download",
							click: function() {window.location.href = "https://" + window.location.hostname + "/pics/plots/" + model_name + ".RData";},
						},
						{
							text: "Add model to comparison",
							click: function() {add_model_to_comparison(model_name);},
						}
					],
					resize: function( event, ui ) {
							($(this).children('iframe'))[0].setAttribute("height", $(this).height());
							($(this).children('iframe'))[0].setAttribute("width", $(this).width());
						},
					beforeClose: function( event, ui ) {$(this).dialog('destroy').remove()}
				}).parent().appendTo("#tab-predict");
			$("#" + model_name + "_tabs").tabs();
			urlfixtabs("#" + model_name + "_tabs");
			$('#' + model_name + '_coef').DataTable( {
				"ajax": "https://" + window.location.hostname + "/pics/plots/coeff." + model_name + ".json",
				"columns": [
					{ "data" : "Term"},
					{ "data" : "Coef"},
					{ "data" : "Plot"}
				],
				"order": [[ 1, "desc" ]],
			});
			$('#' + model_name + '_perf').DataTable( {
				"ajax": {
					"url" : "https://" + window.location.hostname + "/pics/plots/perf." + model_name + ".json",
					"dataSrc" : function(json) {
						//console.log(json.data);
						var pretty_print_data = new Array();
						// collect available measures - remember about ()
						var measures = new Array();
						// use this to easily find indexes
						var temp_index = new Array();
						for (var i = 0; i < json.data.length; i++) {
							var mark_start = json.data[i].Measure.lastIndexOf("(");
							if (mark_start == -1) {
								mark_start = json.data[i].Measure.length;
							}
							var measure = json.data[i].Measure.slice(0, mark_start);
							//console.log(measure);
							if (measures.indexOf(measure) == -1) {
								measures.push(measure);
							}
							temp_index.push(json.data[i].Measure);
						}
						//console.log(measures);
						//console.log(temp_index);
						for (var i = 0; i < measures.length; i++) {
							//console.log(measures[i]);
							// JS cannot find all occurences using indexOf - do it manually
							var occurences = new Array();
							for (var j = 0; j < temp_index.length; j++) {
								//console.log(temp_index[j]);
								if (temp_index[j].indexOf(measures[i]) != -1) {
									occurences.push(j);
								}
							}
							//console.log(occurences);
							// if we have more than 1 occurence - it means training/validation
							if (occurences.length == 2) {
								var training_ind = (temp_index[occurences[0]].indexOf("(training)") != -1 ? occurences[0] : occurences[1]);
								var validation_ind = (temp_index[occurences[0]].indexOf("(validation)") != -1 ? occurences[0] : occurences[1]);
								pretty_print_data.push({
									'Measure' : measures[i],
									'Value' : {
										'Training' : json.data[training_ind].Value,
										'Validation' : json.data[validation_ind].Value
									}
								});
							}
							else {
								pretty_print_data.push({
									'Measure' : measures[i],
									'Value' : {
										'Training' : json.data[occurences[0]].Value,
										'Validation' : ''
									}
								});
							}
						}
						//console.log(pretty_print_data);
						return pretty_print_data;
					}
				},
				"columns": [
					{ "data": "Measure"},
					{ "data": "Value.Training"},
					{ "data": "Value.Validation"}
				],
				"order": [[ 0, "desc" ]],
			});
		}
	}
	else {
		alert("Please fix the following problems to build the model:" + status);
	}
}

function retrieve_correlations() {
	window.postMessage("show_progressbar");
	var n = $('#cor_result_table tr').length;
	if (n > 1) {
		$('#cor_result_table').DataTable().clear();
		$('#cor_result_table').DataTable().destroy();
	}
	var source = $("#corSource_selector option:selected").val();
	var datatype = $("#corDatatype_selector option:selected").val();
	var cohort = $("#corCohort_selector option:selected").val();
	var platform = $("#corPlatform_selector option:selected").val();
	var screen = $("#corScreen_selector option:selected").val();
	var id = ($("#corGeneFeature_input").val()).toLowerCase();
	var fdr = $("#FDR_input").val();
	// clear result table each time
	document.getElementById("cor_result_table").innerHTML = '<table><thead>' + cor_headers.get(source) + '</thead></table>';
	// variable min_pat_drug_number defined in druggable_config.js and used for defining if TCGA cohort should be offered for KM plot
	// i.e. if min_pat_drug_number=10 and BRCA has 12 patients with drug A - BRCA will be offered
	console.log("cor_datatables_json.cgi?source=" + source + "&datatype=" + datatype + "&cohort=" + cohort + "&platform=" + platform + "&screen=" + screen + "&id=" + id + "&fdr=" + fdr + "&mindrug=" + min_pat_drug_number + "&data_columns=" + cor_sql_data_columns.get(source) + "&filter_columns=" + cor_sql_filter_columns.get(source) + "&concat_operator=" + cor_concatenation_operators.get(source));
	var data_table = $('#cor_result_table').DataTable({
		"ordering": true,
		"ajax": "cgi/cor_datatables_json.cgi?source=" + source + "&datatype=" + datatype + "&cohort=" + cohort + "&platform=" + platform + "&screen=" + screen + "&id=" + id + "&fdr=" + fdr + "&mindrug=" + min_pat_drug_number + "&data_columns=" + cor_sql_data_columns.get(source) + "&filter_columns=" + cor_sql_filter_columns.get(source) + "&concat_operator=" + cor_concatenation_operators.get(source),
        "initComplete": function(settings, json) {
			console.log("Correlations retrieved");
			var event = new CustomEvent("correlations_retrieved", {
				detail: {
					timestamp: new Date().getTime()
				}
			});
			document.getElementById("cor_result_table").dispatchEvent(event);
			window.postMessage("hide_progressbar");
			/*
			$( '[id*="TCGAcohortSelector"] > option' ).each(
				function() {
					$(this).prop("title", $(this).val() );
			})
			$('[id*="TCGAcohortSelector"]').selectmenu();
			$('[id*="TCGAcohortSelector"]').on( "selectmenuclose",
				function( event, ui ) {
					console.log($(this).val());
					var selected_values = $(this).val().split('#'); 
					plot('cor-KM', 'tcga',selected_values[0], ['drug', 'clin', selected_values[1]], ['drug', selected_values[3].toLowerCase(), selected_values[2]], [selected_values[4], '', selected_values[5]], ['linear', 'linear', 'linear'], ['all', 'all', 'all'])
			});
			*/
			var table = $('#cor_result_table').DataTable();
			table.rows().every( function (index, element) {
				var row = $(this.node());
				// not a good solution - assumes that cohort selector is always the last column
				var ind = row.children().length - 1;
				//console.log(row.children()[ind]);
				var selector = row.children()[ind].children[0];
					$( selector ).each(
						function() {
							$(this).prop("title", $(this).val() );
						})
					$(selector).selectmenu();
					$(selector).on( "selectmenuclose",
					function( event, ui ) {
						console.log($(this).val());
						var selected_values = $(this).val().split('#'); 
						plot('cor-KM', 'tcga',selected_values[0], ['drug', 'clin', selected_values[1]], ['drug', selected_values[3].toLowerCase(), selected_values[2]], [selected_values[4], '', selected_values[5]], ['linear', 'linear', 'linear'], ['all', 'all', 'all'])
					});
			});
		},
		"columns": cor_visible_columns.get(source),
		"dom": "lfBrtip",
		"buttons": [
            'excel', 'copy', 'csv'
        ],
		columnDefs: [
			{ className: "dt-center", targets: "_all" }
		]
	});
	data_table.buttons().container().prependTo( $("#cor_result_table_wrapper"));
}

function tcga_km_from_cor(i, drug) {
	var cohort = $("#TCGAcohortSelector" + i + " option:selected").val();
	plot("KM", "tcga", cohort, ["drug", "clin"], ["drug", "os"], [drug, ""], ["linear", "linear"], ["all", "all"]);
}

function add_plot_options_row(i) {
	// current number of rows (-1 because of header)
	var n = $('#plot_options tr').length-1;
	for (j=n; j>=i+1; j--) {
		$('#type' + j + '_selector').off("selectmenuchange").on( "selectmenuchange", function( event, ui ) {update('type' + (j+1) + '_selector')} );
		$('#platform' + j + '_selector').off("selectmenuchange").on( "selectmenuchange", function( event, ui ) {update('platform' + (j+1) + '_selector')} );
		document.getElementById('plot_options_row' + j).setAttribute("id", 'plot_options_row' + (j+1));
		document.getElementById('type' + j +'_selector').setAttribute("id", 'type' + (j+1) +'_selector');
		document.getElementById('platform' + j +'_selector').setAttribute("id", 'platform' + (j+1) +'_selector');
		document.getElementById('id' + j +'_input').setAttribute("onkeyup", 'id_keyup(' + (j+1) +')');
		document.getElementById('id' + j +'_input').setAttribute("onchange", 'id_keyup(' + (j+1) +')');
		document.getElementById('id' + j +'_input').setAttribute("id", 'id' + (j+1) +'_input');
		document.getElementById('id' + j +'_confirmed').setAttribute("id", 'id' + (j+1) +'_confirmed');
		document.getElementById('axis' + j +'_selector').setAttribute("id", 'axis' + (j+1) +'_selector');
		document.getElementById('add_row' + j).setAttribute("id", 'add_row' + (j+1));
		document.getElementById('add_row' + (j+1)).setAttribute("onclick", 'add_plot_options_row(' + (j+1) + ')');
		document.getElementById('delete_row' + j).setAttribute("id", 'delete_row' + (j+1));
		document.getElementById('delete_row' + (j+1)).setAttribute("onclick", 'delete_plot_options_row(' + (j+1) + ')');
		document.getElementById('open_info' + j).setAttribute("id", 'open_info' + (j+1));
		document.getElementById('open_info' + (j+1)).setAttribute("onclick", 'open_info_page(' + (j+1) + ')');
		usetCookie("type" + (j+1) + "_selector", (getCookie("type" + j + "_selector").split("|"))[0], druggable_cookie_time);
		usetCookie("platform" + (j+1) + "_selector", (getCookie("platform" + j + "_selector").split("|"))[0], druggable_cookie_time);
	}
	// fixes potential bug caused by plot_type_changed for "drug" platform
	if (n+1 == 2) {
		if ($("#platform1_selector option:selected").val() == "drug") {
			document.getElementById("id1_input").disabled = false;
			document.getElementById("id1_input").hidden = false;
			document.getElementById("id1_confirmed").hidden = false;
		}
	}
		
	sessionStorage.setItem("add_row", 1);
		
	var table = document.getElementById("plot_options");
	var row = table.insertRow(i+1);
	row.id = "plot_options_row" + (i+1);
	var TypeSelectorCell = row.insertCell(0);
	TypeSelectorCell.innerHTML = '<select id="type' + (i+1) +'_selector" class="ui-helper" style="width: 40ch;">';
	init_dataselector('type'+(i+1)+'_selector');
	var PlatformSelectorCell = row.insertCell(1);
	PlatformSelectorCell.innerHTML = '<select id="platform' + (i+1) +'_selector" class="ui-helper" style="width: 40ch;">';
	var IdInput = row.insertCell(2);
	IdInput.innerHTML = '<input id="id'+ (i+1) + '_input" onkeyup="id_keyup(' + (i+1) + ')" onchange="id_keyup(' + (i+1) + ')"><input id="id'+ (i+1) + '_confirmed" disabled><button id="open_info' + (i+1) + '" onclick="open_info_page(' + (i+1) + ')" disabled>Info</button>';
	$("#open_info" + (i+1)).qtip({ 
		content: {
			text: "Open external information page"
		}
	});
	init_platformselector('platform'+(i+1)+'_selector');
	var AxisSelector = row.insertCell(3);
	AxisSelector.innerHTML = '<select id="axis' + (i+1) +'_selector" class="ui-helper" style="width: 20ch;">';
	init_axis_type_selector('axis' + (i+1) + '_selector');
	var AddButton = row.insertCell(4);
	// max number of rows defined in druggable_config.js
	AddButton.innerHTML = '<button id="add_row' + (i+1) + '" max=' + max_rows + ' onclick="add_plot_options_row(' + (i+1) + ')">+</button>';
	$("#add_row" + (i+1)).qtip({ 
		content: {
			text: "Add a new row (under this one)"
		}
	});
	var DeleteButton = row.insertCell(5);
	DeleteButton.innerHTML = '<button id="delete_row' + (i+1) + '" max=' + max_rows + ' onclick="delete_plot_options_row(' + (i+1) + ')">-</button>';
	$("#delete_row" + (i+1)).qtip({ 
		content: {
			text: "Delete this row"
		}
	});
	update_plot_types();
	$("#add_row" + (i+1)).button();
	$("#delete_row" + (i+1)).button();
	$("#open_info" + (i+1)).button();
		
	// for some reason - we have to do this after initialisation. Otherwise , if you do it on one of the previous lines, jquery ui will
	// add "title" field to button and hence another tip (you will see "+" and "-" white tooltips for icons)
	$("#add_row" + (i+1)).button({icon: "ui-icon-circle-plus",
		showLabel: false});
	$("#delete_row" + (i+1)).button({icon: "ui-icon-circle-minus",
		showLabel: false});
	$("#open_info" + (i+1)).button({icon: "ui-icon-extlink",
		showLabel: false});
	if (n+1 >= document.getElementById("add_row" + i).getAttribute("max")) {
		for (j=1; j<=n+1; j++) {
			$("#add_row" + j).button("disable");
		}
	}
	for (j=1; j<=n; j++) {
		$("#delete_row" + j).button("enable");
	}
	$("#source_selector").selectmenu("disable");
	$("#source_selector-wrapper").qtip({ 
		content: {
			text: "Please delete all but one row to change source"
		}
	});
	$("#cohort_selector").selectmenu("disable");
	$("#cohort_selector-wrapper").qtip({ 
		content: {
			text: "Please delete all but one row to change cohort"
		}
	});
	var id_input_enabled = ($("#id" + (i+1) + "_input").is(":enabled"));
	if (id_input_enabled) {
		$("#plot-button").button("disable"); 
	}
	$('#tcga_selector').find('option').remove().end();
	$('#tcga_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_tcga_code_selector(i+1);
	$('#tcga_selector').selectmenu( "refresh" );
	sessionStorage.removeItem("add_row");
	id_keyup(i+1);
	var event = new CustomEvent("row_added", {
		detail: {
			row: i
		}
	});
	document.getElementById("add_row" + i).dispatchEvent(event);
	$("input[id*='_input'],input[id*='_confirmed']").addClass("ui-corner-all");
}

function delete_plot_options_row(i) {
	var n = $('#plot_options tr').length-1;
	for (j=i+1; j<=n; j++) {
		$('#type' + j + '_selector').off("selectmenuchange").on( "selectmenuchange", function( event, ui ) {update('type' + (j-1) + '_selector')} );
		$('#platform' + j + '_selector').off("selectmenuchange").on( "selectmenuchange", function( event, ui ) {update('platform' + (j-1) + '_selector')} );
		document.getElementById('plot_options_row' + j).setAttribute("id", 'plot_options_row' + (j-1));
		document.getElementById('type' + j +'_selector').setAttribute("id", 'type' + (j-1) +'_selector');
		document.getElementById('platform' + j +'_selector').setAttribute("id", 'platform' + (j-1) +'_selector');
		document.getElementById('id' + j +'_input').setAttribute("onkeyup", 'id_keyup(' + (j-1) +')');
		document.getElementById('id' + j +'_input').setAttribute("onchange", 'id_keyup(' + (j-1) +')');
		document.getElementById('id' + j +'_input').setAttribute("id", 'id' + (j-1) +'_input');
		document.getElementById('id' + j +'_confirmed').setAttribute("id", 'id' + (j-1) +'_confirmed');
		document.getElementById('axis' + j +'_selector').setAttribute("id", 'axis' + (j-1) +'_selector');
		document.getElementById('add_row' + j).setAttribute("onclick", 'add_plot_options_row(' + (j-1) + ')');
		document.getElementById('add_row' + j).setAttribute("id", 'add_row' + (j-1));
		document.getElementById('delete_row' + j).setAttribute("onclick", 'delete_plot_options_row(' + (j-1) + ')');
		document.getElementById('delete_row' + j).setAttribute("id", 'delete_row' + (j-1));
		document.getElementById('open_info' + j).setAttribute("onclick", 'open_info_page(' + (j-1) + ')');
		document.getElementById('open_info' + j).setAttribute("id", 'open_info' + (j-1));
		// druggable_cookie_time defined in druggable_config.js
		usetCookie("type" + j + "_selector", (getCookie("type" + (j-1) + "_selector").split("|"))[0], druggable_cookie_time);
		usetCookie("platform" + j + "_selector", (getCookie("platform" + (j-1) + "_selector").split("|"))[0], druggable_cookie_time);
	}
	$("#plot_options_row" + i).children().children().qtip('destroy', true);
	document.getElementById("plot_options").deleteRow(i);
	
	// delete cookies for the last row - see the code above to understand why
	deleteCookie("type" + n + "_selector");
	deleteCookie("platform" + n + "_selector");
	
	for (j=1; j<n; j++) {
		$("#add_row" + j).button("enable");
	}
	if (n-1 == 1) {
		$("#delete_row1").button("disable");
		$("#source_selector").selectmenu("enable");
		$("#source_selector-wrapper").qtip("disable");
		$("#cohort_selector").selectmenu("enable");
		$("#cohort_selector-wrapper").qtip("disable");
	}
	//if (i == 1) {
	//	$('#type1_selector').find('option').remove().end();
	//	$('#type1_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	//	init_dataselector('type1_selector');
	//	$('#type1_selector').selectmenu( "refresh" );
	//}
	if (sessionStorage.getItem("cascade_delete") == null) {
		update_plot_types();
		if (i<n) {
			update_type(i);
		}
		$('#tcga_selector').find('option').remove().end();
		$('#tcga_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
		// not a good solution
		init_tcga_code_selector(1);
		$('#tcga_selector').selectmenu( "refresh" );
	}
	// artificially trigger change event for all available inputs
	// so if the deleted row was the reason why plot-button was disabled - the button would become enabled
	id_keyup(i-1);
}

// unlike plot options model options row may be added only as a last row
function add_model_options_row() {
	var i = $('[id*="modelPlatform"][id$="selector"]').length + 1;
	//$('[id*="modelPlatform"] option:selected').each(function () {});
	var newContent = html_glm_regressors.replace(/###/g, i);
	if (i == 1) {
		newContent.replace(/\, type 1/, "");
	}
	var row = document.getElementById("r-x");
	var NewModelXCell = row.insertCell(i-1);
	NewModelXCell.id = "d-x" + i;
	NewModelXCell.innerHTML = newContent;

	init_model_datatype_selector(i);
	init_model_platform_selector(i);
	init_model_genearea(i);
	if (i > 1) {
		$("#modelSource_selector").selectmenu("disable");
		$("#modelCohort_selector").selectmenu("disable");
		if (i == max_model_rows) {
			$("#add_variable").button("disable");
		}
		$("#delete_variable").button("enable");
		check_model_unique_variable(i);
	}
}

// we always delete the last variable
function delete_model_options_row() {
	var n = $('[id*="modelPlatform"][id$="selector"]').length;
	deleteCookie("modelDatatype" + n + "_selector");
	deleteCookie("modelPlatform" + n + "_selector");
	if (n == 2) {
		$("#modelSource_selector").selectmenu("enable");
		$("#modelCohort_selector").selectmenu("enable");
		$("#delete_variable").button("disable");
	}
	$("#d-x" + n).remove();
	$("#add_variable").button("enable");
	// prevent passing saved ids to deleted option row
	if (document.getElementById("transfer_window") != null) {
		// extract button text to determine row number to which ids will be transfered
		var button_text_array = $("#transfer_copy_ids").text().split();
		var current = button_text_array[button_text_array.length-1];
		if (current == n) {
			$("#transfer_copy_ids").text("Copy chosen IDs to predictor 1");
			$("#transfer_copy_ids").unbind();
			$("#transfer_copy_ids").on("click", function() {copy_ids_to_predictor(1);});
			$("#transfer_copy_all_ids").text("Copy all IDs to predictor 1");
			$("#transfer_copy_all_ids").unbind();
			$("#transfer_copy_all_ids").on("click", function() {copy_all_ids_to_predictor(1);});
		}
	}
}

function init_cohortselector() {
	var cohorts = get_plot_cohorts($("#source_selector option:selected").val());
	options = [];
	var cohort_ids = [];
	for (i in cohorts) {
				options.push("<option value='"+ cohorts[i].cohort + "'>" + cohorts[i].name + "</option>");
				cohort_ids.push(cohorts[i].cohort);
		}
	$("#cohort_selector").append(options.join("")).selectmenu({
        width: "100px"
    });
	$('#cohort_selector').off("selectmenuchange").on( "selectmenuchange", function( event, ui ) {update_cohort()} );
	var previous_selection = (getCookie("cohort").split("|"))[0];
	if (cohort_ids.includes(previous_selection)) {
		$("#cohort_selector").val(previous_selection);
	}
	usetCookie("cohort", $("#cohort_selector option:selected").val(), druggable_cookie_time);
	$('#cohort_selector').selectmenu( "refresh" );
	sessionStorage.setItem("add_row", 1);
	init_dataselector("type1_selector");
	init_platformselector("platform1_selector");
	init_axis_type_selector("axis1_selector");
	if (document.getElementById("tcga_selector-button") != null) {
		$('#tcga_selector').find('option').remove().end();
		$('#tcga_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	}
	init_tcga_code_selector(1);
	init_plot_type_selector();
	$("#open_info1").button({icon: "ui-icon-extlink",
        showLabel: false});
	$("#open_info1").button("disable");
	$("#add_row1").button({icon: "ui-icon-circle-plus",
        showLabel: false});
	$("#delete_row1").button({icon: "ui-icon-circle-minus",
        showLabel: false});
	$("#delete_row1").button("disable");
	sessionStorage.removeItem("add_row");
	setElementWidths();
	var event = new CustomEvent("cohortselector_init_complete", {
		detail: {
			cohort: $("#cohort_selector option:selected").val()
		}
	});
	document.getElementById("cohort_selector").dispatchEvent(event);
}

function init_dataselector(selector_id) {
	var total = $('#plot_options tr').length-1;
	var n = parseInt(selector_id.substr(4, selector_id.indexOf("_")-4));
	var datatypes = get_cohort_datatypes($("#cohort_selector option:selected").val());
	var empty = (datatypes.length == 0);
	if (!empty) {
		options = [];
		var datatypes_ids = [];
		for (i in datatypes) {
				options.push("<option value='"+ datatypes[i].datatype + "'>" + datatypes[i].name + "</option>");
				datatypes_ids.push(datatypes[i].datatype);
		}
		$("#" + selector_id).append(options.join("")).selectmenu({
			width: "120px"
		});
		var previous_selection = (getCookie(selector_id).split("|"))[0];
		if (datatypes_ids.includes(previous_selection)) {
			$("#" + selector_id).val(previous_selection);
			$("#" + selector_id).selectmenu( "refresh" );
		}
		var selector_value = $("#" + selector_id + " option:selected").val();
		usetCookie(selector_id, selector_value, druggable_cookie_time);
		$("#" + selector_id).off("selectmenuchange").on( "selectmenuchange", function( event, ui ) {update('type' + n + '_selector')} );
	}
	else {
		for (i = total; i>n; i--) {
			delete_plot_options_row(i);
		}
	}
	setElementWidths();
	var event = new CustomEvent("typeselector_init_complete", {
		detail: {
			type_selector: selector_id
		}
	});
	document.getElementById(selector_id).dispatchEvent(event);
	return empty;
}

function init_platformselector(selector_id) {
	var total = $('#plot_options tr').length-1;
	var n = parseInt(selector_id.substr(8, selector_id.indexOf("_")-8));
	var platforms = get_platforms($("#cohort_selector option:selected").val(), $("#type" + n + "_selector option:selected").val());
	//console.log(platforms);
	var empty = (platforms[1].length == 0);
	//console.log(empty);
	if (!empty) {
		// check if we have ids or no for the chosen datatype;
		// cannot use ?...:... here, because we need to shift platforms anyway
		var flag = parseInt(platforms.shift());
		// drugs are special case
		if (platforms[0][0].platform == "drug") {
			flag = 1;
		}
		document.getElementById("id" + n + "_input").disabled = !(flag);
		document.getElementById("id" + n + "_input").hidden = !(flag);
		document.getElementById("id" + n + "_confirmed").hidden = !(flag);
		// set placeholder text if ids exist
		if (flag == 1) {
			// placeholders are defined in druggable_config.js
			document.getElementById("id" + n + "_input").setAttribute("placeholder", ids_placeholders.get($("#type" + n + "_selector option:selected").val()));
		}
		options = [];
		for (i in platforms) {
			for (j in platforms[i]) {
				options.push("<option value='"+ platforms[i][j].platform + "'>" + platforms[i][j].name + "</option>");
			}
		}
		$("#" + selector_id).append(options.join("")).selectmenu({
			width: "175px"
		});
		var platforms_ids = [];
		for (i=0; i<platforms[0].length; i++) {
			platforms_ids.push(platforms[0][i]["platform"]);
		}
		var previous_selection = (getCookie(selector_id).split("|"))[0];
		if (platforms_ids.includes(previous_selection)) {
			$("#" + selector_id).val(previous_selection);
			$("#" + selector_id).selectmenu( "refresh" );
		}
		var selector_value = $("#" + selector_id + " option:selected").val();
		usetCookie(selector_id, selector_value, druggable_cookie_time);
		// get autocomplete_ids only if it is enabled
		if (flag) {
			var autocomplete_ids = get_autocomplete_ids ($("#cohort_selector option:selected").val(), $("#type" + n + "_selector option:selected").val(), $("#platform" + n + "_selector option:selected").val());
			$("#id" + n + "_input").tooltip({
				track: true
			});
			$("#id" + n + "_input").autocomplete({
				source: autocomplete_ids,
				minLength: 2,
				response: function( event, ui ) {
					if (ui.content.length > max_autocomplete) {
						console.log("We have " + ui.content.length + " elements, but cannot show more than " + max_autocomplete + ": closing autocomplete")
						$("#" + event.target.getAttribute("id")).autocomplete( "close" );
					} else {
						if (ui.content.length == 0) {
							$("#id" + n + "_input").attr("title", "No results found. Try typing something else");
						} else {
							$("#id" + n + "_input").attr("title", "");
						}
					}
				},
				search: function( event, ui ) {
					var value = $("#" + event.target.getAttribute("id")).val();
					console.log("Search triggered, value: " + value);
					if ((value.substr(0,2) == "EN") && (value.length <= 10)) {
						// check if we have > 2 symbols
						if (value.length > 2) {
							// if the THIRD symbol is S - it is probably ENSEMBL, otherwise - gene ifd (like EN1)
							if (value[2] == "S") {
								console.log("Looks like ENSEMBL and it is too short. Preventing search.");
								event.preventDefault();
							}
						}
						else {
							event.preventDefault();
						}
					}
				} 
			});
		}
		// needed to exclude bug: CLIN:race -> GE:agilent = disabled axis selector
		if ($('#axis'+ n + '_selector').data("uiSelectmenu")) {
			$('#axis'+ n + '_selector').find('option').remove().end();
			$('#axis'+ n + '_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
			init_axis_type_selector('axis'+ n + '_selector');
			$('#axis'+ n + '_selector').selectmenu( "refresh" );
		}
		$("#" + selector_id).off("selectmenuchange").on( "selectmenuchange", function( event, ui ) {update(selector_id)} );
	}
	else {
		for (i = total; i>n; i--) {
			delete_plot_options_row(i);
		}
	}
	setElementWidths();
	var event = new CustomEvent("platformselector_init_complete", {
		detail: {
			platform_selector: selector_id
		}
	});
	document.getElementById(selector_id).dispatchEvent(event);
	return empty;
}

function init_axis_type_selector(selector_id) {
	var n = selector_id.substr(4, selector_id.indexOf("_")-4);
	var axis_types = get_axis_types($("#cohort_selector option:selected").val(), $("#type" + n + "_selector option:selected").val(), $("#platform" + n + "_selector option:selected").val());
	options = [];
	for (i in axis_types) {
		options.push("<option value='"+ axis_types[i] + "'>" + axis_types[i] + "</option>");
	}
	var flag = (axis_types.length == 0);
	$("#" + selector_id).append(options.join("")).selectmenu({
        width: "95px",
		disabled: flag
    });
	// does not work properly
	$("#" + selector_id + "-button").qtip({ 
		content: {
			text: "Choose scale for this axis: linear, log or square root"
		}
	});
	$("#" + selector_id).off("selectmenuchange").on( "selectmenuchange", function( event, ui ) {
		var event = new CustomEvent("axisselector_update_complete", {
			detail: {
				axis_selector: selector_id
			}
		});
		document.getElementById(selector_id).dispatchEvent(event);
	} );
	setElementWidths();
	var event = new CustomEvent("axisselector_init_complete", {
		detail: {
			axis_selector: selector_id
		}
	});
	document.getElementById(selector_id).dispatchEvent(event);
}

function init_tcga_code_selector(n) {
	var total = $('#plot_options tr').length-1;
	// in this case 'previous' mean 'previous in time', not 'in order'
	// e.g. platform3_selector can be set before platform1_selector
	var previous_datatypes = [];
	var previous_platforms = [];
	for (j=1; j<=total; j++) {
		if (j != n) {
			previous_datatypes.push($("#type" + j +"_selector option:selected").val());
			previous_platforms.push($("#platform" + j +"_selector option:selected").val());
		}
	}
	// this can be modified - we don't need second variable anymore
	var codes = get_codes($("#source_selector option:selected").val(), $("#cohort_selector option:selected").val(), $("#type" + n + "_selector option:selected").val(), $("#platform" + n + "_selector option:selected").val(), previous_datatypes, previous_platforms);
	if (codes[0] != "") {
		options = [];
		for (i in codes) {
			options.push("<option value='"+ codes[i] + "'>" + codes[i] + "</option>");
		}
		// in case if we have 0 codes tcga_codes is [""]
		//var flag = (($("#source_selector option:selected").val() != "TCGA") || (tcga_codes[0] == ""));
		$("#tcga_selector").append(options.join("")).selectmenu({
			width: "100px",
			disabled: false
		});
	}
	else {
		$("#tcga_selector").selectmenu({
			width: "100px",
			disabled: true
		});
	}
	setElementWidths();
}

function init_plot_type_selector() {
	//console.log('init_plot_type_selector() invoked');
	var platforms = [];
	var n = $('#plot_options tr').length-1;
	for (i=1; i<=n; i++) {
		platforms.push($("#platform" + i + "_selector option:selected").val());
	}
	options = [];
	var plot_types = get_plot_types(platforms);
	if (plot_types[0] == '') {
		alert("Impossible combination, please choose another combination of platforms");
		report_event(((window.location.host.split(".")[0] == "dev") ? ("dev/") : "") + "druggable.html", "warning", "plot_types_missing", "platforms=" + platforms.join(), ErrorStack);	
	}
	for (i in plot_types) {
		options.push("<option value='"+ plot_types[i] + "'>" + plot_types[i] + "</option>");
	}
	$('#plot-type').append(options.join("")).selectmenu();
	$('#plot-type').off("selectmenuchange").on( "selectmenuchange", function( event, ui ) {plot_type_changed()} );
	plot_type_changed();
	var event = new CustomEvent("plotselector_init_complete", {
	});
	document.getElementById("plot-type").dispatchEvent(event);
}

function init_cor_source_selector(default_value) {
	// console.log(default_value);
	var sources = get_correlation_sources();
	var options = [];
	if (default_value != undefined) {
		var ind = sources.indexOf(default_value);
		// console.log(ind);
		if (ind >-1 ) {
			options.push("<option value='" + sources[ind] + "'>" + sources[ind] +"</option>");
			sources.splice(ind, 1);
			 
		}
	}
	//options.push("<option value='undef' disabled selected>Choose source</option>");
	for (i in sources) {
		options.push("<option value='" + sources[i] + "'>" + sources[i] +"</option>");
	}
	$("#corSource_selector").append(options.join("")).selectmenu(
	{
        width: "150px"
    });
	$('#corSource_selector').off().on( "selectmenuchange", function( event, ui ) {update("corSource_selector")} );
	setElementWidths();
	var event = new CustomEvent("corsourceselector_init_complete", {
		detail: {
			cor_source_selector: $('#corSource_selector option:selected').val()
		}
	});
	document.getElementById('corSource_selector').dispatchEvent(event);
}

function init_cor_datatype_selector() {
	var options = [];
	//options.push("<option value='undef' disabled selected>Choose datatype</option>");
	var cor_source = $("#corSource_selector option:selected").val();
	if (cor_source != "undef") {
		options.push("<option value='all'>All datatypes</option>");
		var datatypes = get_correlation_datatypes(cor_source);
		for (i in datatypes) {
			options.push("<option value='" + datatypes[i].datatype + "'>" + datatypes[i].name +"</option>");
		}
	}
	$("#corDatatype_selector").append(options.join("")).selectmenu(
	{
        width: "150px",
		disabled: cor_source == "undef"
    });
	$('#corDatatype_selector').off().on( "selectmenuchange", function( event, ui ) {update("corDatatype_selector")} );
	setElementWidths();
	var event = new CustomEvent("cortypeselector_init_complete", {
		detail: {
			cor_type_selector: $('#corDatatype_selector option:selected').val()
		}
	});
	document.getElementById('corDatatype_selector').dispatchEvent(event);
}

function init_cor_cohort_selector() {
	var options = [];
	//options.push("<option value='undef' disabled selected>Choose platform</option>");
	var cor_datatype = $("#corDatatype_selector option:selected").val();
	if (cor_datatype != "undef") {
		usetCookie("corDatatype_selector", cor_datatype, druggable_cookie_time);
		var cohorts = get_correlation_cohorts($("#corSource_selector option:selected").val(), cor_datatype);
		options.push("<option value='all'>All cohorts</option>");
		for (i in cohorts) {
			options.push("<option value='" + cohorts[i].cohort + "'>" + cohorts[i].name + "</option>");
		}
	}
	$("#corCohort_selector").append(options.join("")).selectmenu({
        width: "175px",
		disabled: $("#corSource_selector option:selected").val() == "CCLE"
    });
	$('#corCohort_selector').off().on( "selectmenuchange", function( event, ui ) {update("corCohort_selector")} );
	setElementWidths();
	var event = new CustomEvent("corcohortselector_init_complete", {
		detail: {
			cor_cohort_selector: $('#corCohort_selector option:selected').val()
		}
	});
	document.getElementById('corCohort_selector').dispatchEvent(event);
}

function init_cor_platform_selector() {
	var options = [];
	//options.push("<option value='undef' disabled selected>Choose platform</option>");
	var cor_datatype = $("#corDatatype_selector option:selected").val();
	var cor_cohort = $("#corCohort_selector option:selected").val();
	if (cor_cohort != "undef") {
		usetCookie("corCohort_selector", cor_cohort, druggable_cookie_time);
		var platforms = get_correlation_platforms($("#corSource_selector option:selected").val(), cor_datatype, cor_cohort);
		options.push("<option value='all'>All platforms</option>");
		for (i in platforms) {
			options.push("<option value='" + platforms[i].platform + "'>" + platforms[i].name +"</option>");
		}
	}
	$("#corPlatform_selector").append(options.join("")).selectmenu({
        width: "175px",
		disabled: cor_datatype == "undef"
    });
	$('#corPlatform_selector').off().on( "selectmenuchange", function( event, ui ) {update("corPlatform_selector")} );
	setElementWidths();
	var event = new CustomEvent("corplatformselector_init_complete", {
		detail: {
			cor_platform_selector: $('#corPlatform_selector option:selected').val()
		}
	});
	document.getElementById('corPlatform_selector').dispatchEvent(event);
}

// this function is also used for gene/feature autocomplete init
function init_cor_screen_selector() {
	var options = [];
	var cor_platform = $("#corPlatform_selector option:selected").val();
	if (cor_platform != "undef") {
		usetCookie("corPlatform_selector", cor_platform, druggable_cookie_time);
		var screens = get_correlation_screens($("#corSource_selector option:selected").val(), $("#corDatatype_selector option:selected").val(), $("#corCohort_selector option:selected").val(), cor_platform);
		options.push("<option value='all'>All screens</option>");
		for (i in screens) {
			options.push("<option value='" + screens[i] + "'>" + screens[i] +"</option>");
		}
	}
	$("#corScreen_selector").append(options.join("")).selectmenu({
		width: "150px",
		disabled: $("#corSource_selector option:selected").val() == "TCGA"
    });
	$("#retrieve-cor-button").button();
	setInputFilter(document.getElementById("FDR_input"), function(value) {
		return /^\d*\.?\d*$/.test(value);
	});
	$('#corScreen_selector').off().on( "selectmenuchange", function( event, ui ) {update("corScreen_selector")} );
	document.getElementById('FDR_input').setAttribute("onkeyup", 'cor_id_keyup()');
	document.getElementById('FDR_input').setAttribute("onchange", 'cor_id_keyup()');
	document.getElementById('corGeneFeature_input').setAttribute("onkeyup", 'cor_id_keyup()');
	document.getElementById('corGeneFeature_input').setAttribute("onchange", 'cor_id_keyup()');
	setElementWidths();
	var event = new CustomEvent("corscreenselector_init_complete", {
		detail: {
			cor_screen_selector: $('#corScreen_selector option:selected').val()
		}
	});
	document.getElementById('corScreen_selector').dispatchEvent(event);
}

function init_cor_genefeature_input() {
	document.getElementById("corGeneFeature_input").disabled = true;
	worker = new Worker("js/drug_id_grubber.js");
	console.log("Starting worker " + Date.now());
	worker.postMessage([$("#corSource_selector option:selected").val(), $("#corDatatype_selector option:selected").val(), $("#corCohort_selector option:selected").val(), $("#corPlatform_selector option:selected").val(), $("#corScreen_selector option:selected").val()]);
	worker.onmessage = function(event) {
		console.log("Received message from worker " + Date.now());
		$("#corGeneFeature_input").tooltip({
			track: true
		});
		var autocomplete_ids = event.data;
		$("#corGeneFeature_input").autocomplete({
			source: autocomplete_ids,
			minLength: 2,
			response: function( event, ui ) {
				// max_autocomplete defined in druggable_config.js
				if (ui.content.length > max_autocomplete) {
					console.log("We have " + ui.content.length + " elements, but cannot show more than " + max_autocomplete + ": closing autocomplete")
					$("#" + event.target.getAttribute("id")).autocomplete( "close" );
				} else {
					if (ui.content.length == 0) {
						$("#corGeneFeature_input").attr("title", "No results found. Try typing something else");
					} else {
						$("#corGeneFeature_input").attr("title", "");
					}
				}
			},
			search: function( event, ui ) {
				var value = $("#" + event.target.getAttribute("id")).val();
				console.log("Search triggered, value: " + value);
				if ((value.substr(0,2) == "EN") && (value.length <= 10)) {
					// check if we have > 2 symbols
					if (value.length > 2) {
						// if the THIRD symbol is S - it is probably ENSEMBL, otherwise - gene ifd (like EN1)
						if (value[2] == "S") {
							console.log("Looks like ENSEMBL and it is too short. Preventing search.");
							event.preventDefault();
						}
					}
					else {
						event.preventDefault();
					}
				}
			} 
		});
		worker.terminate();
		document.getElementById("corGeneFeature_input").disabled = false;
	}
}

function init_model_source_selector() {
	var sources = get_model_sources();
	var sources_ids = [];
	var options = [];
	for (i in sources) {
		options.push("<option value='" + sources[i] + "'>" + sources[i] +"</option>");
		sources_ids.push(sources[i]);
	}
	$("#modelSource_selector").append(options.join("")).selectmenu(
	{
        width: "150px"
    });
	$('#modelSource_selector').off("selectmenuchange").on( "selectmenuchange", function( event, ui ) {update("modelSource_selector")} );
	var previous_selection = (getCookie("modelSource_selector").split("|"))[0];
	if (sources_ids.includes(previous_selection)) {
		$("#modelSource_selector").val(previous_selection);
		$("#modelSource_selector").selectmenu( "refresh" );
	}
	usetCookie("modelSource_selector", $("#modelSource_selector option:selected").val(), druggable_cookie_time);
	setElementWidths();
}

function init_model_cohort_selector() {
	var options = [];
	var cohort_ids = [];
	var model_source = $("#modelSource_selector option:selected").val();
	var cohorts = get_model_cohorts($("#modelSource_selector option:selected").val());
	for (i in cohorts) {
		options.push("<option value='" + cohorts[i].cohort + "'>" + cohorts[i].name + "</option>");
		cohort_ids.push(cohorts[i].cohort);
	}
	$("#modelCohort_selector").append(options.join("")).selectmenu({
        width: "175px"
    });
	$('#modelCohort_selector').off("selectmenuchange").on( "selectmenuchange", function( event, ui ) {update("modelCohort_selector")} );
	var previous_selection = (getCookie("modelCohort_selector").split("|"))[0];
	if (cohort_ids.includes(previous_selection)) {
		$("#modelCohort_selector").val(previous_selection);
		$("#modelCohort_selector").selectmenu( "refresh" );
	}
	usetCookie("modelCohort_selector", $("#modelCohort_selector option:selected").val(), druggable_cookie_time);
	setElementWidths();
}

function init_model_datatype_selector(n) {
	var options = [];
	var model_source = $("#modelSource_selector option:selected").val();
	var model_cohort = $("#modelCohort_selector option:selected").val();
	var datatypes = get_model_datatypes(model_source, model_cohort);
	var datatypes_ids = [];
	for (i in datatypes) {
		options.push("<option value='" + datatypes[i].datatype + "'>" + datatypes[i].name +"</option>");
		datatypes_ids.push(datatypes[i].datatype);
	}
	$("#modelDatatype" + n + "_selector").append(options.join("")).selectmenu(
	{
        width: "auto",
		disabled: model_source == "undef"
    });
	$('#modelDatatype' + n + '_selector').off("selectmenuchange").on( "selectmenuchange", function( event, ui ) {update("modelDatatype" + n + "_selector")} );
	var previous_selection = (getCookie("modelDatatype" + n + "_selector").split("|"))[0];
	if (datatypes_ids.includes(previous_selection)) {
		$("#modelDatatype" + n + "_selector").val(previous_selection);
		$("#modelDatatype" + n + "_selector").selectmenu( "refresh" );
	}
	usetCookie("modelDatatype" + n + "_selector", $("#modelDatatype" + n + "_selector option:selected").val(), druggable_cookie_time);
	setElementWidths();
}

function init_model_platform_selector(n) {
	var options = [];
	var model_source = $("#modelSource_selector option:selected").val();
	var model_cohort = $("#modelCohort_selector option:selected").val();
	var model_datatype = $("#modelDatatype" + n + "_selector option:selected").val();
	var platforms = get_model_platforms(model_source, model_cohort, model_datatype);
	var platforms_ids = [];
	for (i in platforms) {
		options.push("<option value='" + platforms[i].platform + "'>" + platforms[i].name +"</option>");
		platforms_ids.push(platforms[i].platform);
	}
	$("#modelPlatform" + n + "_selector").append(options.join("")).selectmenu({
        width: "auto",
		disabled: model_datatype == "undef"
    });
	$('#modelPlatform' + n + '_selector').off("selectmenuchange").on( "selectmenuchange", function( event, ui ) {update("modelPlatform" + n + "_selector")} );
	var previous_selection = (getCookie("modelPlatform" + n + "_selector").split("|"))[0];
	if (platforms_ids.includes(previous_selection)) {
		$("#modelPlatform" + n + "_selector").val(previous_selection);
		$("#modelPlatform" + n + "_selector").selectmenu( "refresh" );
	}
	usetCookie("modelPlatform" + n + "_selector", $("#modelPlatform" + n + "_selector option:selected").val(), druggable_cookie_time);
	setElementWidths();
}

function init_model_genearea(n) {
	var model_cohort = $("#modelCohort_selector option:selected").val();
	var model_datatype = $("#modelDatatype" + n + "_selector option:selected").val();
	var model_platform = $("#modelPlatform" + n + "_selector option:selected").val();
	var flag = parseInt(ids_available(model_datatype));
	$("#genes_area" + n).val();
	document.getElementById("genes_area" + n).disabled = !(flag);
	document.getElementById("genes_area" + n).hidden = !(flag);
	if (flag) {
		var ids = get_autocomplete_ids(model_cohort, model_datatype, model_platform);
		// example from https://jqueryui.com/autocomplete/#multiple
		$("#genes_area" + n)
		// don't navigate away from the field on tab when selecting an item
			.on("keydown", function( event ) {
				if ( event.keyCode === $.ui.keyCode.TAB && $( this ).autocomplete( "instance" ).menu.active ) {
					event.preventDefault();
				}
			})
			.on("focus", function( event ) {
				console.log("gene_area" + n + " got focus");
				if (document.getElementById("transfer_window") != null) {
					$("#transfer_copy_ids").text("Copy chosen IDs to predictor " + n);
					$("#transfer_copy_ids").unbind();
					$("#transfer_copy_ids").on("click", function() {copy_ids_to_predictor(n);});
					$("#transfer_copy_ids").button("enable");
					$("#transfer_copy_all_ids").text("Copy all IDs to predictor " + n);
					$("#transfer_copy_all_ids").unbind();
					$("#transfer_copy_all_ids").on("click", function() {copy_all_ids_to_predictor(n);});
					$("#transfer_copy_all_ids").button("enable");
				}
			})
			.autocomplete({
				minLength: 2,
				response: function( event, ui ) {
					if (ui.content.length > max_autocomplete) {
						console.log("We have " + ui.content.length + " elements, but cannot show more than " + max_autocomplete + ": closing autocomplete")
						$("#" + event.target.getAttribute("id")).autocomplete( "close" );
					}
				},
			source: function( request, response ) {
				// delegate back to autocomplete, but extract the last term
				response( $.ui.autocomplete.filter(ids, extractLast( request.term ) ) );
			},
			focus: function() {
				// prevent value inserted on focus
				return false;
			},
			select: function( event, ui ) {
				var terms = split( this.value );
				// remove the current input
				terms.pop();
				// add the selected item
				terms.push( ui.item.value );
				// add placeholder to get the comma-and-space at the end
				terms.push( "" );
				this.value = terms.join( ", " );
				usetCookie("modelGenearea" + n, $("#genes_area" + n).val(), druggable_cookie_time);
				return false;
			}
		});
	}
}

function init_response_datatype_selector() {
	var options = [];
	var model_source = $("#modelSource_selector option:selected").val();
	var model_cohort = $("#modelCohort_selector option:selected").val();
	var datatypes = get_response_datatypes(model_source, model_cohort);
	var datatypes_ids = [];
	for (i in datatypes) {
		options.push("<option value='" + datatypes[i].datatype + "'>" + datatypes[i].name +"</option>");
		datatypes_ids.push(datatypes[i].datatype);
	}
	$("#responseDatatype_selector").append(options.join("")).selectmenu(
	{
        width: "150px"
    });
	$('#responseDatatype_selector').off("selectmenuchange").on( "selectmenuchange", function( event, ui ) {update("responseDatatype_selector")} );
	var previous_selection = (getCookie("responseDatatype_selector").split("|"))[0];
	if (datatypes_ids.includes(previous_selection)) {
		$("#responseDatatype_selector").val(previous_selection);
		$("#responseDatatype_selector").selectmenu( "refresh" );
	}
	usetCookie("responseDatatype_selector", $("#responseDatatype_selector option:selected").val(), druggable_cookie_time);
	setElementWidths();
}

function init_response_variable_selector() {
	var options = [];
	var model_source = $("#modelSource_selector option:selected").val();
	var model_cohort = $("#modelCohort_selector option:selected").val();
	var response_datatype = $("#responseDatatype_selector option:selected").val();
	$("#responseID_input").val("");
	var variables = get_response_variables(model_source, model_cohort, response_datatype);
	var flag = parseInt(variables.shift());
	document.getElementById("responseID_input").disabled = !(flag);
	document.getElementById("responseID_input").hidden = !(flag);
	// set placeholder text if ids exist
	if (flag == 1) {
		// placeholders are defined in druggable_config.js
		document.getElementById("responseID_input").setAttribute("placeholder", ids_placeholders.get(response_datatype));
	}
	var variable_ids = [];
	for (i in variables) {
		for (j in variables[i]) {
			options.push("<option value='" + variables[i][j].variable + "'>" + variables[i][j].name + " (N=" + variables[i][j].n + ")" + "</option>");
			variable_ids.push(variables[i][j].variable);
		}
	}
	$("#responseVariable_selector").append(options.join("")).selectmenu();
	$('#responseVariable_selector').off("selectmenuchange").on( "selectmenuchange", function( event, ui ) {update("responseVariable_selector")} );
	var previous_selection = (getCookie("responseVariable_selector").split("|"))[0];
	if (variable_ids.includes(previous_selection)) {
		$("#responseVariable_selector").val(previous_selection);
		$("#responseVariable_selector").selectmenu( "refresh" );
	}
	usetCookie("responseVariable_selector", $("#responseVariable_selector option:selected").val(), druggable_cookie_time);
	setElementWidths();
	if (flag == 1) {
		$("#responseID_input").tooltip({
				track: true
			});
		var autocomplete_ids = get_autocomplete_ids(model_cohort, response_datatype, $("#responseVariable_selector option:selected").val());
		$("#responseID_input").autocomplete({
			source: autocomplete_ids,
			minLength: 2,
			response: function( event, ui ) {
				if (ui.content.length > max_autocomplete) {
					console.log("We have " + ui.content.length + " elements, but cannot show more than " + max_autocomplete + ": closing autocomplete")
					$("#" + event.target.getAttribute("id")).autocomplete( "close" );
				} else {
					if (ui.content.length == 0) {
						$("#responseID_input").attr("title", "No results found. Try typing something else");
					} else {
						$("#responseID_input").attr("title", "");
					}
				}
			},
			search: function( event, ui ) {
				var value = $("#" + event.target.getAttribute("id")).val();
				console.log("Search triggered, value: " + value);
				if ((value.substr(0,2) == "EN") && (value.length <= 10)) {
					// check if we have > 2 symbols
					if (value.length > 2) {
						// if the THIRD symbol is S - it is probably ENSEMBL, otherwise - gene ifd (like EN1)
						if (value[2] == "S") {
							console.log("Looks like ENSEMBL and it is too short. Preventing search.");
							event.preventDefault();
						}
					}
					else {
						event.preventDefault();
					}
				}
			} 
		});
	}
}

function init_response_multiselector() {
	var options = [];
	var model_source = $("#modelSource_selector option:selected").val();
	var model_cohort = $("#modelCohort_selector option:selected").val();
	var response_datatype = $("#responseDatatype_selector option:selected").val();
	var response_variable = $("#responseVariable_selector option:selected").val();
	if (response_variable == "undef") {
		response_variable = "";
	}
	var values = [];
	if ((model_source == "TCGA") & (response_datatype == "CLIN")) {
		values = [{val: "01", n: "all"} , {val: "06", n: "all"}];
	}
	else {
		values = get_response_multiselector_values(model_source, model_cohort, response_datatype, response_variable);
	}
	//console.log(values);
	for (i in values) {
		options.push("<option value='" + values[i].val + "'>" + values[i].val + (values[i].n != "all" ? (" (n=" + values[i].n + ")") : "") +"</option>");
	}
	$("#responseMulti_selector").append(options.join(""));
    document.getElementById("responseMulti_selector").disabled = (values[0] == "");
	//var previous_selection = (getCookie("responseMulti_selector").split("|"))[0];
	//console.log(previous_selection);
	//if (values.includes(previous_selection)) {
	//	$("#responseMulti_selector").val(previous_selection);
	//	$("#responseMulti_selector").selectmenu( "refresh" );
	//}
	setElementWidths();
	usetCookie("responseMulti_selector", $("#responseMulti_selector").val(), druggable_cookie_time);
}

function init_glmnet_family_selector() {
	var options = [];
	var response_datatype = $("#responseDatatype_selector option:selected").val();
	var response_variable = $("#responseVariable_selector option:selected").val();
	var families = get_glmnet_family(response_variable, response_datatype);
	for (i in families) {
		options.push("<option value='" + families[i] + "'>" + families[i] +"</option>");
	}
	$("#family").append(options.join("")).selectmenu();
}

function update_source() {
	var selector_value = $("#source_selector option:selected").val();
	usetCookie("source", selector_value, druggable_cookie_time);
	$('#cohort_selector').find('option').remove().end();
	$('#cohort_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_cohortselector();
	update_cohort();
}

function update_cohort() {
	var selector_value = $("#cohort_selector option:selected").val();
	usetCookie("cohort", selector_value, druggable_cookie_time);
	$('#type1_selector').find('option').remove().end();
	$('#type1_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	sessionStorage.setItem("add_row", 1);
	$('#type1_selector').find('option').remove().end();
	$('#type1_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_dataselector('type1_selector');
	$('#type1_selector').selectmenu( "refresh" );
	$('#platform1_selector').find('option').remove().end();
	$('#platform1_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_platformselector('platform1_selector');
	$('#platform1_selector').selectmenu( "refresh" );
	$('#tcga_selector').find('option').remove().end();
	$('#tcga_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_tcga_code_selector(1);
	$('#tcga_selector').selectmenu( "refresh" );
	sessionStorage.removeItem("add_row");
	$('#id1_input').val("");
	update_plot_types();
	plot_type_changed();
	var event = new CustomEvent("cohortselector_update_complete", {
		detail: {
			cohort: $("#cohort_selector option:selected").val()
		}
	});
	document.getElementById("cohort_selector").dispatchEvent(event);
	
}

function update_type(n) {
	// use this to identify exit code
	var status = 'ok';
	if (sessionStorage.getItem("add_row") == null) {
		var selector_value = $("#type" + n + "_selector option:selected").val();
		var previous_value = (getCookie("type" + n + "_selector").split("|"))[0];
		if (selector_value != previous_value) {
			usetCookie("type" + n + "_selector", selector_value, druggable_cookie_time);
			n = parseInt(n);
			$('#id' + n + '_input').val("");
			if ($("#source_selector").val() == "TCGA") {
				//console.log("Updating TCGA selector number " + i + " out of " + total + " Initator: platform" + n + "_selector");
				$('#tcga_selector').find('option').remove().end();
				$('#tcga_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
				init_tcga_code_selector(n);
				$('#tcga_selector').selectmenu( "refresh" );
			}
			$('#platform' + n + '_selector').find('option').remove().end();
			$('#platform' + n + '_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
			init_platformselector('platform' + n + '_selector');
			$('#platform'+ n + '_selector').selectmenu( "refresh" );
			var total = $('#plot_options tr').length-1;
			if (n<total) {
				$('#type'+ (n+1) + '_selector').find('option').remove().end();
				$('#type'+ (n+1) + '_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
				init_dataselector('type' + (n+1) + '_selector');
				$('#type' + (n+1) + '_selector').selectmenu( "refresh" );
			}
		}
	}
	var event = new CustomEvent("typeselector_update_complete", {
		detail: {
			datatype: $("#type" + n + "_selector option:selected").val()
		}
	});
	document.getElementById("type" + n + "_selector").dispatchEvent(event);
	return status;
}

function update_platform(n) {
	if (sessionStorage.getItem("add_row") == null) {
		var selector_value = $("#platform" + n + "_selector option:selected").val();
		var previous_value = (getCookie("platform" + n + "_selector").split("|"))[0];
		if (selector_value != previous_value) {
			// this works in FF, but not in Chrome - it decides to "cut the corner" when not in debug mode
			//$( "#platform" + n + "_selector" ).selectmenu( "option", "icons", { button: "ui-icon ui-icon-loading-status-balls rotate" } );
			// instead, we have to use this awkward solution
			var x = $("#platform" + n + "_selector-button").children()[0];
			x.className = "ui-icon ui-icon-loading-status-balls rotate";
			//$(".main_header").addClass("ajax_loading");
			usetCookie("platform" + n + "_selector", selector_value, druggable_cookie_time);
			n = parseInt(n);
			$("#id" + n + "_input").val("");
			if (sessionStorage.getItem("update_autocomplete") == null) {
				var autocomplete_ids = get_autocomplete_ids ($("#cohort_selector option:selected").val(), $("#type" + n + "_selector option:selected").val(), $("#platform" + n + "_selector option:selected").val());
				$("#id" + n + "_input").tooltip({
					track: true
				});
				$("#id" + n + "_input").autocomplete({
					source: autocomplete_ids,
					minLength: 2,
					response: function( event, ui ) {
						if (ui.content.length > max_autocomplete) {
							console.log("We have " + ui.content.length + " elements, but cannot show more than " + max_autocomplete + ": closing autocomplete")
							$("#" + event.target.getAttribute("id")).autocomplete( "close" );
						} else {
							if (ui.content.length == 0) {
								$("#id" + n + "_input").attr("title", "No results found. Try typing something else");
							} else {
								$("#id" + n + "_input").attr("title", "");
							}
						}
					},
					search: function( event, ui ) {
						var value = $("#" + event.target.getAttribute("id")).val();
						console.log("Search triggered, value: " + value);
						if ((value.substr(0,2) == "EN") && (value.length <= 10)) {
							// check if we have > 2 symbols
							if (value.length > 2) {
								// if the THIRD symbol is S - it is probably ENSEMBL, otherwise - gene ifd (like EN1)
								if (value[2] == "S") {
									console.log("Looks like ENSEMBL and it is too short. Preventing search.");
									event.preventDefault();
								}
							}
							else {
								event.preventDefault();
							}
						}
					} 
				});
			}
			$('#axis'+ n + '_selector').find('option').remove().end();
			$('#axis'+ n + '_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
			init_axis_type_selector('axis'+ n + '_selector');
			$('#axis'+ n + '_selector').selectmenu( "refresh" );
			var source = $("#source_selector option:selected").val();
			var total = $('#plot_options tr').length-1;
			if (n<total) {
				$('#platform' + (n+1) + '_selector').find('option').remove().end();
				$('#platform' + (n+1) + '_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
				var flag = init_platformselector('platform' + (n+1) + '_selector');
				if (flag) {
					alert("No more compatible platforms");
					sessionStorage.setItem("cascade_delete", 1);
					for (i=total; i>n; i--) {
						delete_plot_options_row(i);
					}
					sessionStorage.removeItem("cascade_delete");
				}
				$('#platform' + (n+1) + '_selector').selectmenu( "refresh" );
				selector_value = $("#platform" + (n+1) + "_selector option:selected").val();
				previous_value = (getCookie("platform" + (n+1) + "_selector").split("|"))[0];
				if (selector_value != previous_value) {
					$("#id" + (n+1) + "_input").val("");
				}
			}
			// this works in FF, but not in Chrome - it decides to "cut the corner" when not in debug mode
			//$( "#platform" + n + "_selector" ).selectmenu( "option", "icons", { button: "ui-icon ui-icon-triangle-1-s" } );
			x.className = "ui-icon ui-icon-triangle-1-s";
			//$(".main_header").removeClass("ajax_loading");
			plot_type_changed();
		}
		$('#tcga_selector').find('option').remove().end();
		$('#tcga_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
		// not a good solution
		init_tcga_code_selector(n);
		$('#tcga_selector').selectmenu( "refresh" );
		// do not move this operation - otherwise will cause bug
		id_keyup(n);
		var event = new CustomEvent("platformselector_update_complete", {
			detail: {
				platform: $("#platform" + n + "_selector option:selected").val()
			}
		});
		document.getElementById("platform" + n + "_selector").dispatchEvent(event);
	}
}

function update_plot_type_selector() {
	console.log('update_plot_type_selector() invoked');
	var platforms = [];
	var n = $('#plot_options tr').length-1;
	for (i=1; i<=n; i++) {
		platforms.push($("#platform" + i + "_selector option:selected").val());
	}
	options = [];
	var plot_types = get_plot_types(platforms);
	for (i in plot_types) {
		options.push("<option value='"+ plot_types[i] + "'>" + plot_types[i] + "</option>");
	}
	$('#plot-type').append(options.join("")).selectmenu({
        width: "120px"
    });
	$('#plot-type').off("selectmenuchange").on( "selectmenuchange", function( event, ui ) {plot_type_changed()} );
	plot_type_changed();
}

function update_cor_source_selector() {
	var selector_value = $("#corSource_selector option:selected").val();
	usetCookie("corSource_selector", selector_value, druggable_cookie_time);
	$('#corGeneFeature_input').val("");
	$('#corDatatype_selector').find('option').remove().end();
	$('#corDatatype_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_cor_datatype_selector();
	$('#corDatatype_selector').selectmenu( "refresh" );
}

function update_cor_datatype_selector() {
	var selector_value = $("#corDatatype_selector option:selected").val();
	usetCookie("corDatatype_selector", selector_value, druggable_cookie_time);
	$('#corCohort_selector').find('option').remove().end();
	$('#corCohort_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_cor_cohort_selector();
	$('#corCohort_selector').selectmenu( "refresh" );
}

function update_cor_cohort_selector() {
	var selector_value = $("#corCohort_selector option:selected").val();
	usetCookie("corCohort_selector", selector_value, druggable_cookie_time);
	$('#corPlatform_selector').find('option').remove().end();
	$('#corPlatform_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_cor_platform_selector();
	$('#corPlatform_selector').selectmenu( "refresh" );
}

function update_cor_platform_selector() {
	// here we don't compare previous value and current - previous value can be "all", but the function can be called by datatype change
	var selector_value = $("#corPlatform_selector option:selected").val();
	usetCookie("corPlatform_selector", selector_value, druggable_cookie_time);
	$('#corScreen_selector').find('option').remove().end();
	$('#corScreen_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_cor_screen_selector();
	$('#corScreen_selector').selectmenu( "refresh" );
	if ($("#corScreen_selector").is(":disabled")) {
		init_cor_genefeature_input();
	}
}

function update_cor_screen_selector() {
	if (!$("#corScreen_selector").is(":disabled")) {
		// do not allow input in any case (normal selector value or "undef")
		document.getElementById("corGeneFeature_input").disabled = true;
		$("#corGeneFeature_input").val("");
		document.getElementById("FDR_input").disabled = true;
		var selector_value = $("#corScreen_selector option:selected").val();
		if (selector_value != "undef") {
			// do not allow changing datatype/platform/screen etc. until this request is not complete
			$("#corScreen_selector").selectmenu("disable");
			$("#corDatatype_selector").selectmenu("disable");
			$("#corCohort_selector").selectmenu("disable");
			$("#corPlatform_selector").selectmenu("disable");
			$("#corScreen_selector").selectmenu("disable");
			usetCookie("corScreen_selector", selector_value, druggable_cookie_time);
			init_cor_genefeature_input();
			$("#corDatatype_selector").selectmenu("enable");
			if ($("#corSource_selector option:selected").val() != "CCLE") {
				$("#corCohort_selector").selectmenu("enable");
			}
			$("#corPlatform_selector").selectmenu("enable");
			if ($("#corSource_selector option:selected").val() != "TCGA") {
				$("#corScreen_selector").selectmenu("enable");
			}
			document.getElementById("corGeneFeature_input").disabled = false;
			document.getElementById("FDR_input").disabled = false;
			cor_id_keyup();
		}
	}
}

function update_model_source_selector() {
	var selector_value = $("#modelSource_selector option:selected").val();
	usetCookie("modelSource_selector", selector_value, druggable_cookie_time);
	$('#modelCohort_selector').find('option').remove().end();
	$('#modelCohort_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_model_cohort_selector();
	$('#modelCohort_selector').selectmenu( "refresh" );
	var event = new CustomEvent("modelsourceselector_update_complete", {
		detail: {
			source: $("#modelSource_selector option:selected").val()
		}
	});
	document.getElementById("modelSource_selector").dispatchEvent(event);
}

function update_model_cohort_selector() {
	var selector_value = $("#modelCohort_selector option:selected").val();
	usetCookie("modelCohort_selector", selector_value, druggable_cookie_time);
	$('#modelDatatype1_selector').find('option').remove().end();
	$('#modelDatatype1_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_model_datatype_selector(1);
	$('#responseDatatype_selector').selectmenu( "refresh" );
	$('#responseDatatype_selector').find('option').remove().end();
	$('#responseDatatype_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_response_datatype_selector(1);
	$('#responseDatatype_selector').selectmenu( "refresh" );
	var event = new CustomEvent("modelcohortselector_update_complete", {
		detail: {
			cohort: $("#modelCohort_selector option:selected").val()
		}
	});
	document.getElementById("modelCohort_selector").dispatchEvent(event);
}

function update_model_datatype_selector(n) {
	var selector_value = $("#modelDatatype" + n + "_selector option:selected").val();
	usetCookie("modelDatatype" + n + "_selector", selector_value, druggable_cookie_time);
	check_model_unique_variable(n);
	$('#modelPlatform' + n + '_selector').find('option').remove().end();
	$('#modelPlatform' + n + '_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_model_platform_selector(n);
	$('#modelPlatform' + n + '_selector').selectmenu( "refresh" );
	var event = new CustomEvent("modeltypeselector_update_complete", {
		detail: {
			datatype: $("#modelDatatype" + n + "_selector option:selected").val()
		}
	});
	document.getElementById("modelDatatype" + n + "_selector").dispatchEvent(event);
}

function update_model_platform_selector(n) {
	var selector_value = $("#modelPlatform" + n + "_selector option:selected").val();
	usetCookie("modelPlatform" + n + "_selector", selector_value, druggable_cookie_time);
	init_model_genearea(n);
	var event = new CustomEvent("modelplatformselector_update_complete", {
		detail: {
			platform: $("#modelPlatform" + n + "_selector option:selected").val()
		}
	});
	document.getElementById("modelPlatform" + n + "_selector").dispatchEvent(event);
}

function update_response_datatype_selector() {
	var selector_value = $("#responseDatatype_selector option:selected").val();
	usetCookie("responseDatatype_selector", selector_value, druggable_cookie_time);
	$('#responseVariable_selector').find('option').remove().end();
	$('#responseVariable_selector').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_response_variable_selector();
	$('#responseVariable_selector').selectmenu( "refresh" );
}

function update_response_variable_selector() {
	var selector_value = $("#responseVariable_selector option:selected").val();
	usetCookie("responseVariable_selector", selector_value, druggable_cookie_time);
	var length = document.getElementById("responseMulti_selector").options.length;
	for (var i = length-1; i >= 0; i--) {
		document.getElementById("responseMulti_selector").options[i] = null;
	}
	$('#family').find('option').remove().end();
	$('#family').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_glmnet_family_selector();
	$('#family').selectmenu( "refresh" );
	init_response_multiselector();
}

// WARNING! Use this function with extreme caution! It is a potential source of bugs
// e.g. it can hide input, but cannot set it visible back
// however, it is ok for current conditions
function plot_type_changed() {
	var total = $('#plot_options tr').length-1;
	// see druggable_config.js for variable definition
	var platforms = hidden_inputs.get($('#plot-type option:selected').val());
	if (typeof(platforms) != 'undefined') {
		for (i=1; i<=total; i++) {
			if (platforms.includes($("#platform" + i + "_selector option:selected").val())) {
				$("#id" + i + "_input").val("");
				document.getElementById("id" + i + "_input").hidden = true;
				document.getElementById("id" + i + "_confirmed").hidden = true;
			}
		}
	}
	var event = new CustomEvent("plottype_changed", {
		detail: {
			plot_type: $('#plot-type option:selected').val()
		}
	});
	document.getElementById("plot-type").dispatchEvent(event);
}

function update_plot_types() {
	$('#plot-type').find('option').remove().end();
	$('#plot-type').selectmenu('destroy').selectmenu({ style: 'dropdown' });
	init_plot_type_selector()
	$('#plot-type').selectmenu( "refresh" );
}

// this function has to be called by nearly every selector
// instead of using update chain
function update(initiator) {
	// if update in process - do nothing
	if (sessionStorage.getItem("updates_triggered") != null) {
		console.log("Update invoked, but rejected. Initiator: " + initiator + ". Reason: update already in progress.");
	}
	else {
		console.log("Update succesfully invoked by initiator: " + initiator);
		sessionStorage.setItem("updates_triggered", 1);
		var previous_value = (getCookie(initiator).split("|"))[0];
		usetCookie(initiator, selector_value, druggable_cookie_time);
		var selector_value = $("#" + initiator + " option:selected").val();
		var initiator_type = (initiator.split("_"))[0];
		var total = $('#plot_options tr').length-1;
		var n = parseInt(initiator_type[initiator_type.length - 1]);
		// type, platform etc. selectors contain numbers, but source selector does not
		if (!isNaN(n)) {
			initiator_type = initiator_type.slice(0, -1);
		}
		switch(initiator_type) {
			case "source":
				update_source();
				break;
			case "cohort":
				update_cohort();
				break;
			case "type":
				if (selector_value != previous_value) {
					toggle_selectors("disable");
					var status = update_type(n);
					console.log(status);
					if (status != 'deleted') {
						// use this to avoid double-update
						sessionStorage.setItem("update_autocomplete", "false");
						update_platform(n);
						for (var i=n+1; i<=total; i++) {
							update_type(i);
							update_platform(i);
						}
						update_plot_types();
						sessionStorage.removeItem("update_autocomplete");
					}
					toggle_selectors("enable");
				}
				var event = new CustomEvent("typeselector_update_complete", {
					detail: {
						datatype: $("#type" + n + "_selector option:selected").val()
					}
				});
				document.getElementById("type" + n + "_selector").dispatchEvent(event);
				break;
			case "platform":
				if (selector_value != previous_value) {
					toggle_selectors("disable");
					update_platform(n);
					for (var i=n+1; i<=total; i++) {
						update_platform(i);
					}
					update_plot_types();
					toggle_selectors("enable");
				}
				var event = new CustomEvent("platformselector_update_complete", {
					detail: {
						platform: $("#platform" + n + "_selector option:selected").val()
					}
				});
				document.getElementById("platform" + n + "_selector").dispatchEvent(event);
				break;
			case "corSource":
				if (selector_value != previous_value) {
					update_cor_source_selector();
					update_cor_datatype_selector();
					update_cor_cohort_selector();
					update_cor_platform_selector();
				} 
				var event = new CustomEvent("corsourceselector_update_complete", {
					detail: {
						source: $("#corSource_selector option:selected").val()
					}
				});
				document.getElementById("corSource_selector").dispatchEvent(event);
				break;
			case "corDatatype":
				if (selector_value != previous_value) {
					update_cor_datatype_selector();
					update_cor_cohort_selector();
					update_cor_platform_selector();
					update_cor_screen_selector();
				}
				var event = new CustomEvent("cortypeselector_update_complete", {
					detail: {
						datatype: $("#corDatatype_selector option:selected").val()
					}
				});
				document.getElementById("corDatatype_selector").dispatchEvent(event);
				break;
			case "corCohort":
				if (selector_value != previous_value) {
					update_cor_cohort_selector();
					update_cor_platform_selector();
					update_cor_screen_selector();
				}
				var event = new CustomEvent("corcohortselector_update_complete", {
					detail: {
						cohort: $("#corCohort_selector option:selected").val()
					}
				});
				document.getElementById("corCohort_selector").dispatchEvent(event);
				break;
			case "corPlatform":
				update_cor_platform_selector();
				update_cor_screen_selector();
				var event = new CustomEvent("corplatformselector_update_complete", {
					detail: {
						platform: $("#corPlatform_selector option:selected").val()
					}
				});
				document.getElementById("corPlatform_selector").dispatchEvent(event);
				break;
			case "corScreen":
				update_cor_screen_selector();
				var event = new CustomEvent("corscreenselector_update_complete", {
					detail: {
						screen: $("#corScreen_selector option:selected").val()
					}
				});
				document.getElementById("corScreen_selector").dispatchEvent(event);
				break;
			case "modelSource":
				if (selector_value != previous_value) {
					update_model_source_selector();
					update_model_cohort_selector();
					update_model_datatype_selector(1);
					update_model_platform_selector(1);
					update_response_datatype_selector();
					update_response_variable_selector();
				}
				break;
			case "modelCohort":
				if (selector_value != previous_value) {
					update_model_cohort_selector();
					update_model_datatype_selector(1);
					update_model_platform_selector(1);
					update_response_datatype_selector();
					update_response_variable_selector();
				}
				break;
			case "modelDatatype":
				if (selector_value != previous_value) {
					update_model_datatype_selector(n);
					update_model_platform_selector(n);
				}
				break;
			case "modelPlatform":
				if (selector_value != previous_value) {
					update_model_platform_selector(n);
				}
				break;
			case "responseDatatype":
				if (selector_value != previous_value) {
					update_response_datatype_selector();
					update_response_variable_selector();
				}
				break;
			case "responseVariable":
				if (selector_value != previous_value) {
					update_response_variable_selector();
				}
				break;
		}
		sessionStorage.removeItem("updates_triggered");
	}
}

function history() {
	var keys = Object.keys(sessionStorage);
	for (key in keys) {
		if (keys[i].includes("tmp")) {
			console.log(keys[key] + " : " + sessionStorage.getItem(keys[key]));
		}
	}
}

function find_plot_in_history(plot_description) {
	var keys = Object.keys(sessionStorage);
	var res = "no";
	for (i in keys) {
		if (keys[i].includes("tmp")) {
			if (sessionStorage.getItem(keys[i]) == plot_description) {
				res = keys[i];
			}
		}
	}
	return res;
}

function move_plot_to_dock(graph_id, plot_filename, meta) {
	//CHANGE:
	//var graph_id = graph_window.id.replace("#", "");
	
	var docked_id = Date.now();

		var addButtons = 	"<td><button type=\'button\' class=\'ui-button ui-corner-all ui-widget ui-button-icon-only\' title=\'Restore plot\' onclick=\"plot_maximize(\'" + plot_filename + "\',\'" + docked_id + "\')\"><span class=\'ui-button-icon ui-icon ui-icon-window\'></span><span class=\'ui-button-icon-space\'> </span></button></td>"
		+ 
		"<td><button type=\'button\' class=\'ui-button ui-corner-all ui-widget ui-button-icon-only\' title=\'Copy link\' onclick=\"copy_plot_link(\'" + plot_filename + "\')\"><span class=\'ui-button-icon ui-icon ui-icon-link\'></span><span class=\'ui-button-icon-space\'> </span></button></td>" 
		+
		"<td><button type=\'button\' class=\'ui-button ui-corner-all ui-widget ui-button-icon-only\' title=\'Delete plot\' onclick=\"remove_plot_from_history(\'" + docked_id + "\',\'" + plot_filename + "\')\"><span class=\'ui-button-icon ui-icon ui-icon-trash-b\'></span><span class=\'ui-button-icon-space\'> </span></button></td>";
	
	meta = meta.replace("<tr>", "<tr id='" + docked_id + "'>");
	meta = meta.replace("</tr>", addButtons + "</tr>");
	var new_row = $(meta);
	var t1 = $('#sidebar_table').DataTable();
	var rowNode = t1.row.add(new_row).draw().node();
	//$( rowNode ).css({'color': 'red'} ).animate({"color": 'black' }, 2000);
	$( rowNode ).addClass('rowhighlight').removeClass('rowhighlight', 2000);
}

function restore_history_dock() {
	var keys = Object.keys(sessionStorage);
	for (i in keys) {
		if ((keys[i].includes("tmp")) & (!keys[i].includes("meta"))) {
			var plot_filename = keys[i];
			var raw_metadata = sessionStorage.getItem('meta_' + plot_filename);
			//console.log(raw_metadata);
			if (raw_metadata != null) {
				var metadata = generate_plot_data(JSON.parse(raw_metadata));
				metadata = metadata["meta"];
				var docked_id = Date.now();

				var addButtons = 	"<td><button type=\'button\' class=\'ui-button ui-corner-all ui-widget ui-button-icon-only\' title=\'Restore plot\' onclick=\"plot_maximize(\'" + plot_filename + "\',\'" + docked_id + "\')\"><span class=\'ui-button-icon ui-icon ui-icon-window\'></span><span class=\'ui-button-icon-space\'> </span></button></td>" + 
									"<td><button type=\'button\' class=\'ui-button ui-corner-all ui-widget ui-button-icon-only\' title=\'Copy link\' onclick=\"copy_plot_link(\'" + plot_filename + "\')\"><span class=\'ui-button-icon ui-icon ui-icon-link\'></span><span class=\'ui-button-icon-space\'> </span></button></td>"  +
									"<td><button type=\'button\' class=\'ui-button ui-corner-all ui-widget ui-button-icon-only\' title=\'Delete plot\' onclick=\"remove_plot_from_history(\'" + docked_id + "\',\'" + plot_filename + "\')\"><span class=\'ui-button-icon ui-icon ui-icon-trash-b\'></span><span class=\'ui-button-icon-space\'> </span></button></td>";
	
				metadata = metadata.replace("<tr>", "<tr id='" + docked_id + "'>");
				metadata = metadata.replace("</tr>", addButtons + "</tr>");
				var new_row = $(metadata);
				var t1 = $('#sidebar_table').DataTable();
				var rowNode = t1.row.add(new_row).draw().node();
			}
		}
	}
}

function plot_maximize(plot_filename, docked_id) {
	var plot_description = sessionStorage.getItem(plot_filename);
	var plot_params = plot_description.split("|");
	var plot_type = plot_params[0].split(":")[1];
	var source = plot_params[1].split(":")[1];
	var cohort = plot_params[2].split(":")[1];
	var datatypes = plot_params[3].split(":")[1].split(",");
	var platforms = plot_params[4].split(":")[1].split(",");
	var ids = plot_params[5].split(":")[1].split(",");
	var code = plot_params[6].split(":")[1];
	var scales = plot_params[7].split(":")[1].split(",");
	plot(plot_type, source, cohort, datatypes, platforms, ids, scales, code);
}

// remove plot from dock and check if dock should be closed or not
function remove_plot_from_history(docked_id, plot_filename) {
	sessionStorage.removeItem(plot_filename);
	sessionStorage.removeItem("meta_" + plot_filename);
	var t1 = $('#sidebar_table').DataTable();
	t1.row("#" + docked_id).remove().draw();
	if (!t1.data().any()) {
		close_dock();
	}
}

function copy_plot_link(plot_filename) {
	navigator.clipboard.writeText("https://www.evinet.org/pics/plots/" + plot_filename);
	alert("The direct link for the plot has been coppied to the clipboard. You can copy it manually: https://www.evinet.org/pics/plots/" + plot_filename);
	mark_plot(plot_filename);
}

function open_dock() {
  document.getElementById("sidebar_dock").style.width = "30%";
}

function close_dock() {
  document.getElementById("sidebar_dock").style.width = "0";
}

// show panel with help table containing information about available cohorts etc.
function toggle_help_table() {
	if($("#help_data_sources").is(":visible")) {
		$("#help_data_sources").hide();
		$("#help_table_toggle").text("Show available data");
	}
	else {
		// load table only once
		if (document.getElementById('help_data_sources').rows.length == 0) {
			var table_request = new XMLHttpRequest();
			table_request.open("GET", "https://dev.evinet.org/cgi/generate_help_table.cgi", false);
			table_request.send();
			table_content = table_request.responseText;
			document.getElementById("help_data_sources").innerHTML = table_content;
		}
		$("#help_data_sources").show();
		$("#help_table_toggle").text("Hide available data");
	}
}

function close_help_table() {
	$("#help_data_sources").hide();
}

function open_info_page(id) {
	var external_id = $("#id" + id + "_input").val();
	var url = get_url(external_id);
	if (url == "") {
		console.log("Failed to retrieve url for external_id " + external_id + ". Using default value.");
		url = "https://www.google.com/search?q=" + external_id;
	}
	window.open(url, "_blank");
}

// this function is used to transfer IDs from the second tab (correlates) to independent variables of the fourth tab 
function transfer_id (source, cohort, datatype, platform, id) {
	show_transfer_buffer_window("#tab-signif");
	var current_ids = sessionStorage.getItem("transfer");
	var t = $('#transfer_buffer_table').DataTable();
	if (current_ids == null) {
		sessionStorage.setItem("transfer", [id, platform, datatype, cohort, source]);
		t.row.add([
			"",
			id,
			platform,
			datatype,
			cohort,
			source
			]).draw(false);
	}
	else {
		current_ids = current_ids.split(",");
		var flag = false;
		for (i = 0; i < current_ids.length - 1; i = i+5) {
			if ((current_ids[i] == id) && 
				(current_ids[i+1] == platform) && 
				(current_ids[i+2] == datatype) && 
				(current_ids[i+3] == cohort) &&
				(current_ids[i+4] == source))
			{
				flag = true;
			}
		}
		if (!flag) {
			current_ids.push([id,platform,datatype,cohort,source]);
			sessionStorage.setItem("transfer", current_ids);
			t.row.add(["",id, platform, datatype, cohort, source]).draw(false);
		}
	}
}

// function to open window with IDs to transfer
function show_transfer_buffer_window(parent_tab) {
	if (document.getElementById("transfer_window") == null) {
		var transfer_window = '<div id="transfer_window"> \
			<table id="transfer_buffer_table" style="text-align:center"> \
				<thead> \
					<th></th>\
					<th>ID</th> \
					<th>Platform</th> \
					<th>Data type</th> \
					<th>Cohort</th> \
					<th>Source</th> \
				</thead> \
			</table></div>';
		$(parent_tab).append(transfer_window);
		$("#transfer_window").dialog({
			title: "IDs to transfer",
			buttons: [
				{
					text: "Copy chosen IDs to predictor 1",
					icon: "ui-icon-arrowreturnthick-1-n",
					id: "transfer_copy_ids",
					disabled: parent_tab == "#tab-signif",
					click: function() {copy_ids_to_predictor(1);}
				},
				{
					text: "Copy all IDs to predictor 1",
					icon: "ui-icon-arrowreturnthick-1-n",
					id: "transfer_copy_all_ids",
					disabled: parent_tab == "#tab-signif",
					click: function() {copy_all_ids_to_predictor(1);}
				},
				{
					text: (parent_tab == "#tab-signif") ? "To model creation" : "Find significant correlates",
					icon: "ui-icon-transferthick-e-w",
					id: "transfer_switch_tab",
					click: function() {$("#tabs").tabs("option", "active", (parent_tab == "#tab-signif") ? 3 : 1);},
				},
				{
					text: "Clear clipboard",
					icon: "ui-icon-minus",
					click: function() {sessionStorage.removeItem("transfer"); $('#transfer_buffer_table').DataTable().clear().draw();}
				}
			],
			height: 'auto',
			width: 'auto',
			modal: false,
			position: { my: "right", at: "top", of: window }, 
			beforeClose: function( event, ui ) {$(this).dialog('destroy').remove()}
		});
		var t = $('#transfer_buffer_table').DataTable({
				"columnDefs": [
					{
						"data": null,
						"defaultContent": '<input type="checkbox">',
						"targets": 0
					}
				],
				"pageLength": 15
			});
		var current_ids = sessionStorage.getItem("transfer");
		if (current_ids != null) {
			current_ids = current_ids.split(",");
			for (i = 0; i < current_ids.length - 1; i = i + 5) {
				t.row.add(["",current_ids[i], current_ids[i+1], current_ids[i+2], current_ids[i+3], current_ids[i+4]]).draw(false);
			}
		}
	}
}

function copy_ids_to_predictor(position) {
	var t = $('#transfer_buffer_table').DataTable();
	var ids = [];
	t.rows().every( function (index, element) {
		var row = $(this.node());
		var statusElement = row.children()[0].children[0];
		var isChecked = statusElement.checked;
		if(isChecked) {
			// un-check ID
			statusElement.click();
			ids.push($(row.children()[1]).text());
		}
	});
	console.log("IDs to transfer: " + ids);
	if ($("#genes_area" + position).val().length == 0) {
		$("#genes_area" + position).val(ids);
	}
	else {
		$("#genes_area" + position).val($("#genes_area" + position).val() + ',' + ids);
	}
}

function copy_all_ids_to_predictor(position) {
	var t = $('#transfer_buffer_table').DataTable();
	var ids = [];
	t.rows().every( function (index, element) {
		var row = $(this.node());
		if (!ids.includes($(row.children()[1]).text())) {
			ids.push($(row.children()[1]).text());
		}
	});
	console.log("IDs to transfer: " + ids);
	if ($("#genes_area" + position).val().length == 0) {
		$("#genes_area" + position).val(ids);
	}
	else {
		$("#genes_area" + position).val($("#genes_area" + position).val() + ',' + ids);
	}
}

function add_model_to_comparison(model) {
	var models = sessionStorage.getItem('models');
	if (models != null) {
		models = models.split(',');
		models.push(model);
	}
	else {
		models = model;
	}
	// JS turns array in comma-separated string
	sessionStorage.setItem('models', models);
}

function remove_model_from_comparison(model) {
	var models = sessionStorage.getItem('models').split(',');
	var model_index = models.indexOf(model);
	if (model_index != -1) {
		models.splice(model_index);
	}
	sessionStorage.setItem('models', models);
}

function show_compare_window() {
	if (document.getElementById("model_compare_preview_window") == null) {
		var compare_preview_window = '<div id="model_compare_preview_window"> \
			<table id="models_to_compare_table" style="text-align:center"> \
				<thead> \
					<th>Model name</th>\
					<th></th> \
					<th></th> \
					<th>Remove from comparison</th> \
				</thead> \
			</table></div>';
		$("#tab-predict").append(compare_preview_window);
		$("#model_compare_preview_window").dialog({
			title: "Models to compare",
			buttons: [
				{
					text: "Compare models",
					icon: "ui-icon-arrowreturnthick-1-n",
					id: "compare_models_button",
					click: function() {compare_models()}
				}
			],
			height: 'auto',
			width: 'auto',
			modal: false,
			position: { my: "right", at: "top", of: window }, 
			beforeClose: function( event, ui ) {$(this).dialog('destroy').remove()}
		});
		var t = $('#models_to_compare_table').DataTable();
		var models = sessionStorage.getItem('models').split(',');
		for (var i in models) {
			t.row.add(
				[
					models[i],
					'<button onclick="window.location.href = \'https://\' + window.location.hostname + \'/pics/plots/' + models[i] + '.RData\';">Download model</button>',
					'<button onclick="window.open(\'https://\' + window.location.hostname + \'/model_json.html#coeff.' + models[i] + '.json\', \'_blank\')">View coefficients</button>',
					'<button onclick="table.row($(this).parents(\'tr\')).remove().draw(); remove_model_from_comparison(\'' + models[i] + '\');">Remove</button>'
				]
			).draw(false);
		}
	}
}

function compare_models() {
	// function will not work if there are no models to compare
	if ($("models_to_compare_table tr").length == 0) {
		alert("No models for comparisson!");
	}
	else {
		// function works only when comparisson preview window is open and no other comparison windows are open
		if ((document.getElementById("model_compare_preview_window") != null) & (document.getElementById("model_compare_window") == null)) {
			// Pay attention! Table head is generated dynamically later
			var compare_window = '<div id="model_compare_window"> \
				<table id="model_comparison_table" style="text-align:center"> \
				</table></div>';
			$("#tab-predict").append(compare_window);
			$("#model_compare_window").dialog({
				title: "Models comparison",
				height: 'auto',
				width: 'auto',
				modal: false,
				position: { my: "right", at: "top", of: window }, 
				beforeClose: function( event, ui ) {$(this).dialog('destroy').remove()}
			});
			// no need to turn them into array - comma-separated values are needed
			var models = sessionStorage.getItem('models');
			var token = Date.now();
			var xmlhttp = new XMLHttpRequest();
			xmlhttp.open("GET", "cgi/compare_models.cgi?models=" + encodeURIComponent(models) + "&filename=" + encodeURIComponent(token), false);
			xmlhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						// get the columns in table
						columns_request = new XMLHttpRequest();
						columns_request.open("GET", "https://" + window.location.hostname + "/pics/plots/" + token + ".table", false);
						columns_request.send();
						columns = columns_request.responseText;
						console.log(columns);
						document.getElementById('model_comparison_table').innerHTML = columns;
						$('#model_comparison_table').DataTable( {
							"ajax": "https://" + window.location.hostname + "/pics/plots/" + token + "_short.json"
						} );
					}
			}
		xmlhttp.send();
		}
	}
}

function id_keyup(k) {
	if (synonyms.size == 0) {
		console.log("Waiting for synonyms...");
		setTimeout(id_keyup, 50, k);
	}
	else {
		console.log("Synonyms arrived");
		var n = $('#plot_options tr').length-1;
		//console.log("Number of rows: " + n + " id_keyup triggered for row: " + k);
		$("#id" + k + "_confirmed").val("");
		var flag = true;
		var temp_flag;
		if (!$("#id" + k + "_input").is(":hidden")) {
			var available_ids = $( "#id" + k + "_input" ).autocomplete("option", "source");
			var valueSoFar = $("#id" + k + "_input").val();
			if (capitalized_datatypes.includes($("#type" + k + "_selector option:selected").val())) {
				valueSoFar = valueSoFar.toUpperCase();
				$("#id" + k + "_input").val(valueSoFar);
			}
			temp_flag = available_ids.includes(valueSoFar);
			if ((temp_flag) && (valueSoFar != "")) {
				console.log("Value so far: " + valueSoFar);
				var confirmed = synonyms.get($("#id" + k + "_input").val())[0];
				console.log("Confirmed: " + confirmed);
				var url = synonyms.get($("#id" + k + "_input").val())[1];
				var resource_name = get_resource_name(url);
				$("#id" + k + "_confirmed").val(capitalized_datatypes.includes($("#type" + k + "_selector option:selected").val()) ? confirmed.toUpperCase() : confirmed);
				setTimeout(function(){$("#id" + k + "_input").css('border-color', '');
								$("#id" + k + "_input").css('background-color', '')}, 500);
				$("#id" + k + "_input").css('border-color', 'chartreuse');
				$("#id" + k + "_input").css('background-color', 'chartreuse');
				$("#open_info" + k).qtip({ 
					content: {
						text: "Open external information page (" + resource_name + ")" 
					}
				});
			}
		}
		if ((typeof $("#plot-type option:selected").val() == 'undefined') || ($("#plot-type option:selected").val() == "")) {
			flag = false;
		}
		else {
			for (var i = 1; i<=n; i++) {
				if (!document.getElementById("id" + i + "_input").hidden ) {
					var valueSoFar = $("#id" + i + "_input").val();
					// this variable declared in druggable_config.js
					if (capitalized_datatypes.includes($("#type" + i + "_selector option:selected").val())) {
						valueSoFar = valueSoFar.toUpperCase();
						$("#id" + i + "_input").val(valueSoFar);
					}
					available_ids = $( "#id" + i + "_input" ).autocomplete("option", "source");
					temp_flag = available_ids.includes(valueSoFar);
					if (temp_flag) {
						$("#open_info" + i).button("enable");
					}
					else {
						$("#open_info" + i).button("disable");
					}
					flag = flag*temp_flag;
				}
				else {
					flag = flag*true;
					$("#open_info" + i).button("disable");
				}
			}
		}
		if (flag) {
			$("#plot-button").button("enable");
			$("#plot-button-wrapper").qtip("disable");
		}
		else {
			$("#plot-button").button("disable");
			$("#plot-button-wrapper").qtip("enable");
		}
		return flag;
	}
}

function cor_id_keyup() {
	var flag = true;
	var valueSoFar = $("#corGeneFeature_input").val();
	var available_ids = $( "#corGeneFeature_input" ).autocomplete("option", "source");
	flag = flag*(available_ids.includes(valueSoFar))*(valueSoFar!='');
	var fdr = $("#FDR_input").val();
	flag = flag * (fdr >= 0.001) * (fdr<1);
	if (flag) {
		$("#retrieve-cor-button").button("enable");
	}
	else {
		$("#retrieve-cor-button").button("disable");
	}
}

// enables/disables type and platform selectors during update
// flag is "enable"/"disable"
function toggle_selectors(flag) {
	var n = $('#plot_options tr').length-1;
	for (var i = 1; i<=n; i++) {
		$('#type' + i + '_selector').selectmenu(flag);
		$('#platform' + i + '_selector').selectmenu(flag);
	}
}

function generate_plot_data(metadata) {
	var type = metadata["plot_type"];
	var cohort = metadata["cohort"];
	var datatypes = metadata["datatypes"];
	var platforms = metadata["platforms"];
	var ids = metadata["ids"];
	var scales = metadata["scales"];
	var n = metadata["n"];
	var datestring = metadata["timestamp"];
	var scales_order = ["x", "y", "z"];
	var code = metadata["code"];
	var data = [];
	var meta = [];	
	var text = [];	
	var title = [];	
	for (var i = 0; i<=2; i++) {
		if (Object.keys(datatypes).length > i) {
			title[i] = ids[scales_order[i]];
			meta[i] = [
				ids[scales_order[i]] == "" ? 'Sample values' : "ID: " + ids[scales_order[i]], 
				"Data: " + datatype_names.get(datatypes[scales_order[i]]), 
				"Platform: " + platform_names.get(platforms[scales_order[i]]), 
				"Scale: " + scale_names.get(scales[scales_order[i]])
			].join('\n');
			text[i] = (ids[scales_order[i]] == "") ? platform_names.get(platforms[scales_order[i]]) : ids[scales_order[i]];
		}
		else {
			title[i] = "";
			meta[i] = ["undefined"];
		}
	}
	data["title"] = cohort + ': ' + title.join(' vs. ');	
	data["meta"] = '<tr>' + '<td>' + type + '</td><td>' + cohort + '</td><td>' + code + '</td><td>' + n + '</td>';
	for (var j = 0; j<=2; j++) {
		data["meta"] = data["meta"] + (meta[j][0] == "undefined" ? ('<td></td>') : ('<td title=\'' + meta[j] + '\'>' + text[j] + '</td>')); //
	}
	data["meta"] = data["meta"] + '<td>' + datestring + '</td>' + '</tr>'; 
	return data;
}

// function for technical purposes - use this to safely clear the sessionStorage, affects only SOME druggable.evinet values
function safe_clear() {
	sessionStorage.removeItem("add_row");
	sessionStorage.removeItem("updates_triggered");
	sessionStorage.removeItem("cascade_delete");
	sessionStorage.removeItem("update_autocomplete");
	sessionStorage.removeItem("demo");
}

// function provided by https://stackoverflow.com/questions/469357/html-text-input-allow-only-numeric-input
function setInputFilter(textbox, inputFilter) {
  ["input", "keydown", "keyup", "mousedown", "mouseup", "select", "contextmenu", "drop"].forEach(function(event) {
    textbox.addEventListener(event, function() {
      if (inputFilter(this.value)) {
        this.oldValue = this.value;
        this.oldSelectionStart = this.selectionStart;
        this.oldSelectionEnd = this.selectionEnd;
      } else if (this.hasOwnProperty("oldValue")) {
        this.value = this.oldValue;
        this.setSelectionRange(this.oldSelectionStart, this.oldSelectionEnd);
      }
    });
  });
}

// functions for textarea autocomplete
function split( val ) {
	//return val.split( /,\s*/ );
	return val.split(ids_delim);
}

function extractLast( term ) {
	return split( term ).pop();
}

// function to check if we already have datatype in selected variables
function check_model_unique_variable(n) {
	var flag = false;
	var total = $('#model_options td').length/3;
	for (var i=1; i<=total; i++) {
		if (i!=n) {
			flag = flag + ($('#modelDatatype' + i + '_selector option:selected').val() == $('#modelDatatype' + n + '_selector option:selected').val());
		}
	}
	if (flag) {
		//alert("Model does not allow choosing same datatype as two different variables. Please chose another datatype");
	}
}

// this functions check if all model parameters are specified, returns either 'ok' or error message 
function check_model_input() {
	var message = "";
	var variable_count = 0;
	
	var n = $('[id*="modelPlatform"][id$="selector"]').length;
	for (var i=1; i<=n; i++) {
		if (!document.getElementById("genes_area" + i).disabled) {
			var temp = $("#genes_area" + i).val();
			temp = temp.replace(/\s/g, '');
			temp = temp.split(ids_delim);
			for (var j=0; j<temp.length; j++) { 
				if (temp[j] == "") {
					temp.splice(j, 1); 
				}
			}
			if (temp.length == 0) {
				message = message + "\nEmpty IDs for variable " + j;
			}
			variable_count = variable_count + 1;
		}
		else {
			variable_count = variable_count + 1;
		}
	}
	var multiopt = $("#responseMulti_selector").val();
	if (multiopt.length == 0) {
		message = message + "\nAt least one values for multiselector should be selected";
	}
	if (!document.getElementById("responseID_input").disabled) {
		if ($("#responseID_input").val().length == 0) {
			message = message + "\nID for response variable not specified"
		}
	}
	
	if (message == "") {
		message = "ok";
	} 
	return message;
}

// debug functions to report state
function report_plot_tab() {
	var plot = $('#plot-type option:selected').val();
	var n = $('#plot_options tr').length-1;
	var source = $("#source_selector option:selected").val();
	var cohort = $("#cohort_selector option:selected").val();
	var datatypes = [];
	var ids = [];
	var confirmed = [];
	var platforms = [];
	var scales = [];
	var tcga_codes = $("#tcga_selector option:selected").val();
	for (i=1; i<=n; i++) {
		datatypes.push($("#type" + i + "_selector option:selected").val());
		platforms.push($("#platform" + i + "_selector option:selected").val());
		ids.push($("#id" + i + "_input").val());
		confirmed.push($("#id" + i + "_confirmed").val());
		scales.push($("#axis" + i + "_selector option:selected").val());
	}
	var ErrorStack = check_error_stack(new Error().stack);
	var stat = report_event(((window.location.host.split(".")[0] == "dev") ? ("dev/") : "") + "druggable.html", "info", "reported_state_plot_tab", 
		"source=" + source + 
		"&cohort=" + cohort + 
		"&datatypes=" + datatypes.join() + 
		"&platforms=" + platforms.join() +
		"&ids=" + ids.join() +
		"&confirmed=" + confirmed.join() + 
		"&scales=" + scales.join() +
		"&tcga_codes=" + tcga_codes +
		"&plot=" + plot,
		"Stack: " + ErrorStack);	
	return stat;
}

function report_cor_tab() {
	var source = $("#corSource_selector option:selected").val();
	var datatype = $("#corDatatype_selector option:selected").val();
	var cohort = $("#corCohort_selector option:selected").val();
	var platform = $("#corPlatform_selector option:selected").val();
	var screen = $("#corScreen_selector option:selected").val();
	var id = $("#corGeneFeature_input").val();
	var fdr = $("#FDR_input").val();
	var ErrorStack = check_error_stack(new Error().stack);
	var stat = report_event(((window.location.host.split(".")[0] == "dev") ? ("dev/") : "") + "druggable.html", "info", "reported_state_cor_tab", 
		"source=" + source + 
		"&datatype=" + datatype + 
		"&cohort=" + cohort + 
		"&platform=" + platform +
		"&screen=" + screen +
		"&id=" + id +
		"&fdr=" + fdr,
		"Stack: " + ErrorStack);
	return stat;		
}

function report_model_tab() {
	var source = $("#modelSource_selector option:selected").val();
	var cohort = $("#modelCohort_selector option:selected").val();
	var multiopt = $("#responseMulti_selector").val();
		
	// independent variables
	var x_datatypes = [];
	var x_platforms = [];
	var x_ids = [];
	var n = $('[id*="modelPlatform"][id$="selector"]').length;
	var ids = [];
	for (var i=1; i<=n; i++) {
		x_datatypes.push($("#modelDatatype" + n + "_selector option:selected").val());
		x_platforms.push($("#modelPlatform" + n + "_selector option:selected").val());
		var temp = $("#genes_area" + n).val();
		x_ids.push(temp);
	}
	for (var i=0; i<ids.length; i++) {
		x_ids.push("[" + ids[i].join() + "]");
	}
		
	// model options
	var method = "glmnet";
	var standardize = $("#standardize:checked").val();
	var alpha = $("#alpha").val();
	var nlambda = $("#nlambda").val();
	var minlambda = $("#minlambda").val();
	var family = $("#family option:selected").val();
	var measure = "deviance";
	switch (family) {
		case "gaussian":
			measure = "mse";
			break;
	}
	var crossvalidation = $("#crossval:checked").val();
	var nfold = $("#nfold").val();
	var crossvalidation_percent = $("#crossval_perc").val();
	
	var ErrorStack = check_error_stack(new Error().stack);
	var stat = report_event(((window.location.host.split(".")[0] == "dev") ? ("dev/") : "") + "druggable.html", "info", "reported_state_model_tab", 
		"source=" + source + 
		"&cohort=" + cohort + 
		"&x_datatypes=" + x_datatypes.join() + 
		"&x_platforms=" + x_platforms.join() +
		"&x_ids=" + x_ids.join() +
		"&multiopt=" + multiopt.join() + 
		"&method=" + method +
		"&standardize=" + standardize +
		"&alpha=" + alpha +
		"&nlambda=" + nlambda +
		"&minlambda=" + minlambda +
		"&family=" + family +
		"&measure=" + measure +
		"&crossvalidation=" + crossvalidation +
		"&nfold=" + nfold +
		"&crossvalidation_percent=" + crossvalidation_percent,
		"Stack: " + ErrorStack);
	return stat;
}

</script>

 
<!--script src="js/Cytoscape.js/cytoscape.min.js" type="text/javascript"></script-->  
<!--script src="js/cytoscape.js-cxtmenu-master/cytoscape-cxtmenu.js" type="text/javascript"></script-->
<!--script src="js/cytoscape.js-cxtmenu-master/cytoscape-cxtmenu.js" type="text/javascript"></script-->
<!--script src="js/Cytoscape.js/cytoscape-cytoscape.js-panzoom-c1dbe79/cytoscape.js-panzoom.js" type="text/javascript"></script-->
<script src="//cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js" type="text/javascript"></script>
<script src="//cdn.datatables.net/buttons/1.5.6/js/dataTables.buttons.min.js" type="text/javascript"></script>
<script src="//cdn.datatables.net/buttons/1.5.6/js/buttons.html5.min.js" type="text/javascript"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js" type="text/javascript"></script>
<script src="//cdn.datatables.net/tabletools/2.2.3/js/dataTables.tableTools.js" type="text/javascript"></script>
<script src="//cdn.datatables.net/responsive/1.0.4/js/dataTables.responsive.js" type="text/javascript"></script>
<script src="//cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js" type="text/javascript"></script>


<!--script src="js/Cytoscape.js/cytoscape.js-qtip-master/jquery.cytoscape.js-qtip.js" type="text/javascript"></script-->
<!--script src="js/Cytoscape.js/cytoscape.js-edgehandles.js" type="text/javascript"></script-->

</BODY>
</HTML>