
# install.packages("threejs", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("igraph", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("pkgconfig", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("crosstalk", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")

# install.packages("scales", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("ggplot2", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org", dependencies = T)
# install.packages("Rcpp", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("htmlwidgets", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("plotly", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("heatmaply", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("RColorBrewer", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("lazyeval", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("tibble", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("pillar", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("R6", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("dplyr", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("assertthat", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("bindrcpp", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("bindr", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("glue", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("tidyselect", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("purrr", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("tidyr", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("viridisLite", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("viridis", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("gridExtra", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("dendextend", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("fpc", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("mclust", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("flexmix", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("modeltools", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("lme4", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("prabclus", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("diptest", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("mvtnorm", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("DEoptimR", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("trimcluster", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("kernlab", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("webshot", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("seriation", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("TSP", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("foreach", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("iterators", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("registry", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")
# install.packages("gclus", lib="/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/lib/", repos="http://cran.us.r-project.org")

usedDir = '/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/users_tmp/';
apacheSink = 'apache';
localSink = 'log'; # usedSink = apacheSink;
usedSink = localSink;
sink(file(paste(usedDir, "runExploratory.", usedSink, ".output.Rout", sep=""), open = "wt"), append = F, type = "output")
sink(file(paste(usedDir, "runExploratory.", usedSink, ".message.Rout", sep=""), open = "wt"), append = F, type = "message")
options(warn = 1); # options(warn = 0);
# message("TEST1");

Debug = 1;

source("/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/HyperSet/R/HS.R.config.r");
setwd(r.plots)

readin <- function (file, format="TAB") {
if (format=="TAB") {
t0 <- read.table(file, row.names = 1, header = TRUE, sep = "\t", quote = "", dec = ".", skip = 0, na.strings="NA");
}
t1 <- matrix(as.numeric(unlist(t0)), byrow = F, ncol=ncol(t0), nrow=nrow(t0), dimnames=list(rownames(t0), colnames(t0)));
return(t1);
}

pca  <- function (tbl, na.action="zero", out) {
library("pkgconfig")
library("igraph")
library("crosstalk")
library("threejs")

if (na.action=="zero") {tbl[which(is.na(tbl))] = 0;}
p1 <- princomp(tbl);
x <- p1$loadings[,1];
y <- p1$loadings[,2];
z <- p1$loadings[,3];
w <- p1$loadings[,4];
length.rnb = 10;
Rnb = rainbow(length.rnb + 1);
Min = min(w, na.rm=T);
Max = max(w, na.rm=T);
names(Rnb) <- as.character(0:length.rnb);
Col = Rnb[as.character(round(10*(w-Min)/(Max - Min)))];
names(Col) <- NULL;
htmlwidgets::saveWidget(scatterplot3js(x,y,z, color=Col, brush=TRUE), out, selfcontained=F, libdir = "3js_dependencies")
# return(NULL);
}

hmap  <- function (tbl, na.action="zero", out) {
# library(ggplot2)
library(heatmaply)
# library(htmlwidgets)
# library(RColorBrewer)

heatmaply(as.matrix(tbl), k_col = 1, k_row = 1, xaxis_font_size=0.05, yaxis_font_size=0.10, scale="none", margins=c(80,80)) %>% saveWidget(file=out,selfcontained = F, libdir="heatmaply_dependencies");
}

Args <- commandArgs(trailingOnly = T);
paramNames <- c("table", "out");
Param <- vector("list", length(paramNames));
names(Param) <- paramNames;
for (aa in Args) {
s1 <- strsplit(aa, split=RscriptKeyValueDelimiter);
if (length(s1[[1]]) > 1) {
s2 <- strsplit(s1[[1]][[2]], split=RscriptParameterDelimiter);
for (ss in s2[[1]]) {
if (ss != "") {
Param[[s1[[1]][1]]] <- c(Param[[ s1[[1]][1] ]], ss);
}}}}
if (Debug>0) {print(Param);}
tmpdir = '/opt/rh/httpd24/root/var/www/html/research/andrej_alexeyenko/users_tmp/';
filename = Param$table;

tbl=readin(file=paste0(tmpdir, filename), format="TAB");
if (Param$mode == "pca") {
st <- system.time(res <- pca(tbl, na.action="zero", out=Param$out));
}
if (Param$mode == "hea") {
st <- system.time(res <- hmap(tbl, na.action="zero", out=Param$out));
}

if (Debug>0) {print(st);}
# z <- seq(-2, 5, 0.01)
# x <- runif(length(z)); #cos(0.5*z)
# y <- sin(z) 





